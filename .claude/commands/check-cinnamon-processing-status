#!/bin/bash

# check-cinnamon-processing-status - å‡¦ç†çŠ¶æ…‹ã®è©³ç´°åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

set -e

echo "ğŸ”„ PROCESSING STATUS DETAILED ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æœ€æ–°ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’åˆ†æ
accounts=("book000" "ihc_amot" "book000_vrc" "authorizedkey" "tomachi_priv" "tomarabbit")

for account in "${accounts[@]}"; do
    container="bulk-block-users-${account}-1"
    echo ""
    echo "ğŸ“‹ $account ã®æœ€æ–°çŠ¶æ…‹:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # æœ€æ–°ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ5ä»¶ï¼‰
    echo "ğŸš¨ æœ€æ–°ã‚¨ãƒ©ãƒ¼:"
    ssh Cinnamon "docker logs $container --tail 100 2>&1 | grep -E '(ERROR|403|failed|exception)' | tail -5" || echo "  ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—"
    
    # æœ€å¾Œã®æˆåŠŸå‡¦ç†
    echo ""
    echo "âœ… æœ€å¾Œã®æˆåŠŸå‡¦ç†:"
    ssh Cinnamon "docker logs $container --tail 1000 2>&1 | grep -E '(success|blocked|completed)' | tail -1" || echo "  æˆåŠŸãƒ­ã‚°ãªã—"
    
    # Cookieé–¢é€£ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    echo ""
    echo "ğŸª CookieçŠ¶æ…‹:"
    ssh Cinnamon "docker logs $container --tail 100 2>&1 | grep -i cookie | tail -3" || echo "  Cookieé–¢é€£ãƒ­ã‚°ãªã—"
    
    echo ""
done

# å…¨ä½“çš„ãªå‡¦ç†çµ±è¨ˆ
echo ""
echo "ğŸ“Š OVERALL PROCESSING STATISTICS (Last 1 hour)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

total_attempts=0
total_successes=0
total_403s=0

for account in "${accounts[@]}"; do
    container="bulk-block-users-${account}-1"
    attempts=$(ssh Cinnamon "docker logs $container --since='1h' 2>&1 | grep -c 'Processing'" || echo "0")
    successes=$(ssh Cinnamon "docker logs $container --since='1h' 2>&1 | grep -c 'success'" || echo "0")
    errors_403=$(ssh Cinnamon "docker logs $container --since='1h' 2>&1 | grep -c '403'" || echo "0")
    
    printf "%-15s: è©¦è¡Œ%3dä»¶, æˆåŠŸ%3dä»¶, 403ã‚¨ãƒ©ãƒ¼%3dä»¶\n" "$account" "$attempts" "$successes" "$errors_403"
    
    total_attempts=$((total_attempts + attempts))
    total_successes=$((total_successes + successes))
    total_403s=$((total_403s + errors_403))
done

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
printf "åˆè¨ˆ            : è©¦è¡Œ%3dä»¶, æˆåŠŸ%3dä»¶, 403ã‚¨ãƒ©ãƒ¼%3dä»¶\n" "$total_attempts" "$total_successes" "$total_403s"

# å‡¦ç†åœæ­¢ã®åˆ¤å®š
if [ "$total_attempts" -eq 0 ] || [ "$total_successes" -eq 0 ]; then
    echo ""
    echo "ğŸš¨ è­¦å‘Š: å‡¦ç†ãŒå®Œå…¨ã«åœæ­¢ã—ã¦ã„ã¾ã™ï¼"
    echo "  æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
    echo "  1. Cookieæ›´æ–°ã®å®Ÿè¡Œ"
    echo "  2. APIæ¥ç¶šæ€§ã®ç¢ºèª"
    echo "  3. ãƒ­ã‚°ã®è©³ç´°åˆ†æ"
fi