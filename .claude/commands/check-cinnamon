#!/bin/bash

# check-cinnamon - Cinnamonã‚µãƒ¼ãƒãƒ¼è»½é‡ç›£è¦–ã‚³ãƒãƒ³ãƒ‰ï¼ˆåˆ†å‰²ç‰ˆï¼‰
# å¾“æ¥ã®å·¨å¤§ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ2637è¡Œï¼‰ã‚’æ©Ÿèƒ½åˆ¥ã«åˆ†å‰²

set -e

echo "=== CINNAMON SERVER QUICK CHECK ==="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
DETAILED=false
ERRORS_ONLY=false
MODULES=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --detailed|-d)
            DETAILED=true
            shift
            ;;
        --errors-only|-e)
            ERRORS_ONLY=true
            shift
            ;;
        --module|-m)
            MODULES="$MODULES $2"
            shift 2
            ;;
        --help|-h)
            echo "ä½¿ç”¨æ–¹æ³•: check-cinnamon [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -d, --detailed     è©³ç´°åˆ†æå®Ÿè¡Œ"
            echo "  -e, --errors-only  403ã‚¨ãƒ©ãƒ¼åˆ†æã®ã¿"
            echo "  -m, --module NAME  ç‰¹å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿å®Ÿè¡Œ"
            echo "  -h, --help         ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«:"
            echo "  version      ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±"
            echo "  container    ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹"
            echo "  errors       403ã‚¨ãƒ©ãƒ¼åˆ†æ"
            echo "  completion      å®Œäº†ç‡åˆ†æ"
            echo "  health          é•·æœŸãƒ˜ãƒ«ã‚¹åˆ†æ"
            echo "  container-health ã‚³ãƒ³ãƒ†ãƒŠå¥åº·çŠ¶æ…‹ãƒ»å†èµ·å‹•æ¨å¥¨"
            echo "  rate-limit      ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆç›£è¦–ãƒ»å‡¦ç†äºˆæ¸¬"
            echo "  performance     ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ãƒ»å±¥æ­´æ¯”è¼ƒ"
            echo "  accounts        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥è©³ç´°åˆ†æãƒ»æœ€é©åŒ–ææ¡ˆ"
            echo "  processing      å‡¦ç†çŠ¶æ…‹è©³ç´°åˆ†æãƒ»CookieçŠ¶æ…‹ç¢ºèª"
            echo ""
            echo "ä¾‹:"
            echo "  check-cinnamon                    # åŸºæœ¬ãƒã‚§ãƒƒã‚¯"
            echo "  check-cinnamon --errors-only      # ã‚¨ãƒ©ãƒ¼ã®ã¿"
            echo "  check-cinnamon --module errors    # ã‚¨ãƒ©ãƒ¼åˆ†æã®ã¿"
            echo "  check-cinnamon --module performance # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ"
            echo "  check-cinnamon --module accounts   # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥åˆ†æ"
            echo "  check-cinnamon --detailed          # å…¨è©³ç´°åˆ†æ"
            exit 0
            ;;
        *)
            echo "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            echo "ä½¿ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã¯ check-cinnamon --help ã‚’å‚ç…§"
            exit 1
            ;;
    esac
done

# ã‚¨ãƒ©ãƒ¼ã®ã¿ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
if [ "$ERRORS_ONLY" = true ]; then
    exec .claude/commands/check-cinnamon-errors
fi

# ç‰¹å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿å®Ÿè¡Œ
if [ -n "$MODULES" ]; then
    for module in $MODULES; do
        case $module in
            version)
                .claude/commands/check-cinnamon-version
                ;;
            container)
                .claude/commands/check-cinnamon-containers
                ;;
            errors)
                .claude/commands/check-cinnamon-errors
                ;;
            completion)
                .claude/commands/check-cinnamon-completion
                ;;
            health)
                .claude/commands/check-cinnamon-health
                ;;
            container-health)
                .claude/commands/check-cinnamon-container-health
                ;;
            rate-limit)
                .claude/commands/check-cinnamon-rate-limit-monitor
                ;;
            performance)
                .claude/commands/check-cinnamon-performance
                ;;
            accounts)
                .claude/commands/check-cinnamon-account-analysis
                ;;
            processing)
                .claude/commands/check-cinnamon-processing-status
                ;;
            *)
                echo "âŒ ä¸æ˜ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: $module"
                ;;
        esac
        echo ""
    done
    exit 0
fi

# åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆè»½é‡ç‰ˆï¼‰
echo "ğŸ”¢ VERSION & CONTAINER STATUS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ï¼ˆç°¡æ½”ç‰ˆï¼‰
.claude/commands/check-cinnamon-version --brief

echo ""

# ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ï¼ˆç°¡æ½”ç‰ˆï¼‰
.claude/commands/check-cinnamon-containers --brief

echo ""

# 403ã‚¨ãƒ©ãƒ¼åˆ†æï¼ˆç°¡æ½”ç‰ˆï¼‰
echo "ğŸš¨ 403 ERROR ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
.claude/commands/check-cinnamon-errors --brief

echo ""

# è©³ç´°åˆ†æï¼ˆè©³ç´°ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
if [ "$DETAILED" = true ]; then
    echo "ğŸ“ˆ COMPLETION RATE ANALYSIS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    .claude/commands/check-cinnamon-completion
    echo ""
    
    echo "ğŸ“Š PERFORMANCE METRICS & TREND ANALYSIS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    .claude/commands/check-cinnamon-performance --compare
    echo ""
    
    echo "ğŸ‘¥ ACCOUNT-SPECIFIC OPTIMIZATION ANALYSIS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    .claude/commands/check-cinnamon-account-analysis
    echo ""
fi

# æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
echo "ğŸ’¡ RECOMMENDED ACTIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ç°¡å˜ãªæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆæ­£ç¢ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ï¼‰
TOTAL_ERRORS=$(ssh Cinnamon 'total=0; for container in bulk-block-users-book000-1 bulk-block-users-ihc_amot-1 bulk-block-users-book000_vrc-1 bulk-block-users-authorizedkey-1 bulk-block-users-tomachi_priv-1 bulk-block-users-tomarabbit-1; do count=$(docker logs $container --since="10m" 2>&1 | grep -E "(ğŸš¨.*403ã‚¨ãƒ©ãƒ¼.*å›æ¤œå‡º|403 Forbidden|HTTP/1.1 403)" | wc -l); total=$((total + count)); done; echo $total')

if [ "$TOTAL_ERRORS" -gt 50 ]; then
    echo "ğŸš¨ CRITICAL: é«˜é »åº¦403ã‚¨ãƒ©ãƒ¼ ($TOTAL_ERRORSä»¶/10åˆ†)"
    echo "  æ¨å¥¨: è©³ç´°åˆ†æã¨ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•æ¤œè¨"
    echo "  å®Ÿè¡Œ: check-cinnamon --detailed"
elif [ "$TOTAL_ERRORS" -gt 20 ]; then
    echo "âš ï¸ WARNING: ä¸­ç¨‹åº¦403ã‚¨ãƒ©ãƒ¼ ($TOTAL_ERRORSä»¶/10åˆ†)"
    echo "  æ¨å¥¨: ã‚¨ãƒ©ãƒ¼åˆ†æã¨ç›£è¦–å¼·åŒ–"
    echo "  å®Ÿè¡Œ: check-cinnamon --errors-only"
elif [ "$TOTAL_ERRORS" -gt 5 ]; then
    echo "ğŸ“Š MEDIUM: è»½å¾®ãª403ã‚¨ãƒ©ãƒ¼ ($TOTAL_ERRORSä»¶/10åˆ†)"
    echo "  æ¨å¥¨: ç¶™ç¶šç›£è¦–"
else
    echo "âœ… GOOD: ã‚¨ãƒ©ãƒ¼ç‡ä½ ($TOTAL_ERRORSä»¶/10åˆ†)"
    echo "  æ¨å¥¨: å®šæœŸç›£è¦–ç¶™ç¶š"
fi

echo ""
echo "ğŸ“Š è©³ç´°åˆ†æ: check-cinnamon --detailed"
echo "ğŸš¨ ã‚¨ãƒ©ãƒ¼ç‰¹åŒ–: check-cinnamon --errors-only"
echo "ğŸ”§ å€‹åˆ¥åˆ†æ: check-cinnamon --module errors"
echo "ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: check-cinnamon --module performance --compare"
echo "ğŸ‘¥ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ†æ: check-cinnamon --module accounts"
echo ""
echo "ğŸ•’ è»½é‡ç‰ˆå®Ÿè¡Œæ™‚é–“: $(date '+%H:%M:%S')"