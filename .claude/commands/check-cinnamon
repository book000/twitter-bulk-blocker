#!/bin/bash

# check-cinnamon - Cinnamonã‚µãƒ¼ãƒãƒ¼åŒ…æ‹¬ç›£è¦–ã‚³ãƒãƒ³ãƒ‰
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: .claude/commands/check-cinnamon.md

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹æ™‚åˆ»ã®è¨˜éŒ²ï¼ˆæ”¹å–„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
SCRIPT_START_TIME=$(date +%s)

echo "=== CINNAMON SERVER COMPREHENSIVE CHECK ==="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo

# 1. åŸºæœ¬ç›£è¦–é …ç›®ã®å®Ÿè¡Œ
echo "ğŸ“Š CONTAINER STATUS ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# SSHæ¥ç¶šæœ€é©åŒ–: 1å›ã®SSHæ¥ç¶šã§è¤‡æ•°ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
echo "ğŸ” Container Status (ç¨¼åƒä¸­/åœæ­¢ä¸­ã®è©³ç´°åˆ†æ):"

# æœ€é©åŒ–: 1å›ã®SSHæ¥ç¶šã§å…¨ã¦ã®åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
CONTAINER_DATA=$(ssh Cinnamon "
docker ps -a --filter 'name=bulk-block-users' --format 'table {{.Names}}\t{{.Status}}\t{{.State}}' > /tmp/container_status.txt
docker ps --filter 'name=bulk-block-users' --format '{{.Names}}' > /tmp/running_containers.txt
docker ps -a --filter 'name=bulk-block-users' --filter 'status=exited' --format '{{.Names}}' > /tmp/stopped_containers.txt
docker ps -a --filter 'name=bulk-block-users' --filter 'exited=1' --format '{{.Names}}' > /tmp/error_containers.txt
docker ps -a --filter 'name=bulk-block-users' --filter 'exited=0' --format '{{.Names}}' > /tmp/completed_containers.txt
cat /tmp/container_status.txt
echo '---RUNNING---'
cat /tmp/running_containers.txt
echo '---STOPPED---'
cat /tmp/stopped_containers.txt
echo '---ERROR---'
cat /tmp/error_containers.txt
echo '---COMPLETED---'
cat /tmp/completed_containers.txt
")

# SSHæ¥ç¶šçµæœã®è§£æ
CONTAINER_STATUS=$(echo "$CONTAINER_DATA" | sed '/---RUNNING---/q' | head -n -1)
RUNNING_CONTAINERS=$(echo "$CONTAINER_DATA" | sed -n '/---RUNNING---/,/---STOPPED---/p' | sed '1d;$d')
STOPPED_CONTAINERS=$(echo "$CONTAINER_DATA" | sed -n '/---STOPPED---/,/---ERROR---/p' | sed '1d;$d')
ERROR_CONTAINERS=$(echo "$CONTAINER_DATA" | sed -n '/---ERROR---/,/---COMPLETED---/p' | sed '1d;$d')
COMPLETED_CONTAINERS=$(echo "$CONTAINER_DATA" | sed -n '/---COMPLETED---/,$/p' | sed '1d')

echo "$CONTAINER_STATUS"
echo

echo "âœ… Running Containers:"
if [ -z "$RUNNING_CONTAINERS" ]; then
    echo "  - None"
else
    echo "$RUNNING_CONTAINERS" | sed 's/^/  - /'
fi

echo "ğŸ”´ Stopped Containers:"
if [ -z "$STOPPED_CONTAINERS" ]; then
    echo "  - None"
else
    echo "$STOPPED_CONTAINERS" | sed 's/^/  - /'
fi
echo

# 2. åœæ­¢ç†ç”±ã®è©³ç´°åˆ†æï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢åŸå› ã‚’å¾¹åº•èª¿æŸ»ï¼‰
echo "ğŸ” DETAILED CONTAINER STOP ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -n "$STOPPED_CONTAINERS" ]; then
    for container in $STOPPED_CONTAINERS; do
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "ğŸ“‹ Service: $SERVICE_NAME ($container)"
        
        # çµ‚äº†ã‚³ãƒ¼ãƒ‰ç¢ºèª
        EXIT_CODE=$(ssh Cinnamon "docker inspect $container --format '{{.State.ExitCode}}'")
        echo "  Exit Code: $EXIT_CODE"
        
        # åœæ­¢æ™‚åˆ»ã®å–å¾—
        STOP_TIME=$(ssh Cinnamon "docker inspect $container --format '{{.State.FinishedAt}}'" | cut -d'T' -f2 | cut -d'.' -f1)
        echo "  Stopped At: $STOP_TIME JST"
        
        # æœ€å¾Œã®20è¡Œã®ãƒ­ã‚°ã‹ã‚‰åœæ­¢ç†ç”±ã‚’è©³ç´°åˆ†æ
        echo "  ğŸ” Stop Reason Analysis:"
        FULL_LOGS=$(ssh Cinnamon "docker logs --tail 20 $container" 2>/dev/null)
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºï¼ˆæ‹¡å¼µç‰ˆï¼‰
        AUTH_ERROR=$(echo "$FULL_LOGS" | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication.*failed\|cookie.*ç„¡åŠ¹\|cookie.*invalid\|Could not authenticate you\|Invalid credentials" | tail -1)
        if [ -n "$AUTH_ERROR" ]; then
            echo "    â€¢ ğŸ”‘ èªè¨¼ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $AUTH_ERROR" | sed 's/^/        /'
        fi
        
        # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
        ACCOUNT_LOCK=$(echo "$FULL_LOGS" | grep -i "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯\|account.*lock\|suspended" | tail -1)
        if [ -n "$ACCOUNT_LOCK" ]; then
            echo "    â€¢ ğŸš« ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯æ¤œå‡º:"
            echo "      - $ACCOUNT_LOCK" | sed 's/^/        /'
        fi
        
        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
        RATE_LIMIT=$(echo "$FULL_LOGS" | grep -i "rate.*limit\|too many request\|429" | tail -1)
        if [ -n "$RATE_LIMIT" ]; then
            echo "    â€¢ â° ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $RATE_LIMIT" | sed 's/^/        /'
        fi
        
        # APIå¿œç­”ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
        API_ERROR=$(echo "$FULL_LOGS" | grep -E "Status Code: [45][0-9][0-9]|HTTP.*[45][0-9][0-9]" | tail -1)
        if [ -n "$API_ERROR" ]; then
            echo "    â€¢ ğŸŒ APIå¿œç­”ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $API_ERROR" | sed 's/^/        /'
        fi
        
        # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡º
        COMPLETION_MSG=$(echo "$FULL_LOGS" | grep -i "å‡¦ç†å®Œäº†\|å®Œäº†\|å…¨.*ãƒ¦ãƒ¼ã‚¶ãƒ¼.*å‡¦ç†" | tail -1)
        if [ -n "$COMPLETION_MSG" ]; then
            echo "    â€¢ âœ… æ­£å¸¸å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
            echo "      - $COMPLETION_MSG" | sed 's/^/        /'
        fi
        
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
        NETWORK_ERROR=$(echo "$FULL_LOGS" | grep -i "connection.*error\|network.*error\|timeout\|dns" | tail -1)
        if [ -n "$NETWORK_ERROR" ]; then
            echo "    â€¢ ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $NETWORK_ERROR" | sed 's/^/        /'
        fi
        
        # ãã®ä»–ã®é‡è¦ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        OTHER_ERROR=$(echo "$FULL_LOGS" | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | grep -v "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication" | tail -2)
        if [ -n "$OTHER_ERROR" ]; then
            echo "    â€¢ âš ï¸ ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼:"
            echo "$OTHER_ERROR" | sed 's/^/        - /'
        fi
        
        # åœæ­¢ç†ç”±ã®ç·åˆåˆ¤å®š
        echo "  ğŸ“Š Stop Reason Summary:"
        case $EXIT_CODE in
            0)
                if [ -n "$COMPLETION_MSG" ]; then
                    echo "    âœ… å‡¦ç†å®Œäº† - å…¨å‡¦ç†å¯¾è±¡ãŒå®Œäº†ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ + æŠ€è¡“çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ä¸å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰"
                else
                    echo "    âœ… æ­£å¸¸çµ‚äº† - å‡¦ç†å¯¾è±¡å®Œäº†"
                fi
                ;;
            1)
                STOP_REASONS=()
                [ -n "$AUTH_ERROR" ] && STOP_REASONS+=("èªè¨¼ã‚¨ãƒ©ãƒ¼")
                [ -n "$ACCOUNT_LOCK" ] && STOP_REASONS+=("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯")
                [ -n "$RATE_LIMIT" ] && STOP_REASONS+=("ãƒ¬ãƒ¼ãƒˆåˆ¶é™")
                [ -n "$API_ERROR" ] && STOP_REASONS+=("APIå¿œç­”ã‚¨ãƒ©ãƒ¼")
                [ -n "$NETWORK_ERROR" ] && STOP_REASONS+=("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼")
                
                if [ ${#STOP_REASONS[@]} -gt 0 ]; then
                    echo "    ğŸ”´ ã‚¨ãƒ©ãƒ¼çµ‚äº† - $(IFS=', '; echo "${STOP_REASONS[*]}")"
                else
                    echo "    ğŸ”´ ã‚¨ãƒ©ãƒ¼çµ‚äº† - ä¸æ˜ãªåŸå› ï¼ˆè¦è©³ç´°èª¿æŸ»ï¼‰"
                fi
                ;;
            *)
                echo "    âš ï¸ ç•°å¸¸çµ‚äº† - Exit Code $EXIT_CODEï¼ˆè¦èª¿æŸ»ï¼‰"
                ;;
        esac
        
        # å¯¾å¿œæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        echo "  ğŸ’¡ Recommended Actions:"
        if [ "$EXIT_CODE" = "0" ]; then
            echo "    âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦ - æ­£å¸¸å®Œäº†æ¸ˆã¿"
        else
            if [ -n "$AUTH_ERROR" ]; then
                echo "    ğŸ”‘ Cookieæ›´æ–°ãŒå¿…è¦"
            fi
            if [ -n "$ACCOUNT_LOCK" ]; then
                echo "    â³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯è§£é™¤ã‚’å¾…æ©Ÿ"
            fi
            if [ -n "$RATE_LIMIT" ]; then
                echo "    â° ãƒ¬ãƒ¼ãƒˆåˆ¶é™è§£é™¤å¾Œã«å†é–‹"
            fi
            if [ -n "$API_ERROR" ] || [ -n "$NETWORK_ERROR" ]; then
                echo "    ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªå¾Œã«å†èµ·å‹•"
            fi
            if [ -z "$AUTH_ERROR" ] && [ -z "$ACCOUNT_LOCK" ] && [ -z "$RATE_LIMIT" ] && [ -z "$API_ERROR" ] && [ -z "$NETWORK_ERROR" ]; then
                echo "    ğŸ” è©³ç´°ãƒ­ã‚°èª¿æŸ»ãŒå¿…è¦"
            fi
        fi
        
        echo
    done
else
    echo "  No stopped containers found"
fi

# 3. å®Ÿè³ªå®Œäº†ç‡ã®æ­£ç¢ºãªè¨ˆç®—ï¼ˆæ°¸ç¶šçš„å¤±æ•—ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦æ‰±ã†ï¼‰
echo "ğŸ“ˆ COMPLETION RATE ANALYSIS (æ°¸ç¶šçš„å¤±æ•—ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦æ‰±ã†)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å„ã‚µãƒ¼ãƒ“ã‚¹ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã—ã¦å®Ÿè³ªå®Œäº†ç‡ã‚’è¨ˆç®—
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "ğŸ“Š Service: $SERVICE_NAME"
        
        # å‡¦ç†çµ±è¨ˆã®æŠ½å‡º
        STATS=$(ssh Cinnamon "docker logs $container" | grep -A 10 "=== å‡¦ç†çµ±è¨ˆ ===" | tail -10)
        
        if [ -n "$STATS" ]; then
            echo "$STATS" | sed 's/^/  /'
            
            # å®Œäº†ç‡ã®è¨ˆç®—ã¨æ°¸ç¶šçš„å¤±æ•—ã®å‡¦ç†
            TOTAL=$(echo "$STATS" | grep "å…¨å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            BLOCKED=$(echo "$STATS" | grep "ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            REMAINING=$(echo "$STATS" | grep "æ®‹ã‚Šæœªå‡¦ç†" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            
            if [ -n "$TOTAL" ] && [ -n "$BLOCKED" ] && [ -n "$REMAINING" ]; then
                # æ°¸ç¶šçš„å¤±æ•—æ•°ã®æ¨å®šï¼ˆã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
                PERMANENT_FAILURES=$(ssh Cinnamon "docker logs $container" | grep "æ—¢çŸ¥ã®æ°¸ç¶šçš„å¤±æ•—\|suspended\|not_found\|deactivated" | wc -l)
                
                # å®Ÿè³ªçš„ãªå‡¦ç†æ¸ˆã¿æ•°ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ + æ°¸ç¶šçš„å¤±æ•—ï¼‰
                PROCESSED=$((BLOCKED + PERMANENT_FAILURES))
                
                # å®Ÿè³ªå®Œäº†ç‡ã®è¨ˆç®—ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                if [ "$PROCESSED" -ge "$TOTAL" ]; then
                    ACTUAL_COMPLETION_RATE="100.0"
                    EFFECTIVE_REMAINING=0
                elif [ "$TOTAL" -gt 0 ]; then
                    ACTUAL_COMPLETION_RATE=$(echo "scale=1; $PROCESSED * 100 / $TOTAL" | bc 2>/dev/null || echo "0.0")
                    EFFECTIVE_REMAINING=$((TOTAL - PROCESSED))
                    
                    # é«˜å®Œäº†ç‡ï¼ˆ90%ä»¥ä¸Šï¼‰ã®å ´åˆã¯å®Ÿè³ªå®Œäº†æ‰±ã„
                    COMPLETION_INT=$(echo "$ACTUAL_COMPLETION_RATE" | cut -d. -f1)
                    if [ "$COMPLETION_INT" -ge 90 ] && [ "$EFFECTIVE_REMAINING" -le 100 ]; then
                        echo "    - ğŸ¯ å®Ÿè³ªå®Œäº†æ‰±ã„: ${ACTUAL_COMPLETION_RATE}% (æ®‹ã‚Š${EFFECTIVE_REMAINING}äººã¯å¾®é‡)"
                    fi
                else
                    ACTUAL_COMPLETION_RATE="0.0"
                    EFFECTIVE_REMAINING=0
                fi
                
                echo "  ğŸ“Š Completion Analysis:"
                echo "    - å®Ÿè³ªå®Œäº†ç‡: ${ACTUAL_COMPLETION_RATE}% (å‡¦ç†æ¸ˆã¿: ${PROCESSED}/${TOTAL})"
                echo "    - ãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ: ${BLOCKED}äºº"
                if [ "$PERMANENT_FAILURES" -gt 0 ]; then
                    echo "    - æ°¸ç¶šçš„å¤±æ•—: ${PERMANENT_FAILURES}äºº (suspended/not_found/deactivated)"
                fi
                echo "    - å®Ÿè³ªæœªå‡¦ç†: ${EFFECTIVE_REMAINING}äºº"
                
                # å®Œäº†çŠ¶æ³ã®åˆ¤å®š
                if [ "$ACTUAL_COMPLETION_RATE" = "100.0" ]; then
                    echo "    - ğŸ‰ å‡¦ç†çŠ¶æ³: å®Œå…¨å®Œäº†ï¼ˆ100%ï¼‰"
                    echo "    - ğŸ“‹ èª¬æ˜: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‡¦ç†æ¸ˆã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ + æŠ€è¡“çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ä¸å¯èƒ½ï¼‰"
                elif [ "$EFFECTIVE_REMAINING" -gt 0 ]; then
                    echo "    - ğŸ”„ å‡¦ç†çŠ¶æ³: ç¶™ç¶šä¸­ (${EFFECTIVE_REMAINING}äººãŒæœªå‡¦ç†)"
                fi
            fi
        else
            echo "  âš ï¸ No statistics available"
        fi
        echo
    fi
done

# 4. èªè¨¼çŠ¶æ…‹ã®è©³ç´°ç¢ºèªï¼ˆé•·æœŸå±¥æ­´å¯¾å¿œï¼‰
echo "ğŸ” AUTHENTICATION STATUS (é•·æœŸã‚¨ãƒ©ãƒ¼å±¥æ­´åˆ†æ)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# è¤‡æ•°æ™‚é–“ç¯„å›²ã§ã®èªè¨¼ã‚¨ãƒ©ãƒ¼åˆ†æ
echo "ğŸ“Š Authentication Error Timeline:"

# æœ€è¿‘5åˆ†é–“
AUTH_ERRORS_5M=$(ssh Cinnamon "docker logs --since '5m' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘5åˆ†é–“: $AUTH_ERRORS_5M ä»¶"

# æœ€è¿‘1æ™‚é–“
AUTH_ERRORS_1H=$(ssh Cinnamon "docker logs --since '1h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘1æ™‚é–“: $AUTH_ERRORS_1H ä»¶"

# æœ€è¿‘6æ™‚é–“
AUTH_ERRORS_6H=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘6æ™‚é–“: $AUTH_ERRORS_6H ä»¶"

# æœ€è¿‘24æ™‚é–“
AUTH_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘24æ™‚é–“: $AUTH_ERRORS_24H ä»¶"

# ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰åŒ–ã‚’åˆ†æ
if [ "$AUTH_ERRORS_24H" -gt 0 ]; then
    echo "ğŸ” Long-term Authentication Error Analysis:"
    
    # ã‚¨ãƒ©ãƒ¼é »åº¦ã®å‚¾å‘åˆ†æ
    if [ "$AUTH_ERRORS_5M" -gt 0 ]; then
        echo "    âš ï¸ ç¾åœ¨é€²è¡Œä¸­ã®èªè¨¼å•é¡Œï¼ˆ5åˆ†ä»¥å†…ã«ç™ºç”Ÿï¼‰"
    elif [ "$AUTH_ERRORS_1H" -gt 0 ]; then
        echo "    âš ï¸ æœ€è¿‘ã®èªè¨¼å•é¡Œï¼ˆ1æ™‚é–“ä»¥å†…ï¼‰"
    elif [ "$AUTH_ERRORS_6H" -gt 0 ]; then
        echo "    â„¹ï¸ éå»ã®èªè¨¼å•é¡Œï¼ˆ6æ™‚é–“ä»¥å†…ã€ç¾åœ¨ã¯å®‰å®šï¼‰"
    else
        echo "    â„¹ï¸ å¤ã„èªè¨¼å•é¡Œï¼ˆ24æ™‚é–“ä»¥å†…ã€ç¾åœ¨ã¯å®‰å®šï¼‰"
    fi
    
    # æœ€è¿‘ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ï¼ˆã‚ˆã‚Šè©³ç´°ï¼‰
    echo "  ğŸ“‹ Recent Authentication Errors (æœ€æ–°5ä»¶):"
    ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | \
        tail -5 | \
        while IFS= read -r line; do
            echo "    - $line"
        done
        
    # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥èªè¨¼ã‚¨ãƒ©ãƒ¼åˆ†æ
    echo "  ğŸ·ï¸ Authentication Errors by Service:"
    for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
        if [ -n "$container" ]; then
            SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
            SERVICE_AUTH_ERRORS=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
            if [ "$SERVICE_AUTH_ERRORS" -gt 0 ]; then
                echo "    - $SERVICE_NAME: $SERVICE_AUTH_ERRORS ä»¶ï¼ˆ24æ™‚é–“ï¼‰"
            fi
        fi
    done
else
    echo "âœ… No authentication errors in last 24 hours"
fi

# ç¾åœ¨ã®èªè¨¼å•é¡Œã®é‡è¦åº¦åˆ¤å®š
AUTH_ERRORS=$AUTH_ERRORS_5M  # å¾Œç¶šå‡¦ç†ã¨ã®äº’æ›æ€§ç¶­æŒ
echo

# 5. å³åº§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æç¤ºï¼ˆå¯¾å¿œãŒå¿…è¦ãªå•é¡Œã®æ˜ç¢ºåŒ–ï¼‰
echo "ğŸ’¡ RECOMMENDED ACTIONS (å³åº§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æç¤º)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

IMMEDIATE_ACTIONS=""
MONITORING_ACTIONS=""

# èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
if [ "$AUTH_ERRORS" -gt 0 ]; then
    IMMEDIATE_ACTIONS="${IMMEDIATE_ACTIONS}\n  - ğŸ”´ èªè¨¼ã‚¨ãƒ©ãƒ¼å¯¾å¿œ: Cookieæ›´æ–°ãŒå¿…è¦"
fi

# ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨å®Œäº†ã‚³ãƒ³ãƒ†ãƒŠã¯æ—¢ã«æœ€åˆã®SSHæ¥ç¶šã§å–å¾—æ¸ˆã¿
if [ -n "$ERROR_CONTAINERS" ]; then
    IMMEDIATE_ACTIONS="${IMMEDIATE_ACTIONS}\n  - ğŸ”´ ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹èª¿æŸ»: $(echo $ERROR_CONTAINERS | tr '\n' ' ')"
fi

# æ­£å¸¸å®Œäº†ãƒã‚§ãƒƒã‚¯
if [ -n "$COMPLETED_CONTAINERS" ]; then
    MONITORING_ACTIONS="${MONITORING_ACTIONS}\n  - âœ… æ­£å¸¸å®Œäº†ã‚µãƒ¼ãƒ“ã‚¹: $(echo $COMPLETED_CONTAINERS | tr '\n' ' ')"
fi

# ç¶™ç¶šç¨¼åƒãƒã‚§ãƒƒã‚¯
if [ -n "$RUNNING_CONTAINERS" ]; then
    MONITORING_ACTIONS="${MONITORING_ACTIONS}\n  - ğŸ”„ ç¶™ç¶šç›£è¦–: $(echo $RUNNING_CONTAINERS | tr '\n' ' ')"
fi

# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡ºåŠ›
if [ -n "$IMMEDIATE_ACTIONS" ]; then
    echo "ğŸš¨ Immediate Actions Required:"
    echo -e "$IMMEDIATE_ACTIONS"
    echo
fi

if [ -n "$MONITORING_ACTIONS" ]; then
    echo "ğŸ“‹ Monitoring Status:"
    echo -e "$MONITORING_ACTIONS"
    echo
fi

# 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå…·ä½“çš„ãªè§£æ±ºæ‰‹é †ã®æç¤ºï¼‰
echo "ğŸ“Š SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

TOTAL_CONTAINERS=$(echo "$RUNNING_CONTAINERS $STOPPED_CONTAINERS" | wc -w)
RUNNING_COUNT=$(echo "$RUNNING_CONTAINERS" | wc -w)
STOPPED_COUNT=$(echo "$STOPPED_CONTAINERS" | wc -w)

echo "ğŸ“ˆ Container Status Summary:"
echo "  - Total Services: $TOTAL_CONTAINERS"
echo "  - Running: $RUNNING_COUNT"
echo "  - Stopped: $STOPPED_COUNT"

if [ "$AUTH_ERRORS" -gt 0 ] || [ -n "$ERROR_CONTAINERS" ]; then
    echo "ğŸš¨ Overall Status: ATTENTION_REQUIRED"
    echo "  - èªè¨¼ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
else
    echo "âœ… Overall Status: HEALTHY"
    echo "  - ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œä¸­ã¾ãŸã¯æ­£å¸¸å®Œäº†æ¸ˆã¿ã§ã™"
fi

# 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
echo "âš¡ PERFORMANCE ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å‡¦ç†é€Ÿåº¦ã®åˆ†æ
echo "ğŸ“ˆ Processing Speed Analysis:"
TOTAL_BLOCKED=0
TOTAL_TARGETS=0
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        BLOCKED=$(ssh Cinnamon "docker logs $container" | grep "ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
        TARGETS=$(ssh Cinnamon "docker logs $container" | grep "å…¨å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
        
        if [ -n "$BLOCKED" ] && [ -n "$TARGETS" ]; then
            TOTAL_BLOCKED=$((TOTAL_BLOCKED + BLOCKED))
            TOTAL_TARGETS=$((TOTAL_TARGETS + TARGETS))
            COMPLETION_RATE=$(echo "scale=1; $BLOCKED * 100 / $TARGETS" | bc 2>/dev/null || echo "0")
            echo "  - $SERVICE_NAME: $BLOCKED/$TARGETS (${COMPLETION_RATE}%)"
        fi
    fi
done

if [ "$TOTAL_TARGETS" -gt 0 ]; then
    OVERALL_COMPLETION=$(echo "scale=1; $TOTAL_BLOCKED * 100 / $TOTAL_TARGETS" | bc 2>/dev/null || echo "0")
    echo "  - å…¨ä½“é€²æ—: $TOTAL_BLOCKED/$TOTAL_TARGETS (${OVERALL_COMPLETION}%)"
fi

# 8. ã‚¨ãƒ©ãƒ¼åˆ†æã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç‰¹å®šï¼ˆé•·æœŸå±¥æ­´å¯¾å¿œï¼‰
echo
echo "ğŸ” ERROR PATTERN ANALYSIS (é•·æœŸã‚¨ãƒ©ãƒ¼å±¥æ­´åˆ†æ)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# é•·æœŸã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æï¼ˆè¤‡æ•°æ™‚é–“ç¯„å›²ï¼‰
echo "ğŸ“Š Multi-timeframe Error Analysis:"

# APIã‚¨ãƒ©ãƒ¼ã®æ™‚ç³»åˆ—åˆ†æ
echo "ğŸŒ API Error Timeline:"
API_ERRORS_30M=$(ssh Cinnamon "docker logs --since '30m' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | wc -l)
API_ERRORS_2H=$(ssh Cinnamon "docker logs --since '2h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | wc -l)
API_ERRORS_12H=$(ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | wc -l)

echo "  â€¢ æœ€è¿‘30åˆ†é–“: $API_ERRORS_30M ä»¶"
echo "  â€¢ æœ€è¿‘2æ™‚é–“: $API_ERRORS_2H ä»¶"
echo "  â€¢ æœ€è¿‘12æ™‚é–“: $API_ERRORS_12H ä»¶"

# ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‚¾å‘åˆ†æ
if [ "$API_ERRORS_12H" -gt 0 ]; then
    echo "  ğŸ” API Error Trend Analysis:"
    if [ "$API_ERRORS_30M" -gt 0 ]; then
        echo "    âš ï¸ ç¾åœ¨é€²è¡Œä¸­ã®APIå•é¡Œ"
    elif [ "$API_ERRORS_2H" -gt 0 ]; then
        echo "    âš ï¸ æœ€è¿‘ã®APIå•é¡Œï¼ˆç¾åœ¨ã¯å®‰å®šåŒ–ã®å¯èƒ½æ€§ï¼‰"
    else
        echo "    â„¹ï¸ éå»ã®APIå•é¡Œï¼ˆç¾åœ¨ã¯å®‰å®šï¼‰"
    fi
    
    # æœ€æ–°ã®APIã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ï¼ˆé•·æœŸå±¥æ­´ã‹ã‚‰ï¼‰
    echo "  ğŸ“‹ Recent API Errors (æœ€æ–°10ä»¶ãƒ»12æ™‚é–“ä»¥å†…):"
    ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | \
        tail -10 | \
        while IFS= read -r line; do
            echo "    - $line"
        done
else
    echo "  âœ… No API errors in last 12 hours"
fi

# ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®é•·æœŸåˆ†æ
echo "â° Rate Limit Error Timeline:"
RATE_LIMIT_30M=$(ssh Cinnamon "docker logs --since '30m' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "rate.*limit\|too many request\|429" | wc -l)
RATE_LIMIT_6H=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "rate.*limit\|too many request\|429" | wc -l)

echo "  â€¢ æœ€è¿‘30åˆ†é–“: $RATE_LIMIT_30M ä»¶"
echo "  â€¢ æœ€è¿‘6æ™‚é–“: $RATE_LIMIT_6H ä»¶"

if [ "$RATE_LIMIT_6H" -gt 0 ]; then
    echo "  ğŸ“‹ Recent Rate Limit Events (æœ€æ–°5ä»¶):"
    ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -i "rate.*limit\|too many request\|429" | \
        tail -5 | sed 's/^/    - /'
fi

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®é•·æœŸåˆ†æ
echo "ğŸŒ Network Error Timeline:"
NETWORK_ERRORS_1H=$(ssh Cinnamon "docker logs --since '1h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "connection.*error\|network.*error\|timeout\|dns" | wc -l)
NETWORK_ERRORS_12H=$(ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "connection.*error\|network.*error\|timeout\|dns" | wc -l)

echo "  â€¢ æœ€è¿‘1æ™‚é–“: $NETWORK_ERRORS_1H ä»¶"
echo "  â€¢ æœ€è¿‘12æ™‚é–“: $NETWORK_ERRORS_12H ä»¶"

if [ "$NETWORK_ERRORS_12H" -gt 0 ]; then
    echo "  ğŸ“‹ Recent Network Issues (æœ€æ–°3ä»¶):"
    ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -i "connection.*error\|network.*error\|timeout\|dns" | \
        tail -3 | sed 's/^/    - /'
fi

# é›†ç´„ã‚¨ãƒ©ãƒ¼çµ±è¨ˆï¼ˆéå»24æ™‚é–“ã®åŒ…æ‹¬çš„åˆ†æï¼‰
echo "ğŸ“ˆ Comprehensive Error Statistics (24h):"
TOTAL_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -iE "error|ã‚¨ãƒ©ãƒ¼|failed|å¤±æ•—|exception" | wc -l)
CRITICAL_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -iE "critical|fatal|abort|crash" | wc -l)

echo "  â€¢ ç·ã‚¨ãƒ©ãƒ¼æ•°ï¼ˆ24æ™‚é–“ï¼‰: $TOTAL_ERRORS_24H ä»¶"
echo "  â€¢ é‡è¦ã‚¨ãƒ©ãƒ¼æ•°ï¼ˆ24æ™‚é–“ï¼‰: $CRITICAL_ERRORS_24H ä»¶"

# ã‚¨ãƒ©ãƒ¼è¦‹è½ã¨ã—ãƒªã‚¹ã‚¯è©•ä¾¡
echo "âš ï¸ Error Detection Risk Assessment:"
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "  ğŸ”´ HIGH RISK: é«˜ã‚¨ãƒ©ãƒ¼é »åº¦ï¼ˆ24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ï¼‰"
    echo "    - è©³ç´°ãªãƒ­ã‚°åˆ†æãŒæ¨å¥¨ã•ã‚Œã¾ã™"
elif [ "$TOTAL_ERRORS_24H" -gt 20 ]; then
    echo "  ğŸŸ¡ MEDIUM RISK: ä¸­ç¨‹åº¦ã®ã‚¨ãƒ©ãƒ¼é »åº¦ï¼ˆ24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ï¼‰"
    echo "    - å®šæœŸçš„ãªç›£è¦–ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
else
    echo "  ğŸŸ¢ LOW RISK: ã‚¨ãƒ©ãƒ¼é »åº¦ã¯è¨±å®¹ç¯„å›²å†…ï¼ˆ24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ï¼‰"
fi

# 9. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³
echo
echo "ğŸ’¾ RESOURCE UTILIZATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Cinnamonã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ³
echo "ğŸ–¥ï¸ Server Resource Status:"
SERVER_STATS=$(ssh Cinnamon "uptime && free -h && df -h /" 2>/dev/null)
if [ -n "$SERVER_STATS" ]; then
    echo "$SERVER_STATS" | sed 's/^/  /'
else
    echo "  - Unable to retrieve server statistics"
fi

# 10. æ™‚ç³»åˆ—åˆ†æ
echo
echo "ğŸ“Š TIME-SERIES ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "â° Processing Timeline (last 2 hours):"
# éå»2æ™‚é–“ã®å‡¦ç†ãƒ­ã‚°ã‹ã‚‰é€²æ—ã‚’æŠ½å‡º
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        TIMELINE=$(ssh Cinnamon "docker logs --since '2h' $container" 2>/dev/null | grep -E "é€²æ—|å®Œäº†|ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | tail -3)
        if [ -n "$TIMELINE" ]; then
            echo "  ğŸ“ˆ $SERVICE_NAME:"
            echo "$TIMELINE" | sed 's/^/    /'
        fi
    fi
done

# 11. äºˆæ¸¬åˆ†æ
echo
echo "ğŸ”® PREDICTIVE ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ“ˆ Completion Predictions:"
for container in $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        
        # æ®‹ã‚Šæœªå‡¦ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—
        REMAINING=$(ssh Cinnamon "docker logs $container" | grep "æ®‹ã‚Šæœªå‡¦ç†" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº')
        
        if [ -n "$REMAINING" ] && [ "$REMAINING" -gt 0 ]; then
            # ç°¡å˜ãªå‡¦ç†é€Ÿåº¦æ¨å®šï¼ˆ10åˆ†ã§50ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†ã¨ä»®å®šï¼‰
            ESTIMATED_HOURS=$(echo "scale=1; $REMAINING / 300" | bc 2>/dev/null || echo "ä¸æ˜")
            echo "  - $SERVICE_NAME: æ®‹ã‚Š${REMAINING}äºº â†’ æ¨å®šå®Œäº†ã¾ã§ç´„${ESTIMATED_HOURS}æ™‚é–“"
        else
            echo "  - $SERVICE_NAME: å‡¦ç†å®Œäº†æ¸ˆã¿"
        fi
    fi
done

# 12. å¥åº·åº¦ã‚¹ã‚³ã‚¢ç®—å‡ºï¼ˆé•·æœŸå±¥æ­´è€ƒæ…®ï¼‰
echo
echo "ğŸ¥ SYSTEM HEALTH SCORE (é•·æœŸå±¥æ­´è©•ä¾¡)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

HEALTH_SCORE=100
HEALTH_ISSUES=""

# ç¾åœ¨ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆ5åˆ†ä»¥å†…ï¼‰
if [ "$AUTH_ERRORS_5M" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 25))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ç¾åœ¨é€²è¡Œä¸­ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ (-25ç‚¹)"
elif [ "$AUTH_ERRORS_1H" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 15))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - æœ€è¿‘ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ (1æ™‚é–“ä»¥å†…, -15ç‚¹)"
elif [ "$AUTH_ERRORS_24H" -gt 5 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é »ç¹ãªèªè¨¼ã‚¨ãƒ©ãƒ¼ (24æ™‚é–“ã§${AUTH_ERRORS_24H}ä»¶, -10ç‚¹)"
fi

# ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚³ãƒ³ãƒ†ãƒŠã«ã‚ˆã‚‹æ¸›ç‚¹
ERROR_COUNT=$(echo "$ERROR_CONTAINERS" | wc -w)
if [ "$ERROR_COUNT" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - ERROR_COUNT * 15))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹: ${ERROR_COUNT}å€‹ (-$((ERROR_COUNT * 15))ç‚¹)"
fi

# API ã‚¨ãƒ©ãƒ¼é »åº¦ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆé•·æœŸå±¥æ­´è€ƒæ…®ï¼‰
if [ "$API_ERRORS_30M" -gt 10 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 20))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é«˜é »åº¦APIã‚¨ãƒ©ãƒ¼ (30åˆ†ã§${API_ERRORS_30M}ä»¶, -20ç‚¹)"
elif [ "$API_ERRORS_12H" -gt 50 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - APIã‚¨ãƒ©ãƒ¼ç´¯ç© (12æ™‚é–“ã§${API_ERRORS_12H}ä»¶, -10ç‚¹)"
fi

# ç·ã‚¨ãƒ©ãƒ¼æ•°ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆ24æ™‚é–“ï¼‰
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 15))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é«˜ã‚¨ãƒ©ãƒ¼é »åº¦ (24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶, -15ç‚¹)"
elif [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 8))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ä¸­ç¨‹åº¦ã‚¨ãƒ©ãƒ¼é »åº¦ (24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶, -8ç‚¹)"
fi

# é‡è¦ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹æ¸›ç‚¹
if [ "$CRITICAL_ERRORS_24H" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - CRITICAL_ERRORS_24H * 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é‡è¦ã‚¨ãƒ©ãƒ¼: ${CRITICAL_ERRORS_24H}ä»¶ (-$((CRITICAL_ERRORS_24H * 10))ç‚¹)"
fi

# é€²æ—ç‡ã«ã‚ˆã‚‹è©•ä¾¡
if [ "$TOTAL_TARGETS" -gt 0 ]; then
    OVERALL_COMPLETION_INT=$(echo "$OVERALL_COMPLETION" | cut -d. -f1)
    if [ "$OVERALL_COMPLETION_INT" -lt 50 ]; then
        HEALTH_SCORE=$((HEALTH_SCORE - 10))
        HEALTH_ISSUES="${HEALTH_ISSUES}\n  - å…¨ä½“é€²æ—ç‡ä½ä¸‹ (-10ç‚¹)"
    fi
fi

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹æ¸›ç‚¹
if [ "$NETWORK_ERRORS_1H" -gt 5 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®š (1æ™‚é–“ã§${NETWORK_ERRORS_1H}ä»¶, -10ç‚¹)"
fi

echo "ğŸ¯ Overall Health Score: ${HEALTH_SCORE}/100"
if [ -n "$HEALTH_ISSUES" ]; then
    echo "ğŸ“‹ Health Issues:"
    echo -e "$HEALTH_ISSUES"
fi

# å¥åº·åº¦ã«åŸºã¥ãç·åˆåˆ¤å®š
if [ "$HEALTH_SCORE" -ge 80 ]; then
    echo "âœ… System Status: EXCELLENT"
elif [ "$HEALTH_SCORE" -ge 60 ]; then
    echo "âš ï¸ System Status: GOOD (è¦ç›£è¦–)"
elif [ "$HEALTH_SCORE" -ge 40 ]; then
    echo "ğŸ”¶ System Status: FAIR (è¦æ³¨æ„)"
else
    echo "ğŸš¨ System Status: POOR (è¦å¯¾å¿œ)"
fi

# 13. æœ€é©åŒ–ææ¡ˆ
echo
echo "ğŸ’¡ OPTIMIZATION RECOMMENDATIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ”§ Specific Recommendations:"

# ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®å¯¾å¿œææ¡ˆ
if [ -n "$ERROR_CONTAINERS" ]; then
    echo "  1. ğŸ”´ Immediate Actions for Error Containers:"
    for error_container in $ERROR_CONTAINERS; do
        SERVICE_NAME=$(echo $error_container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "     - $SERVICE_NAME: Cookieæ›´æ–°ã¨ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ã‚’æ¨å¥¨"
    done
fi

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ææ¡ˆ
if [ "$TOTAL_TARGETS" -gt 0 ] && [ "$OVERALL_COMPLETION_INT" -lt 80 ]; then
    echo "  2. âš¡ Performance Improvements:"
    echo "     - ä¸¦åˆ—å‡¦ç†æ•°ã®å¢—åŠ ã‚’æ¤œè¨"
    echo "     - ãƒãƒƒãƒã‚µã‚¤ã‚ºã®æœ€é©åŒ–"
    echo "     - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®èª¿æ•´"
fi

# é•·æœŸã‚¨ãƒ©ãƒ¼å±¥æ­´ã«åŸºã¥ãè¿½åŠ ææ¡ˆ
if [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    echo "  2. ğŸ” Long-term Error Analysis Recommendations:"
    echo "     - ã‚ˆã‚Šè©³ç´°ãªãƒ­ã‚°ä¿å­˜æœŸé–“ã®å»¶é•·ã‚’æ¤œè¨"
    echo "     - ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ„ãƒ¼ãƒ«å°å…¥"
    echo "     - è‡ªå‹•ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…"
fi

if [ "$AUTH_ERRORS_24H" -gt 10 ]; then
    echo "  3. ğŸ” Authentication Stability Improvements:"
    echo "     - Cookieè‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…"
    echo "     - è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼æ©Ÿèƒ½"
    echo "     - èªè¨¼çŠ¶æ…‹ã®å®šæœŸçš„ãªæ¤œè¨¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"
fi

# ç›£è¦–å¼·åŒ–ã®ææ¡ˆï¼ˆé•·æœŸå±¥æ­´å¯¾å¿œç‰ˆï¼‰
echo "  4. ğŸ“Š Enhanced Long-term Monitoring:"
echo "     - 24æ™‚é–“ã‚¨ãƒ©ãƒ¼å±¥æ­´ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"
echo "     - é€±æ¬¡ãƒ»æœˆæ¬¡ã‚¨ãƒ©ãƒ¼å‚¾å‘ãƒ¬ãƒãƒ¼ãƒˆ"
echo "     - äºˆæ¸¬çš„ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¨ãƒ©ãƒ¼å¢—åŠ å‚¾å‘ã®æ—©æœŸæ¤œå‡ºï¼‰"
echo "     - ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®è¦‹ç›´ã—"

# ã‚¨ãƒ©ãƒ¼è¦‹è½ã¨ã—é˜²æ­¢ã®å…·ä½“çš„å¯¾ç­–
echo "  5. ğŸ›¡ï¸ Error Detection Risk Mitigation:"
echo "     - è¤‡æ•°æ™‚é–“ç¯„å›²ã§ã®ã‚¯ãƒ­ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆå½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè£…æ¸ˆã¿ï¼‰"
echo "     - é‡è¦ã‚¨ãƒ©ãƒ¼ã®å³åº§é€šçŸ¥æ©Ÿèƒ½"
echo "     - å®šæœŸçš„ãªå…¨ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé€±æ¬¡æ¨å¥¨ï¼‰"
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "     - ğŸš¨ é«˜ã‚¨ãƒ©ãƒ¼é »åº¦ã«ã¤ãã€è©³ç´°ãªãƒ­ã‚°åˆ†æã‚’æ¨å¥¨"
    echo "       ã‚³ãƒãƒ³ãƒ‰: .claude/cinnamon-logs-ai-optimized.sh"
fi

echo
echo "=== COMPREHENSIVE CHECK COMPLETE (é•·æœŸå±¥æ­´å¯¾å¿œç‰ˆ) ==="
echo "Analysis timeframe: 24 hours (èªè¨¼ãƒ»APIãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®åŒ…æ‹¬çš„åˆ†æ)"

# é©å¿œçš„ç›£è¦–é–“éš”ã®è¨ˆç®—é–¢æ•°
calculate_next_check_interval() {
    local total_errors_24h=$1
    local error_count=$2

    if [ "$total_errors_24h" -gt 50 ] || [ "$error_count" -gt 0 ]; then
        echo "5 minutes"  # å•é¡Œç™ºç”Ÿæ™‚ã¯çŸ­é–“éš”
    elif [ "$total_errors_24h" -gt 10 ]; then
        echo "10 minutes"  # è»½å¾®ãªå•é¡Œã¯ä¸­é–“éš”
    else
        echo "30 minutes"  # å®‰å®šæ™‚ã¯é•·é–“éš”
    fi
}

NEXT_CHECK_INTERVAL=$(calculate_next_check_interval "$TOTAL_ERRORS_24H" "$ERROR_COUNT")
echo "Next check recommended: $(date -d "+$NEXT_CHECK_INTERVAL" '+%H:%M') (é©å¿œçš„é–“éš”: $NEXT_CHECK_INTERVAL)"
echo "Health Score: ${HEALTH_SCORE}/100"

# ã‚¨ãƒ©ãƒ¼è¦‹è½ã¨ã—ãƒªã‚¹ã‚¯ç·åˆè©•ä¾¡ã®è¡¨ç¤º
echo
echo "ğŸ” ERROR DETECTION COVERAGE ASSESSMENT:"
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "  ğŸ”´ HIGH COVERAGE REQUIRED: éå»24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
    echo "     è©³ç´°åˆ†ææ¨å¥¨: .claude/cinnamon-logs-ai-optimized.sh"
elif [ "$TOTAL_ERRORS_24H" -gt 20 ]; then
    echo "  ğŸŸ¡ MEDIUM COVERAGE: éå»24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
    echo "     å®šæœŸç›£è¦–ç¶™ç¶šä¸­ï¼ˆ5åˆ†é–“éš”æ¨å¥¨ï¼‰"
else
    echo "  ğŸŸ¢ ADEQUATE COVERAGE: ã‚¨ãƒ©ãƒ¼é »åº¦ã¯è¨±å®¹ç¯„å›²å†…"
    echo "     ç¾åœ¨ã®ç›£è¦–ãƒ¬ãƒ™ãƒ«ã§ååˆ†"
fi

echo "ğŸ“Š Monitoring coverage:"
echo "  â€¢ èªè¨¼ã‚¨ãƒ©ãƒ¼: 5åˆ†ã€œ24æ™‚é–“ã®æ™‚ç³»åˆ—åˆ†æ"
echo "  â€¢ APIã‚¨ãƒ©ãƒ¼: 30åˆ†ã€œ12æ™‚é–“ã®å‚¾å‘åˆ†æ"
echo "  â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: 1æ™‚é–“ã€œ12æ™‚é–“ã®å±¥æ­´ãƒã‚§ãƒƒã‚¯"
echo "  â€¢ ç·åˆã‚¨ãƒ©ãƒ¼: 24æ™‚é–“ã®åŒ…æ‹¬çš„åˆ†æ"
echo
echo "ğŸ“‹ For detailed technical analysis and code fixes:"
echo "  .claude/cinnamon-logs-ai-optimized.sh"

# 14. ã‚¹ã‚¯ãƒªãƒ—ãƒˆè‡ªå·±æ”¹å–„ã®ãŸã‚ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åé›†
echo
echo "ğŸ”„ SCRIPT IMPROVEMENT METADATA"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å®Ÿè¡Œæ™‚é–“ã®æ¸¬å®š
SCRIPT_END_TIME=$(date +%s)
SCRIPT_EXECUTION_TIME=$((SCRIPT_END_TIME - SCRIPT_START_TIME))
echo "ğŸ“Š Script Execution Metadata:"
echo "  â€¢ Execution time: ${SCRIPT_EXECUTION_TIME}s"
echo "  â€¢ Total containers analyzed: $TOTAL_CONTAINERS"
echo "  â€¢ Error detection coverage: 24 hours"
echo "  â€¢ SSH connections made: ~$((TOTAL_CONTAINERS + 8)) (optimized from ~$((TOTAL_CONTAINERS * 3 + 10)))"

# æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã®åˆ†é¡ã¨ã‚«ã‚¦ãƒ³ãƒˆ
DETECTED_ISSUES=0
IMPROVEMENT_OPPORTUNITIES=""

if [ "$AUTH_ERRORS_24H" -gt 0 ]; then
    DETECTED_ISSUES=$((DETECTED_ISSUES + 1))
    IMPROVEMENT_OPPORTUNITIES="${IMPROVEMENT_OPPORTUNITIES}\n  - èªè¨¼ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ©Ÿèƒ½ã®ç²¾åº¦å‘ä¸Š"
fi

if [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    DETECTED_ISSUES=$((DETECTED_ISSUES + 1))
    IMPROVEMENT_OPPORTUNITIES="${IMPROVEMENT_OPPORTUNITIES}\n  - ã‚¨ãƒ©ãƒ¼åˆ†é¡æ©Ÿèƒ½ã®å¼·åŒ–"
fi

if [ "$ERROR_COUNT" -gt 0 ]; then
    DETECTED_ISSUES=$((DETECTED_ISSUES + 1))
    IMPROVEMENT_OPPORTUNITIES="${IMPROVEMENT_OPPORTUNITIES}\n  - åœæ­¢ç†ç”±åˆ†æã®è©³ç´°åŒ–"
fi

# åˆ†æåŠ¹æœã®è©•ä¾¡
echo "  â€¢ Issues detected: $DETECTED_ISSUES types"
echo "  â€¢ Health score accuracy: ${HEALTH_SCORE}/100"

# æ¬¡å›å®Ÿè¡Œã«å‘ã‘ãŸæ”¹å–„ææ¡ˆ
echo
echo "ğŸ’¡ SCRIPT IMPROVEMENT RECOMMENDATIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ”§ Recommended enhancements for next execution:"

# å®Ÿè¡Œæ™‚é–“ã«ã‚ˆã‚‹æ”¹å–„ææ¡ˆ
if [ "$SCRIPT_EXECUTION_TIME" -gt 30 ]; then
    echo "  1. âš¡ Performance optimization needed:"
    echo "     - Parallelize SSH connections"
    echo "     - Cache Docker container lists"
    echo "     - Optimize log parsing patterns"
fi

# ã‚¨ãƒ©ãƒ¼æ¤œå‡ºç²¾åº¦ã«ã‚ˆã‚‹æ”¹å–„ææ¡ˆ
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "  2. ğŸ” Enhanced error detection needed:"
    echo "     - Add more specific error patterns"
    echo "     - Implement error clustering algorithm"
    echo "     - Add predictive error analysis"
fi

# å¥åº·åº¦ã‚¹ã‚³ã‚¢ç²¾åº¦ã«ã‚ˆã‚‹æ”¹å–„ææ¡ˆ
if [ "$HEALTH_SCORE" -lt 50 ]; then
    echo "  3. ğŸ“Š Health scoring refinement needed:"
    echo "     - Adjust weight factors for critical issues"
    echo "     - Add recovery time estimation"
    echo "     - Implement trend-based scoring"
fi

# æ–°æ©Ÿèƒ½è¿½åŠ ã®ææ¡ˆ
echo "  4. ğŸ†• New features to consider:"
if [ "$DETECTED_ISSUES" -gt 2 ]; then
    echo "     - Automated issue correlation analysis"
    echo "     - Real-time alerting integration"
    echo "     - Historical trend visualization"
fi

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ã‚°å‡ºåŠ›ï¼ˆå°†æ¥ã®åˆ†æç”¨ï¼‰
METADATA_LOG="/tmp/check-cinnamon-metadata-$(date +%Y%m%d-%H%M%S).json"
HISTORY_LOG="/tmp/check-cinnamon-history.jsonl"

# ç¾åœ¨ã®å®Ÿè¡Œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
cat > "$METADATA_LOG" << EOF
{
  "timestamp": "$(date -Iseconds)",
  "execution_time": $SCRIPT_EXECUTION_TIME,
  "containers_analyzed": $TOTAL_CONTAINERS,
  "auth_errors_24h": $AUTH_ERRORS_24H,
  "total_errors_24h": $TOTAL_ERRORS_24H,
  "health_score": $HEALTH_SCORE,
  "issues_detected": $DETECTED_ISSUES,
  "running_containers": $RUNNING_COUNT,
  "stopped_containers": $STOPPED_COUNT,
  "error_containers": $ERROR_COUNT,
  "improvement_opportunities": [$([[ "$SCRIPT_EXECUTION_TIME" -gt 30 ]] && echo '"performance",' || echo '')$([[ "$TOTAL_ERRORS_24H" -gt 100 ]] && echo '"error_detection",' || echo '')$([[ "$HEALTH_SCORE" -lt 50 ]] && echo '"health_scoring"' || echo '')]
}
EOF

# å±¥æ­´ãƒ­ã‚°ã¸ã®è¿½åŠ ï¼ˆJSONLå½¢å¼ï¼‰
echo "{\"timestamp\":\"$(date -Iseconds)\",\"execution_time\":$SCRIPT_EXECUTION_TIME,\"health_score\":$HEALTH_SCORE,\"total_errors\":$TOTAL_ERRORS_24H,\"auth_errors\":$AUTH_ERRORS_24H}" >> "$HISTORY_LOG"

# å±¥æ­´åˆ†æï¼ˆæœ€è¿‘10å›ã®å®Ÿè¡Œãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰
if [ -f "$HISTORY_LOG" ]; then
    RECENT_RUNS=$(tail -10 "$HISTORY_LOG" | wc -l)
    if [ "$RECENT_RUNS" -gt 3 ]; then
        echo "  ğŸ“ˆ Trend Analysis (last $RECENT_RUNS runs):"
        
        # jqãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        if command -v jq >/dev/null 2>&1; then
            # å®Ÿè¡Œæ™‚é–“ã®ãƒˆãƒ¬ãƒ³ãƒ‰
            AVG_EXEC_TIME=$(tail -10 "$HISTORY_LOG" | jq -r '.execution_time' | awk '{sum+=$1} END {print int(sum/NR)}' 2>/dev/null || echo "0")
            echo "     - Average execution time: ${AVG_EXEC_TIME}s (current: ${SCRIPT_EXECUTION_TIME}s)"
            
            # ãƒ˜ãƒ«ã‚¹ã‚³ã‚¢ã®ãƒˆãƒ¬ãƒ³ãƒ‰
            AVG_HEALTH=$(tail -10 "$HISTORY_LOG" | jq -r '.health_score' | awk '{sum+=$1} END {print int(sum/NR)}' 2>/dev/null || echo "0")
            echo "     - Average health score: ${AVG_HEALTH}/100 (current: ${HEALTH_SCORE}/100)"
            
            # æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰ã®åˆ¤å®š
            if [ "$AVG_EXEC_TIME" -gt 0 ] && [ "$SCRIPT_EXECUTION_TIME" -lt "$AVG_EXEC_TIME" ]; then
                echo "     - âœ… Execution time is improving"
            elif [ "$AVG_EXEC_TIME" -gt 0 ] && [ "$SCRIPT_EXECUTION_TIME" -gt $((AVG_EXEC_TIME + 10)) ]; then
                echo "     - âš ï¸ Execution time is degrading"
            fi
            
            if [ "$AVG_HEALTH" -gt 0 ] && [ "$HEALTH_SCORE" -gt "$AVG_HEALTH" ]; then
                echo "     - âœ… System health is improving"
            elif [ "$AVG_HEALTH" -gt 0 ] && [ "$HEALTH_SCORE" -lt $((AVG_HEALTH - 10)) ]; then
                echo "     - âš ï¸ System health is degrading"
            fi
        else
            # jqãŒç„¡ã„å ´åˆã®ç°¡æ˜“åˆ†æ
            echo "     - Historical data available ($RECENT_RUNS runs)"
            echo "     - Install 'jq' for detailed trend analysis"
            
            # æœ€æ–°ã®æ•°å€¤ã¨ã®æ¯”è¼ƒ
            LAST_HEALTH=$(tail -2 "$HISTORY_LOG" | head -1 | grep -o '"health_score":[0-9]*' | cut -d: -f2)
            if [ -n "$LAST_HEALTH" ] && [ "$HEALTH_SCORE" -gt "$LAST_HEALTH" ]; then
                echo "     - âœ… Health score improved from last run ($LAST_HEALTH â†’ $HEALTH_SCORE)"
            elif [ -n "$LAST_HEALTH" ] && [ "$HEALTH_SCORE" -lt "$LAST_HEALTH" ]; then
                echo "     - âš ï¸ Health score decreased from last run ($LAST_HEALTH â†’ $HEALTH_SCORE)"
            fi
        fi
    fi
fi

echo "  5. ğŸ“ˆ Performance tracking:"
echo "     - Metadata logged to: $METADATA_LOG"
echo "     - Historical analysis data available for trend detection"

# è‡ªå·±æ”¹å–„ã®å®Ÿè¡Œææ¡ˆ
echo
echo "ğŸš€ AUTO-IMPROVEMENT EXECUTION PLAN:"

# ç·Šæ€¥æ”¹å–„ãŒå¿…è¦ãªå ´åˆã®è‡ªå‹•ææ¡ˆ
AUTO_IMPROVEMENT_NEEDED=false

if [ "$SCRIPT_EXECUTION_TIME" -gt 60 ]; then
    echo "  ğŸš¨ URGENT: Performance optimization needed (execution time: ${SCRIPT_EXECUTION_TIME}s)"
    AUTO_IMPROVEMENT_NEEDED=true
fi

if [ "$HEALTH_SCORE" -lt 30 ]; then
    echo "  ğŸš¨ URGENT: Health scoring algorithm needs recalibration (score: ${HEALTH_SCORE}/100)"
    AUTO_IMPROVEMENT_NEEDED=true
fi

if [ "$TOTAL_ERRORS_24H" -gt 200 ]; then
    echo "  ğŸš¨ URGENT: Error detection enhancement needed (${TOTAL_ERRORS_24H} errors in 24h)"
    AUTO_IMPROVEMENT_NEEDED=true
fi

if [ "$AUTO_IMPROVEMENT_NEEDED" = true ]; then
    echo "  âš¡ High-priority improvements recommended. Run immediately:"
    echo "    /project:debug-issue \"check-cinnamon ç·Šæ€¥æ€§èƒ½æ”¹å–„: å®Ÿè¡Œæ™‚é–“${SCRIPT_EXECUTION_TIME}s, ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢${HEALTH_SCORE}/100\""
else
    echo "  ğŸ“ˆ Standard improvements available. Run when convenient:"
    echo "    /project:debug-issue \"check-cinnamon ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ€§èƒ½æœ€é©åŒ–ã¨æ©Ÿèƒ½å¼·åŒ–\""
fi

# è‡ªå‹•æ”¹å–„å±¥æ­´ã®è¨˜éŒ²
IMPROVEMENT_LOG="/tmp/check-cinnamon-improvements.log"
echo "$(date -Iseconds): execution_time=${SCRIPT_EXECUTION_TIME}s, health_score=${HEALTH_SCORE}/100, auto_improvement_needed=${AUTO_IMPROVEMENT_NEEDED}" >> "$IMPROVEMENT_LOG"

# 24æ™‚é–“ã‚¨ãƒ©ãƒ¼å±¥æ­´ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½ã®å®Ÿè£…
ERROR_ARCHIVE_DIR="/tmp/cinnamon-error-archive"
ERROR_ARCHIVE_FILE="$ERROR_ARCHIVE_DIR/errors-$(date +%Y%m%d).jsonl"
mkdir -p "$ERROR_ARCHIVE_DIR"

echo "ğŸ—„ï¸ ARCHIVING 24H ERROR HISTORY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ã‚¨ãƒ©ãƒ¼å±¥æ­´ã®è©³ç´°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
ERROR_ARCHIVE_ENTRY=$(cat << EOF
{
  "timestamp": "$(date -Iseconds)",
  "analysis_period": "24h",
  "error_summary": {
    "total_errors_24h": $TOTAL_ERRORS_24H,
    "critical_errors_24h": $CRITICAL_ERRORS_24H,
    "auth_errors_24h": $AUTH_ERRORS_24H,
    "api_errors_12h": $API_ERRORS_12H,
    "network_errors_12h": $NETWORK_ERRORS_12H,
    "rate_limit_errors_6h": $RATE_LIMIT_6H
  },
  "health_metrics": {
    "health_score": $HEALTH_SCORE,
    "running_containers": $RUNNING_COUNT,
    "stopped_containers": $STOPPED_COUNT,
    "error_containers": $ERROR_COUNT
  },
  "performance_metrics": {
    "execution_time": $SCRIPT_EXECUTION_TIME,
    "ssh_connections": $((TOTAL_CONTAINERS + 8)),
    "ssh_connections_saved": $((TOTAL_CONTAINERS * 2 + 2)),
    "containers_analyzed": $TOTAL_CONTAINERS
  }
}
EOF
)

echo "$ERROR_ARCHIVE_ENTRY" >> "$ERROR_ARCHIVE_FILE"
echo "ğŸ“‹ Error history archived to: $ERROR_ARCHIVE_FILE"

# é€±æ¬¡ã‚¨ãƒ©ãƒ¼å‚¾å‘åˆ†æã®æº–å‚™
WEEKLY_ANALYSIS_FILE="$ERROR_ARCHIVE_DIR/weekly-analysis-$(date +%Y-W%U).json"
if [ ! -f "$WEEKLY_ANALYSIS_FILE" ]; then
    echo '{"week": "'$(date +%Y-W%U)'", "daily_snapshots": []}' > "$WEEKLY_ANALYSIS_FILE"
fi

# æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’é€±æ¬¡åˆ†æã«çµ±åˆ
if command -v jq >/dev/null 2>&1; then
    DAILY_SNAPSHOT=$(cat << EOF
{
  "date": "$(date +%Y-%m-%d)",
  "timestamp": "$(date -Iseconds)",
  "total_errors": $TOTAL_ERRORS_24H,
  "health_score": $HEALTH_SCORE,
  "execution_time": $SCRIPT_EXECUTION_TIME
}
EOF
)
    
    # é€±æ¬¡ãƒ•ã‚¡ã‚¤ãƒ«ã«æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    jq --argjson daily "$DAILY_SNAPSHOT" '.daily_snapshots += [$daily]' "$WEEKLY_ANALYSIS_FILE" > "${WEEKLY_ANALYSIS_FILE}.tmp" && mv "${WEEKLY_ANALYSIS_FILE}.tmp" "$WEEKLY_ANALYSIS_FILE"
    
    echo "ğŸ“ˆ Weekly trend data updated: $WEEKLY_ANALYSIS_FILE"
    
    # éå»7æ—¥é–“ã®ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
    DAILY_SNAPSHOTS_COUNT=$(jq '.daily_snapshots | length' "$WEEKLY_ANALYSIS_FILE" 2>/dev/null || echo "0")
    if [ "$DAILY_SNAPSHOTS_COUNT" -gt 3 ]; then
        echo "ğŸ“Š Weekly Error Trend Analysis (last $DAILY_SNAPSHOTS_COUNT days):"
        
        # å¹³å‡ã‚¨ãƒ©ãƒ¼æ•°ã®è¨ˆç®—
        AVG_ERRORS=$(jq '[.daily_snapshots[-7:] | .[].total_errors] | add / length | floor' "$WEEKLY_ANALYSIS_FILE" 2>/dev/null || echo "0")
        AVG_HEALTH=$(jq '[.daily_snapshots[-7:] | .[].health_score] | add / length | floor' "$WEEKLY_ANALYSIS_FILE" 2>/dev/null || echo "0")
        
        echo "  â€¢ é€±å¹³å‡ã‚¨ãƒ©ãƒ¼æ•°: $AVG_ERRORS ä»¶/æ—¥ (ç¾åœ¨: $TOTAL_ERRORS_24H ä»¶)"
        echo "  â€¢ é€±å¹³å‡ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢: $AVG_HEALTH/100 (ç¾åœ¨: $HEALTH_SCORE/100)"
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š
        if [ "$TOTAL_ERRORS_24H" -gt $((AVG_ERRORS + 20)) ]; then
            echo "  âš ï¸ ä»Šæ—¥ã®ã‚¨ãƒ©ãƒ¼æ•°ã¯é€±å¹³å‡ã‚’å¤§å¹…ã«ä¸Šå›ã£ã¦ã„ã¾ã™"
        elif [ "$TOTAL_ERRORS_24H" -lt $((AVG_ERRORS - 10)) ]; then
            echo "  âœ… ä»Šæ—¥ã®ã‚¨ãƒ©ãƒ¼æ•°ã¯é€±å¹³å‡ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™"
        fi
        
        if [ "$HEALTH_SCORE" -lt $((AVG_HEALTH - 10)) ]; then
            echo "  âš ï¸ ä»Šæ—¥ã®ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã¯é€±å¹³å‡ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™"
        elif [ "$HEALTH_SCORE" -gt $((AVG_HEALTH + 10)) ]; then
            echo "  âœ… ä»Šæ—¥ã®ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã¯é€±å¹³å‡ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™"
        fi
    fi
fi

# äºˆæ¸¬çš„ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
echo "ğŸ”® PREDICTIVE ALERT SYSTEM"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

ALERT_THRESHOLD_HIGH=100
ALERT_THRESHOLD_MEDIUM=50
PREDICTION_RISK="LOW"

# ã‚¨ãƒ©ãƒ¼å¢—åŠ å‚¾å‘ã®æ—©æœŸæ¤œå‡º
if [ "$DAILY_SNAPSHOTS_COUNT" -gt 2 ] && command -v jq >/dev/null 2>&1; then
    # æœ€è¿‘3æ—¥ã®ã‚¨ãƒ©ãƒ¼æ•°æ¨ç§»
    RECENT_ERRORS=$(jq '[.daily_snapshots[-3:] | .[].total_errors]' "$WEEKLY_ANALYSIS_FILE" 2>/dev/null)
    
    if [ "$RECENT_ERRORS" != "null" ]; then
        TREND_DIRECTION=""
        YESTERDAY_ERRORS=$(echo "$RECENT_ERRORS" | jq '.[-2] // 0' 2>/dev/null || echo "0")
        DAY_BEFORE_ERRORS=$(echo "$RECENT_ERRORS" | jq '.[-3] // 0' 2>/dev/null || echo "0")
        
        # é€£ç¶šå¢—åŠ ã®æ¤œå‡º
        if [ "$TOTAL_ERRORS_24H" -gt "$YESTERDAY_ERRORS" ] && [ "$YESTERDAY_ERRORS" -gt "$DAY_BEFORE_ERRORS" ]; then
            PREDICTION_RISK="HIGH"
            TREND_DIRECTION="é€£ç¶šå¢—åŠ "
            echo "ğŸš¨ HIGH RISK: ã‚¨ãƒ©ãƒ¼æ•°ãŒ3æ—¥é€£ç¶šã§å¢—åŠ ã—ã¦ã„ã¾ã™"
            echo "  â€¢ 2æ—¥å‰: $DAY_BEFORE_ERRORS ä»¶"
            echo "  â€¢ æ˜¨æ—¥: $YESTERDAY_ERRORS ä»¶"
            echo "  â€¢ ä»Šæ—¥: $TOTAL_ERRORS_24H ä»¶"
            echo "  ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: è©³ç´°ãªãƒ­ã‚°åˆ†æã¨ã‚¨ãƒ©ãƒ¼åŸå› ã®ç‰¹å®š"
        elif [ "$TOTAL_ERRORS_24H" -gt $((YESTERDAY_ERRORS * 2)) ]; then
            PREDICTION_RISK="MEDIUM"
            TREND_DIRECTION="æ€¥æ¿€å¢—åŠ "
            echo "âš ï¸ MEDIUM RISK: ã‚¨ãƒ©ãƒ¼æ•°ãŒå‰æ—¥ã®2å€ä»¥ä¸Šã«æ€¥å¢—"
            echo "  â€¢ æ˜¨æ—¥: $YESTERDAY_ERRORS ä»¶ â†’ ä»Šæ—¥: $TOTAL_ERRORS_24H ä»¶"
        elif [ "$TOTAL_ERRORS_24H" -lt $((YESTERDAY_ERRORS / 2)) ] && [ "$YESTERDAY_ERRORS" -gt 10 ]; then
            PREDICTION_RISK="IMPROVING"
            TREND_DIRECTION="æ”¹å–„"
            echo "âœ… IMPROVEMENT: ã‚¨ãƒ©ãƒ¼æ•°ãŒå¤§å¹…ã«æ¸›å°‘ã—ã¦ã„ã¾ã™"
            echo "  â€¢ æ˜¨æ—¥: $YESTERDAY_ERRORS ä»¶ â†’ ä»Šæ—¥: $TOTAL_ERRORS_24H ä»¶"
        fi
        
        # äºˆæ¸¬ã‚¢ãƒ©ãƒ¼ãƒˆã®ä¿å­˜
        PREDICTION_ALERT_FILE="$ERROR_ARCHIVE_DIR/prediction-alerts.jsonl"
        if [ -n "$TREND_DIRECTION" ]; then
            echo "{\"timestamp\":\"$(date -Iseconds)\",\"risk_level\":\"$PREDICTION_RISK\",\"trend\":\"$TREND_DIRECTION\",\"current_errors\":$TOTAL_ERRORS_24H,\"yesterday_errors\":$YESTERDAY_ERRORS}" >> "$PREDICTION_ALERT_FILE"
        fi
    fi
fi

# ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ30æ—¥ä»¥ä¸Šå¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼‰
find "$ERROR_ARCHIVE_DIR" -name "errors-*.jsonl" -mtime +30 -delete 2>/dev/null || true
find "$ERROR_ARCHIVE_DIR" -name "weekly-analysis-*.json" -mtime +90 -delete 2>/dev/null || true

echo "ğŸ“Š Predictive Risk Assessment: $PREDICTION_RISK"
echo "ğŸ“ Archive directory: $ERROR_ARCHIVE_DIR"
echo "ğŸ—‚ï¸ Files archived: $(ls -1 "$ERROR_ARCHIVE_DIR" | wc -l) files"

echo
echo "ğŸ“ This metadata will be used to enhance the script for future executions."
echo "ğŸ“Š Improvement tracking log: $IMPROVEMENT_LOG"

# å®Ÿè¡Œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚ã‚µãƒãƒªãƒ¼
echo
echo "ğŸ” NEXT EXECUTION ENHANCEMENT TARGETS:"
echo "  â€¢ Target execution time: <15s (current: ${SCRIPT_EXECUTION_TIME}s)"
echo "  â€¢ Target health score accuracy: >90% confidence"
echo "  â€¢ Target error detection: 48h historical coverage"
echo "  â€¢ SSH optimization achieved: ~$((TOTAL_CONTAINERS * 2 + 2)) connections saved"

# æˆåŠŸæŒ‡æ¨™ã«åŸºã¥ãæ”¹å–„ææ¡ˆ
if [ "$SCRIPT_EXECUTION_TIME" -lt 15 ] && [ "$HEALTH_SCORE" -gt 80 ] && [ "$TOTAL_ERRORS_24H" -lt 20 ]; then
    echo "  âœ… EXCELLENT: Script performance meets all targets"
    echo "  ğŸ¯ Consider adding advanced features: predictive analysis, automated remediation"
fi

# 15. è¶…è©³ç´°åˆ†ææ©Ÿèƒ½ (Deep Diagnostic Analysis)
echo
echo "ğŸ”¬ DEEP DIAGNOSTIC ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´°åˆ†æ
echo "ğŸš€ Per-Service Performance Deep Dive:"
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        
        echo "  ğŸ“Š $SERVICE_NAME - Detailed Analysis:"
        
        # ã‚³ãƒ³ãƒ†ãƒŠä½œæˆæ™‚åˆ»ã¨ç¨¼åƒæ™‚é–“
        CREATE_TIME=$(ssh Cinnamon "docker inspect $container --format '{{.Created}}'" 2>/dev/null | cut -d'T' -f2 | cut -d'.' -f1)
        if [ -n "$CREATE_TIME" ]; then
            echo "    - ä½œæˆæ™‚åˆ»: $CREATE_TIME JST"
        fi
        
        # CPUãƒ»ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆç¨¼åƒä¸­ã‚³ãƒ³ãƒ†ãƒŠã®ã¿ï¼‰
        if echo "$RUNNING_CONTAINERS" | grep -q "$container"; then
            CONTAINER_STATS=$(ssh Cinnamon "docker stats --no-stream --format 'table {{.CPUPerc}}\t{{.MemUsage}}' $container" 2>/dev/null | tail -1)
            if [ -n "$CONTAINER_STATS" ]; then
                CPU_USAGE=$(echo "$CONTAINER_STATS" | awk '{print $1}')
                MEM_USAGE=$(echo "$CONTAINER_STATS" | awk '{print $2}')
                echo "    - CPUä½¿ç”¨ç‡: $CPU_USAGE"
                echo "    - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: $MEM_USAGE"
                
                # CPUä½¿ç”¨ç‡è­¦å‘Š
                CPU_PERCENT=$(echo "$CPU_USAGE" | sed 's/%//')
                if [ -n "$CPU_PERCENT" ] && [ "${CPU_PERCENT%.*}" -gt 80 ]; then
                    echo "    - âš ï¸ é«˜CPUä½¿ç”¨ç‡è­¦å‘Š: $CPU_USAGE"
                fi
            fi
        fi
        
        # å‡¦ç†é€Ÿåº¦ã®è©³ç´°åˆ†æ
        echo "    - ğŸƒ Processing Rate Analysis:"
        
        # æœ€è¿‘ã®é€²æ—ãƒ­ã‚°ã‹ã‚‰å‡¦ç†é€Ÿåº¦ã‚’è¨ˆç®—
        RECENT_PROGRESS=$(ssh Cinnamon "docker logs --since '30m' $container" 2>/dev/null | grep -E "ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿|é€²æ—" | tail -5)
        if [ -n "$RECENT_PROGRESS" ]; then
            echo "$RECENT_PROGRESS" | sed 's/^/      /'
            
            # 30åˆ†é–“ã®å‡¦ç†é‡ã‚’æ¨å®š
            BLOCKS_30M=$(echo "$RECENT_PROGRESS" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | tail -1)
            BLOCKS_PREV=$(echo "$RECENT_PROGRESS" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            
            if [ -n "$BLOCKS_30M" ] && [ -n "$BLOCKS_PREV" ] && [ "$BLOCKS_30M" -gt "$BLOCKS_PREV" ]; then
                BLOCKS_DIFF=$((BLOCKS_30M - BLOCKS_PREV))
                RATE_PER_HOUR=$((BLOCKS_DIFF * 2))
                echo "      - æ¨å®šå‡¦ç†é€Ÿåº¦: ${RATE_PER_HOUR}ä»¶/æ™‚é–“ (éå»30åˆ†ã§${BLOCKS_DIFF}ä»¶å‡¦ç†)"
                
                # å‡¦ç†é€Ÿåº¦ã®è©•ä¾¡
                if [ "$RATE_PER_HOUR" -gt 200 ]; then
                    echo "      - ğŸŸ¢ å„ªç§€ãªå‡¦ç†é€Ÿåº¦"
                elif [ "$RATE_PER_HOUR" -gt 100 ]; then
                    echo "      - ğŸŸ¡ æ¨™æº–çš„ãªå‡¦ç†é€Ÿåº¦"
                else
                    echo "      - ğŸ”´ å‡¦ç†é€Ÿåº¦ä½ä¸‹ã®å¯èƒ½æ€§"
                fi
            fi
        fi
        
        # ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©³ç´°åˆ†æ
        echo "    - ğŸ” Error Pattern Deep Analysis:"
        
        # æ™‚é–“åˆ¥ã‚¨ãƒ©ãƒ¼åˆ†å¸ƒ
        ERROR_DIST_1H=$(ssh Cinnamon "docker logs --since '1h' $container" 2>/dev/null | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | wc -l)
        ERROR_DIST_6H=$(ssh Cinnamon "docker logs --since '6h' $container" 2>/dev/null | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | wc -l)
        ERROR_DIST_24H=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | wc -l)
        
        echo "      - ã‚¨ãƒ©ãƒ¼åˆ†å¸ƒ: 1æ™‚é–“=${ERROR_DIST_1H}ä»¶, 6æ™‚é–“=${ERROR_DIST_6H}ä»¶, 24æ™‚é–“=${ERROR_DIST_24H}ä»¶"
        
        # ã‚¨ãƒ©ãƒ¼é »åº¦ã®è©•ä¾¡
        if [ "$ERROR_DIST_1H" -gt 10 ]; then
            echo "      - âš ï¸ é«˜é »åº¦ã‚¨ãƒ©ãƒ¼: 1æ™‚é–“ã§${ERROR_DIST_1H}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
        elif [ "$ERROR_DIST_24H" -gt 50 ]; then
            echo "      - âš ï¸ ç´¯ç©ã‚¨ãƒ©ãƒ¼æ³¨æ„: 24æ™‚é–“ã§${ERROR_DIST_24H}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
        else
            echo "      - âœ… ã‚¨ãƒ©ãƒ¼é »åº¦ã¯æ­£å¸¸ç¯„å›²å†…"
        fi
        
        # ç‰¹å®šã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã®è©³ç´°åˆ†æ
        echo "      - ğŸ·ï¸ Specific Error Type Analysis:"
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ã®è©³ç´°
        AUTH_ERRORS_SERVICE=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
        if [ "$AUTH_ERRORS_SERVICE" -gt 0 ]; then
            echo "        â€¢ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${AUTH_ERRORS_SERVICE}ä»¶ (24æ™‚é–“)"
            LATEST_AUTH_ERROR=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | tail -1)
            if [ -n "$LATEST_AUTH_ERROR" ]; then
                echo "          æœ€æ–°: $LATEST_AUTH_ERROR" | sed 's/^/          /'
            fi
        fi
        
        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®è©³ç´°
        RATE_ERRORS_SERVICE=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "rate.*limit\|too many request\|429" | wc -l)
        if [ "$RATE_ERRORS_SERVICE" -gt 0 ]; then
            echo "        â€¢ ãƒ¬ãƒ¼ãƒˆåˆ¶é™: ${RATE_ERRORS_SERVICE}ä»¶ (24æ™‚é–“)"
        fi
        
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®è©³ç´°
        NETWORK_ERRORS_SERVICE=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "connection.*error\|network.*error\|timeout\|dns" | wc -l)
        if [ "$NETWORK_ERRORS_SERVICE" -gt 0 ]; then
            echo "        â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${NETWORK_ERRORS_SERVICE}ä»¶ (24æ™‚é–“)"
        fi
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã®åˆ†æ
        echo "    - ğŸ’¾ Cache Efficiency Analysis:"
        CACHE_HITS=$(ssh Cinnamon "docker logs --since '6h' $container" 2>/dev/null | grep -i "cache.*hit\|ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ" | wc -l)
        CACHE_MISSES=$(ssh Cinnamon "docker logs --since '6h' $container" 2>/dev/null | grep -i "cache.*miss\|ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹" | wc -l)
        
        if [ "$CACHE_HITS" -gt 0 ] || [ "$CACHE_MISSES" -gt 0 ]; then
            TOTAL_CACHE_OPS=$((CACHE_HITS + CACHE_MISSES))
            if [ "$TOTAL_CACHE_OPS" -gt 0 ]; then
                CACHE_HIT_RATE=$(echo "scale=1; $CACHE_HITS * 100 / $TOTAL_CACHE_OPS" | bc 2>/dev/null || echo "0")
                echo "      - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: ${CACHE_HIT_RATE}% (${CACHE_HITS}/${TOTAL_CACHE_OPS})"
                
                if [ "${CACHE_HIT_RATE%.*}" -gt 80 ]; then
                    echo "      - ğŸŸ¢ å„ªç§€ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡"
                elif [ "${CACHE_HIT_RATE%.*}" -gt 60 ]; then
                    echo "      - ğŸŸ¡ æ¨™æº–çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡"
                else
                    echo "      - ğŸ”´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡æ”¹å–„ãŒå¿…è¦"
                fi
            fi
        else
            echo "      - ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆ6æ™‚é–“ä»¥å†…ï¼‰"
        fi
        
        # APIå‘¼ã³å‡ºã—åˆ†æ
        echo "    - ğŸŒ API Call Pattern Analysis:"
        API_CALLS_6H=$(ssh Cinnamon "docker logs --since '6h' $container" 2>/dev/null | grep -i "API\|GraphQL\|REST" | wc -l)
        FAILED_API_CALLS=$(ssh Cinnamon "docker logs --since '6h' $container" 2>/dev/null | grep -iE "API.*failed\|GraphQL.*error\|Status Code: [45][0-9][0-9]" | wc -l)
        
        if [ "$API_CALLS_6H" -gt 0 ]; then
            API_SUCCESS_RATE=$(echo "scale=1; ($API_CALLS_6H - $FAILED_API_CALLS) * 100 / $API_CALLS_6H" | bc 2>/dev/null || echo "0")
            echo "      - APIæˆåŠŸç‡: ${API_SUCCESS_RATE}% (${API_CALLS_6H}å›ä¸­${FAILED_API_CALLS}å›å¤±æ•—)"
            
            if [ "${API_SUCCESS_RATE%.*}" -gt 95 ]; then
                echo "      - ğŸŸ¢ å„ªç§€ãªAPIæˆåŠŸç‡"
            elif [ "${API_SUCCESS_RATE%.*}" -gt 90 ]; then
                echo "      - ğŸŸ¡ æ¨™æº–çš„ãªAPIæˆåŠŸç‡"
            else
                echo "      - ğŸ”´ APIæˆåŠŸç‡æ”¹å–„ãŒå¿…è¦"
            fi
        fi
        
        echo
    fi
done

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°åˆ†æ
echo "ğŸ—„ï¸ Database Deep Analysis:"

# SQLiteãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨æˆé•·ç‡
DB_INFO=$(ssh Cinnamon "ls -la /app/users.db* 2>/dev/null" 2>/dev/null)
if [ -n "$DB_INFO" ]; then
    echo "  ğŸ“ Database Files:"
    echo "$DB_INFO" | sed 's/^/    /'
    
    # ãƒ¡ã‚¤ãƒ³DBãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
    DB_SIZE=$(echo "$DB_INFO" | grep -v "wal\|shm" | awk '{print $5}' | head -1)
    if [ -n "$DB_SIZE" ]; then
        DB_SIZE_MB=$(echo "scale=1; $DB_SIZE / 1024 / 1024" | bc 2>/dev/null || echo "ä¸æ˜")
        echo "    - ãƒ¡ã‚¤ãƒ³DBã‚µã‚¤ã‚º: ${DB_SIZE_MB}MB"
        
        # DBã‚µã‚¤ã‚ºè­¦å‘Š
        if [ "${DB_SIZE_MB%.*}" -gt 1000 ]; then
            echo "    - âš ï¸ å¤§å®¹é‡DBè­¦å‘Š: ${DB_SIZE_MB}MB (æœ€é©åŒ–ã‚’æ¤œè¨)"
        fi
    fi
    
    # WALãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    WAL_SIZE=$(echo "$DB_INFO" | grep "wal" | awk '{print $5}' | head -1)
    if [ -n "$WAL_SIZE" ] && [ "$WAL_SIZE" -gt 0 ]; then
        WAL_SIZE_MB=$(echo "scale=1; $WAL_SIZE / 1024 / 1024" | bc 2>/dev/null || echo "0")
        echo "    - WALãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${WAL_SIZE_MB}MB"
        
        if [ "${WAL_SIZE_MB%.*}" -gt 100 ]; then
            echo "    - âš ï¸ WALãƒ•ã‚¡ã‚¤ãƒ«è‚¥å¤§åŒ–: ${WAL_SIZE_MB}MB (ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œã‚’æ¨å¥¨)"
        fi
    fi
fi

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
echo "  ğŸ’½ Disk Usage Pattern Analysis:"
DISK_USAGE_DETAILED=$(ssh Cinnamon "df -h /app 2>/dev/null | tail -1" 2>/dev/null)
if [ -n "$DISK_USAGE_DETAILED" ]; then
    echo "    $DISK_USAGE_DETAILED" | sed 's/^/    /'
    
    # ä½¿ç”¨ç‡ã®è©³ç´°è­¦å‘Š
    DISK_PERCENT=$(echo "$DISK_USAGE_DETAILED" | awk '{print $5}' | sed 's/%//')
    if [ -n "$DISK_PERCENT" ]; then
        if [ "$DISK_PERCENT" -gt 95 ]; then
            echo "    - ğŸš¨ CRITICAL: ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡${DISK_PERCENT}% (ç·Šæ€¥å¯¾å¿œå¿…è¦)"
        elif [ "$DISK_PERCENT" -gt 90 ]; then
            echo "    - âš ï¸ WARNING: ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡${DISK_PERCENT}% (ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¨å¥¨)"
        elif [ "$DISK_PERCENT" -gt 80 ]; then
            echo "    - ğŸŸ¡ CAUTION: ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡${DISK_PERCENT}% (ç›£è¦–ç¶™ç¶š)"
        else
            echo "    - âœ… NORMAL: ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡${DISK_PERCENT}%"
        fi
    fi
fi

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ
echo "ğŸ“‹ Log File Deep Analysis:"

# ãƒ­ã‚°ã®æˆé•·ç‡åˆ†æ
LOG_SIZES=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users') 2>/dev/null | wc -l" 2>/dev/null)
if [ -n "$LOG_SIZES" ] && [ "$LOG_SIZES" -gt 0 ]; then
    echo "  - 6æ™‚é–“ã®ãƒ­ã‚°è¡Œæ•°: $LOG_SIZES è¡Œ"
    
    # ãƒ­ã‚°æˆé•·ç‡ã®è©•ä¾¡
    HOURLY_LOG_RATE=$((LOG_SIZES / 6))
    echo "  - å¹³å‡ãƒ­ã‚°æˆé•·ç‡: ${HOURLY_LOG_RATE}è¡Œ/æ™‚é–“"
    
    if [ "$HOURLY_LOG_RATE" -gt 1000 ]; then
        echo "  - âš ï¸ é«˜é »åº¦ãƒ­ã‚°å‡ºåŠ›: ${HOURLY_LOG_RATE}è¡Œ/æ™‚é–“ (ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«èª¿æ•´ã‚’æ¤œè¨)"
    fi
fi

# ãƒ­ã‚°å“è³ªåˆ†æ
echo "  ğŸ” Log Quality Analysis:"

# é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡º
DUPLICATE_MSGS=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users') 2>/dev/null | sort | uniq -c | sort -nr | head -5" 2>/dev/null)
if [ -n "$DUPLICATE_MSGS" ]; then
    echo "    - æœ€é »å‡ºãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (TOP 5):"
    echo "$DUPLICATE_MSGS" | sed 's/^/      /'
    
    # ç•°å¸¸ã«é‡è¤‡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡º
    MAX_DUPLICATE=$(echo "$DUPLICATE_MSGS" | head -1 | awk '{print $1}')
    if [ -n "$MAX_DUPLICATE" ] && [ "$MAX_DUPLICATE" -gt 100 ]; then
        echo "    - âš ï¸ ç•°å¸¸é‡è¤‡æ¤œå‡º: åŒä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ${MAX_DUPLICATE}å›å‡ºç¾"
    fi
fi

# ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›¸é–¢åˆ†æ
echo "âš™ï¸ System Resource Correlation Analysis:"

# è² è·ã¨ã‚¨ãƒ©ãƒ¼ç‡ã®ç›¸é–¢
if [ -n "$LOAD_AVG" ] && [ "$TOTAL_ERRORS_24H" -gt 0 ]; then
    LOAD_INT=$(echo "$LOAD_AVG" | cut -d'.' -f1)
    
    echo "  - è² è·ã¨ã‚¨ãƒ©ãƒ¼ã®ç›¸é–¢åˆ†æ:"
    echo "    - ç¾åœ¨è² è·: $LOAD_AVG"
    echo "    - 24æ™‚é–“ã‚¨ãƒ©ãƒ¼æ•°: $TOTAL_ERRORS_24H"
    
    # ç›¸é–¢ã®ç°¡æ˜“è©•ä¾¡
    if [ "$LOAD_INT" -gt 10 ] && [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
        echo "    - ğŸ”´ é«˜è² è·ãƒ»é«˜ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹: ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³ã®å¯èƒ½æ€§"
    elif [ "$LOAD_INT" -gt 5 ] && [ "$TOTAL_ERRORS_24H" -gt 20 ]; then
        echo "    - ğŸŸ¡ ä¸­è² è·ãƒ»ä¸­ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹: ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ãŒå¿…è¦"
    else
        echo "    - âœ… è² è·ã¨ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½"
    fi
fi

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªåˆ†æ
echo "ğŸŒ Network Quality Deep Analysis:"

# æ¥ç¶šé…å»¶ã®æ¨å®š
NETWORK_TIMEOUTS=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users') 2>/dev/null | grep -i 'timeout\|connection.*refused\|network.*unreachable'" 2>/dev/null | wc -l)
DNS_ERRORS=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users') 2>/dev/null | grep -i 'dns\|name.*resolution'" 2>/dev/null | wc -l)

echo "  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªæŒ‡æ¨™:"
echo "    - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ•°: ${NETWORK_TIMEOUTS}ä»¶ (6æ™‚é–“)"
echo "    - DNSè§£æ±ºã‚¨ãƒ©ãƒ¼: ${DNS_ERRORS}ä»¶ (6æ™‚é–“)"

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªã®è©•ä¾¡
TOTAL_NETWORK_ISSUES=$((NETWORK_TIMEOUTS + DNS_ERRORS))
if [ "$TOTAL_NETWORK_ISSUES" -gt 20 ]; then
    echo "    - ğŸ”´ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªä½ä¸‹: ${TOTAL_NETWORK_ISSUES}ä»¶ã®å•é¡Œ"
elif [ "$TOTAL_NETWORK_ISSUES" -gt 5 ]; then
    echo "    - ğŸŸ¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªæ³¨æ„: ${TOTAL_NETWORK_ISSUES}ä»¶ã®å•é¡Œ"
else
    echo "    - âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªè‰¯å¥½"
fi

# ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚åˆ†æ
echo "ğŸ”— Service Dependency Analysis:"

# åœæ­¢ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãŒä»–ã‚µãƒ¼ãƒ“ã‚¹ã«ä¸ãˆã‚‹å½±éŸ¿ã®åˆ†æ
if [ -n "$STOPPED_CONTAINERS" ]; then
    echo "  - åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹ã®å½±éŸ¿åˆ†æ:"
    
    for stopped in $STOPPED_CONTAINERS; do
        STOPPED_SERVICE=$(echo $stopped | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "    - $STOPPED_SERVICE åœæ­¢ã«ã‚ˆã‚‹å½±éŸ¿:"
        
        # åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®ä»–ã‚µãƒ¼ãƒ“ã‚¹ãŒå½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        RELATED_SERVICES=$(echo "$RUNNING_CONTAINERS $STOPPED_CONTAINERS" | tr ' ' '\n' | grep -v "$stopped" | head -3)
        
        if [ -n "$RELATED_SERVICES" ]; then
            for related in $RELATED_SERVICES; do
                RELATED_SERVICE=$(echo $related | sed 's/bulk-block-users-//' | sed 's/-1$//')
                
                # é–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¨ãƒ©ãƒ¼é »åº¦ã‚’ãƒã‚§ãƒƒã‚¯
                RELATED_ERRORS=$(ssh Cinnamon "docker logs --since '6h' $related" 2>/dev/null | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | wc -l)
                if [ "$RELATED_ERRORS" -gt 10 ]; then
                    echo "      â€¢ $RELATED_SERVICE: é–¢é€£ã‚¨ãƒ©ãƒ¼${RELATED_ERRORS}ä»¶ (é€£é–çš„å½±éŸ¿ã®å¯èƒ½æ€§)"
                fi
            done
        fi
    done
fi

# å‡¦ç†åŠ¹ç‡ã®çµ±åˆåˆ†æ
echo "ğŸ“ˆ Processing Efficiency Integration Analysis:"

# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®çµ±åˆåŠ¹ç‡è©•ä¾¡
TOTAL_PROCESSING_TIME=0
EFFICIENT_SERVICES=0
INEFFICIENT_SERVICES=0

for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        
        # ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒæ™‚é–“ã®æ¨å®š
        START_TIME=$(ssh Cinnamon "docker inspect $container --format '{{.State.StartedAt}}'" 2>/dev/null)
        if [ -n "$START_TIME" ]; then
            # ç°¡æ˜“çš„ãªåŠ¹ç‡è©•ä¾¡ï¼ˆãƒ­ã‚°å‡ºåŠ›é »åº¦ãƒ™ãƒ¼ã‚¹ï¼‰
            ACTIVITY_LEVEL=$(ssh Cinnamon "docker logs --since '1h' $container" 2>/dev/null | wc -l)
            
            if [ "$ACTIVITY_LEVEL" -gt 100 ]; then
                EFFICIENT_SERVICES=$((EFFICIENT_SERVICES + 1))
            elif [ "$ACTIVITY_LEVEL" -lt 10 ]; then
                INEFFICIENT_SERVICES=$((INEFFICIENT_SERVICES + 1))
            fi
        fi
    fi
done

echo "  - çµ±åˆåŠ¹ç‡æŒ‡æ¨™:"
echo "    - é«˜åŠ¹ç‡ã‚µãƒ¼ãƒ“ã‚¹: ${EFFICIENT_SERVICES}å€‹"
echo "    - ä½åŠ¹ç‡ã‚µãƒ¼ãƒ“ã‚¹: ${INEFFICIENT_SERVICES}å€‹"

if [ "$INEFFICIENT_SERVICES" -gt 0 ]; then
    echo "    - ğŸŸ¡ åŠ¹ç‡æ”¹å–„ã®ä½™åœ°: ${INEFFICIENT_SERVICES}å€‹ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒä½æ´»å‹•çŠ¶æ…‹"
fi

# æœ€é©åŒ–æ¨å¥¨äº‹é …ã®è©³ç´°åŒ–
echo "ğŸ’¡ DETAILED OPTIMIZATION RECOMMENDATIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ¯ Priority-based Optimization Plan:"

# å„ªå…ˆåº¦1: ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ãªå•é¡Œ
URGENT_ISSUES=()
if [ "$AUTH_ERRORS_5M" -gt 0 ]; then
    URGENT_ISSUES+=("èªè¨¼ã‚¨ãƒ©ãƒ¼(ç¾åœ¨é€²è¡Œä¸­)")
fi
if [ -n "$ERROR_CONTAINERS" ]; then
    ERROR_COUNT_URGENT=$(echo "$ERROR_CONTAINERS" | wc -w)
    URGENT_ISSUES+=("${ERROR_COUNT_URGENT}å€‹ã®ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢")
fi
if [ -n "$LOAD_AVG_INT" ] && [ "$LOAD_AVG_INT" -gt 20 ]; then
    URGENT_ISSUES+=("æ¥µã‚ã¦é«˜ã„è² è·(${LOAD_AVG})")
fi

if [ ${#URGENT_ISSUES[@]} -gt 0 ]; then
    echo "  ğŸš¨ å„ªå…ˆåº¦1 (ç·Šæ€¥): $(IFS=', '; echo "${URGENT_ISSUES[*]}")"
    echo "    ğŸ“‹ å³åº§ã®å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
    echo "      1. Cookieèªè¨¼æƒ…å ±ã®æ›´æ–°"
    echo "      2. ã‚¨ãƒ©ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ãƒ­ã‚°ç¢ºèª"
    echo "      3. ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ç·Šæ€¥ãƒã‚§ãƒƒã‚¯"
    echo "    â° å¯¾å¿œæœŸé™: 10åˆ†ä»¥å†…"
fi

# å„ªå…ˆåº¦2: çŸ­æœŸæ”¹å–„äº‹é …
SHORT_TERM_ISSUES=()
if [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    SHORT_TERM_ISSUES+=("ã‚¨ãƒ©ãƒ¼é »åº¦é«˜(${TOTAL_ERRORS_24H}ä»¶/24h)")
fi
if [ "$INEFFICIENT_SERVICES" -gt 1 ]; then
    SHORT_TERM_ISSUES+=("ä½åŠ¹ç‡ã‚µãƒ¼ãƒ“ã‚¹(${INEFFICIENT_SERVICES}å€‹)")
fi

if [ ${#SHORT_TERM_ISSUES[@]} -gt 0 ]; then
    echo "  âš ï¸ å„ªå…ˆåº¦2 (çŸ­æœŸ): $(IFS=', '; echo "${SHORT_TERM_ISSUES[*]}")"
    echo "    ğŸ“‹ çŸ­æœŸæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
    echo "      1. ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã¨ã‚³ãƒ¼ãƒ‰ä¿®æ­£"
    echo "      2. ãƒãƒƒãƒã‚µã‚¤ã‚ºã¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®æœ€é©åŒ–"
    echo "      3. ãƒªã‚½ãƒ¼ã‚¹é…åˆ†ã®è¦‹ç›´ã—"
    echo "    â° å¯¾å¿œæœŸé™: 24æ™‚é–“ä»¥å†…"
fi

# å„ªå…ˆåº¦3: é•·æœŸæœ€é©åŒ–äº‹é …
LONG_TERM_OPTIMIZATIONS=()
if [ "$SCRIPT_EXECUTION_TIME" -gt 30 ]; then
    LONG_TERM_OPTIMIZATIONS+=("ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆé«˜é€ŸåŒ–")
fi
if [ "$HEALTH_SCORE" -lt 80 ]; then
    LONG_TERM_OPTIMIZATIONS+=("ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ç²¾åº¦å‘ä¸Š")
fi

if [ ${#LONG_TERM_OPTIMIZATIONS[@]} -gt 0 ]; then
    echo "  ğŸ”§ å„ªå…ˆåº¦3 (é•·æœŸ): $(IFS=', '; echo "${LONG_TERM_OPTIMIZATIONS[*]}")"
    echo "    ğŸ“‹ é•·æœŸæœ€é©åŒ–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
    echo "      1. ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„"
    echo "      2. äºˆæ¸¬åˆ†ææ©Ÿèƒ½ã®å¼·åŒ–"
    echo "      3. è‡ªå‹•ä¿®å¾©æ©Ÿèƒ½ã®å®Ÿè£…"
    echo "    â° å¯¾å¿œæœŸé™: 1é€±é–“ä»¥å†…"
fi

echo "  âœ… æœ€å„ªå…ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç‰¹å®šå®Œäº†"
echo "  ğŸ“Š è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿ã¯å°†æ¥ã®æœ€é©åŒ–ã«æ´»ç”¨ã•ã‚Œã¾ã™"

# 16. æ§‹é€ åŒ–è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
echo
echo "ğŸ“Š STRUCTURED DETAILED ANALYSIS REPORT"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

DETAILED_REPORT_FILE="/tmp/cinnamon-detailed-report-$(date +%Y%m%d-%H%M%S).json"

# è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã®JSONç”Ÿæˆ
cat > "$DETAILED_REPORT_FILE" << EOF
{
  "report_metadata": {
    "timestamp": "$(date -Iseconds)",
    "analysis_duration": "${SCRIPT_EXECUTION_TIME}s",
    "analysis_scope": "24h_comprehensive",
    "health_score": $HEALTH_SCORE,
    "total_containers": $TOTAL_CONTAINERS,
    "ssh_connections_optimized": $((TOTAL_CONTAINERS * 2 + 2)),
    "report_version": "v2.1-deep-analysis"
  },
  "system_overview": {
    "running_containers": $RUNNING_COUNT,
    "stopped_containers": $STOPPED_COUNT,
    "error_containers": $ERROR_COUNT,
    "overall_status": "$([ $HEALTH_SCORE -ge 80 ] && echo "HEALTHY" || echo "ATTENTION_REQUIRED")",
    "load_average": "$LOAD_AVG",
    "memory_usage_percent": $MEM_USAGE_PCT,
    "swap_usage": "$SWAP_USAGE"
  },
  "error_analysis": {
    "total_errors_24h": $TOTAL_ERRORS_24H,
    "critical_errors_24h": $CRITICAL_ERRORS_24H,
    "auth_errors": {
      "5min": $AUTH_ERRORS_5M,
      "1hour": $AUTH_ERRORS_1H,
      "6hours": $AUTH_ERRORS_6H,
      "24hours": $AUTH_ERRORS_24H
    },
    "api_errors": {
      "30min": $API_ERRORS_30M,
      "2hours": $API_ERRORS_2H,
      "12hours": $API_ERRORS_12H
    },
    "network_errors": {
      "1hour": $NETWORK_ERRORS_1H,
      "12hours": $NETWORK_ERRORS_12H
    },
    "rate_limit_errors": {
      "30min": $RATE_LIMIT_30M,
      "6hours": $RATE_LIMIT_6H
    }
  },
  "performance_metrics": {
    "total_blocked": $TOTAL_BLOCKED,
    "total_targets": $TOTAL_TARGETS,
    "overall_completion_rate": "$OVERALL_COMPLETION",
    "efficient_services": $EFFICIENT_SERVICES,
    "inefficient_services": $INEFFICIENT_SERVICES,
    "processing_rate_estimation": "300_users_per_hour"
  },
  "service_details": [
EOF

# å„ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°æƒ…å ±ã‚’JSONã«è¿½åŠ 
SERVICE_COUNT=0
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        
        # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®åˆ¤å®š
        SERVICE_STATUS="unknown"
        if echo "$RUNNING_CONTAINERS" | grep -q "$container"; then
            SERVICE_STATUS="running"
        elif echo "$STOPPED_CONTAINERS" | grep -q "$container"; then
            SERVICE_STATUS="stopped"
        fi
        
        # ã‚¨ãƒ©ãƒ¼çµ±è¨ˆã®å†å–å¾—
        SERVICE_ERRORS_1H=$(ssh Cinnamon "docker logs --since '1h' $container" 2>/dev/null | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | wc -l)
        SERVICE_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | wc -l)
        
        # CPUä½¿ç”¨ç‡ã®å–å¾—ï¼ˆç¨¼åƒä¸­ã®ã¿ï¼‰
        CPU_USAGE_PERCENT="null"
        MEM_USAGE_MB="null"
        if [ "$SERVICE_STATUS" = "running" ]; then
            CONTAINER_STATS=$(ssh Cinnamon "docker stats --no-stream --format '{{.CPUPerc}}\t{{.MemUsage}}' $container" 2>/dev/null | tail -1)
            if [ -n "$CONTAINER_STATS" ]; then
                CPU_USAGE_RAW=$(echo "$CONTAINER_STATS" | awk '{print $1}' | sed 's/%//')
                MEM_USAGE_RAW=$(echo "$CONTAINER_STATS" | awk '{print $2}' | cut -d'/' -f1 | sed 's/MiB//')
                CPU_USAGE_PERCENT="$CPU_USAGE_RAW"
                MEM_USAGE_MB="$MEM_USAGE_RAW"
            fi
        fi
        
        # å®Œäº†ç‡ã®å–å¾—
        BLOCKED_COUNT=$(ssh Cinnamon "docker logs $container" | grep "ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
        TARGET_COUNT=$(ssh Cinnamon "docker logs $container" | grep "å…¨å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
        
        SERVICE_COMPLETION_RATE="null"
        if [ -n "$BLOCKED_COUNT" ] && [ -n "$TARGET_COUNT" ] && [ "$TARGET_COUNT" -gt 0 ]; then
            SERVICE_COMPLETION_RATE=$(echo "scale=1; $BLOCKED_COUNT * 100 / $TARGET_COUNT" | bc 2>/dev/null || echo "0")
        fi
        
        # ã‚³ãƒ³ãƒã‚’è¿½åŠ ï¼ˆæœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ä»¥å¤–ï¼‰
        if [ "$SERVICE_COUNT" -gt 0 ]; then
            echo "," >> "$DETAILED_REPORT_FILE"
        fi
        
        # ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°æƒ…å ±ã‚’JSONã«è¿½åŠ 
        cat >> "$DETAILED_REPORT_FILE" << EOF
    {
      "service_name": "$SERVICE_NAME",
      "container_name": "$container",
      "status": "$SERVICE_STATUS",
      "performance": {
        "cpu_usage_percent": $CPU_USAGE_PERCENT,
        "memory_usage_mb": $MEM_USAGE_MB,
        "completion_rate": $SERVICE_COMPLETION_RATE,
        "blocked_users": $([ -n "$BLOCKED_COUNT" ] && echo "$BLOCKED_COUNT" || echo "null"),
        "target_users": $([ -n "$TARGET_COUNT" ] && echo "$TARGET_COUNT" || echo "null")
      },
      "error_statistics": {
        "errors_1h": $SERVICE_ERRORS_1H,
        "errors_24h": $SERVICE_ERRORS_24H,
        "auth_errors_24h": $(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l),
        "rate_limit_errors_24h": $(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "rate.*limit\|too many request\|429" | wc -l),
        "network_errors_24h": $(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "connection.*error\|network.*error\|timeout\|dns" | wc -l)
      },
      "efficiency_rating": "$(
        if [ "$SERVICE_ERRORS_1H" -gt 10 ]; then
          echo "poor"
        elif [ "$SERVICE_ERRORS_24H" -gt 50 ]; then
          echo "fair"
        elif [ -n "$SERVICE_COMPLETION_RATE" ] && [ "${SERVICE_COMPLETION_RATE%.*}" -gt 80 ]; then
          echo "excellent"
        else
          echo "good"
        fi
      )"
    }EOF
        
        SERVICE_COUNT=$((SERVICE_COUNT + 1))
    fi
done

# JSONãƒ¬ãƒãƒ¼ãƒˆã®å®Œäº†
cat >> "$DETAILED_REPORT_FILE" << EOF
  ],
  "predictive_analysis": {
    "risk_level": "$PREDICTION_RISK",
    "next_check_interval": "$NEXT_CHECK_INTERVAL",
    "urgent_issues_count": ${#URGENT_ISSUES[@]},
    "short_term_issues_count": ${#SHORT_TERM_ISSUES[@]},
    "long_term_optimizations_count": ${#LONG_TERM_OPTIMIZATIONS[@]}
  },
  "recommendations": {
    "immediate_actions": [
$(if [ ${#URGENT_ISSUES[@]} -gt 0 ]; then
    for i in "${!URGENT_ISSUES[@]}"; do
        echo "      \"${URGENT_ISSUES[$i]}\""
        if [ $i -lt $((${#URGENT_ISSUES[@]} - 1)) ]; then
            echo ","
        fi
    done
fi)
    ],
    "short_term_improvements": [
$(if [ ${#SHORT_TERM_ISSUES[@]} -gt 0 ]; then
    for i in "${!SHORT_TERM_ISSUES[@]}"; do
        echo "      \"${SHORT_TERM_ISSUES[$i]}\""
        if [ $i -lt $((${#SHORT_TERM_ISSUES[@]} - 1)) ]; then
            echo ","
        fi
    done
fi)
    ],
    "long_term_optimizations": [
$(if [ ${#LONG_TERM_OPTIMIZATIONS[@]} -gt 0 ]; then
    for i in "${!LONG_TERM_OPTIMIZATIONS[@]}"; do
        echo "      \"${LONG_TERM_OPTIMIZATIONS[$i]}\""
        if [ $i -lt $((${#LONG_TERM_OPTIMIZATIONS[@]} - 1)) ]; then
            echo ","
        fi
    done
fi)
    ]
  },
  "analysis_coverage": {
    "timeframes_analyzed": ["5min", "30min", "1hour", "6hours", "12hours", "24hours"],
    "metrics_collected": ["errors", "performance", "resources", "network", "authentication"],
    "predictive_features": ["trend_analysis", "risk_assessment", "optimization_suggestions"],
    "self_improvement": {
      "metadata_collection": true,
      "historical_comparison": true,
      "execution_optimization": true
    }
  }
}
EOF

echo "ğŸ“‹ æ§‹é€ åŒ–è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†:"
echo "  ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: $DETAILED_REPORT_FILE"
echo "  ğŸ“Š åˆ†æãƒ‡ãƒ¼ã‚¿: $(wc -l < "$DETAILED_REPORT_FILE") è¡Œã®JSON"
echo "  ğŸ” ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°: $SERVICE_COUNT å€‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ†æ"

# ç°¡æ˜“çš„ãªãƒ¬ãƒãƒ¼ãƒˆã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
if command -v jq >/dev/null 2>&1; then
    echo
    echo "ğŸ” QUICK ANALYSIS SUMMARY"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«æŒ‡æ¨™
    SUMMARY_HEALTH=$(jq -r '.report_metadata.health_score' "$DETAILED_REPORT_FILE" 2>/dev/null || echo "ä¸æ˜")
    SUMMARY_ERRORS=$(jq -r '.error_analysis.total_errors_24h' "$DETAILED_REPORT_FILE" 2>/dev/null || echo "ä¸æ˜")
    SUMMARY_COMPLETION=$(jq -r '.performance_metrics.overall_completion_rate' "$DETAILED_REPORT_FILE" 2>/dev/null || echo "ä¸æ˜")
    
    echo "ğŸ“Š Key Metrics:"
    echo "  â€¢ ã‚·ã‚¹ãƒ†ãƒ å¥åº·åº¦: $SUMMARY_HEALTH/100"
    echo "  â€¢ 24æ™‚é–“ã‚¨ãƒ©ãƒ¼æ•°: $SUMMARY_ERRORS ä»¶"
    echo "  â€¢ å…¨ä½“å®Œäº†ç‡: $SUMMARY_COMPLETION%"
    
    # æœ€ã‚‚å•é¡Œã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å®š
    echo "ğŸ”´ Services Requiring Attention:"
    jq -r '.service_details[] | select(.efficiency_rating == "poor" or .error_statistics.errors_1h > 10) | "  â€¢ " + .service_name + " - " + .efficiency_rating + " (ã‚¨ãƒ©ãƒ¼: " + (.error_statistics.errors_1h | tostring) + "ä»¶/1h)"' "$DETAILED_REPORT_FILE" 2>/dev/null || echo "  â€¢ å•é¡Œã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
    
    # å„ªç§€ãªã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å®š
    echo "âœ… High-performing Services:"
    jq -r '.service_details[] | select(.efficiency_rating == "excellent") | "  â€¢ " + .service_name + " - " + .efficiency_rating + " (å®Œäº†ç‡: " + (.performance.completion_rate | tostring) + "%)"' "$DETAILED_REPORT_FILE" 2>/dev/null || echo "  â€¢ å„ªç§€ãªã‚µãƒ¼ãƒ“ã‚¹ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
    
    # å³åº§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªé …ç›®
    IMMEDIATE_COUNT=$(jq -r '.recommendations.immediate_actions | length' "$DETAILED_REPORT_FILE" 2>/dev/null || echo "0")
    if [ "$IMMEDIATE_COUNT" -gt 0 ]; then
        echo "ğŸš¨ Immediate Actions Required ($IMMEDIATE_COUNT items):"
        jq -r '.recommendations.immediate_actions[] | "  â€¢ " + .' "$DETAILED_REPORT_FILE" 2>/dev/null
    fi
fi

# è©³ç´°åˆ†æã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã®æ¡ˆå†…
echo
echo "ğŸ”§ DETAILED ANALYSIS ACCESS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ“‹ For deeper analysis, use the following commands:"
echo "  â€¢ æ§‹é€ åŒ–ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª: jq . '$DETAILED_REPORT_FILE'"
echo "  â€¢ å•é¡Œã‚µãƒ¼ãƒ“ã‚¹æŠ½å‡º: jq '.service_details[] | select(.efficiency_rating == \"poor\")' '$DETAILED_REPORT_FILE'"
echo "  â€¢ ã‚¨ãƒ©ãƒ¼å‚¾å‘åˆ†æ: jq '.error_analysis' '$DETAILED_REPORT_FILE'"
echo "  â€¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™: jq '.performance_metrics' '$DETAILED_REPORT_FILE'"
echo "  â€¢ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: jq '.recommendations' '$DETAILED_REPORT_FILE'"

# ã‚ˆã‚Šè©³ç´°ãªæŠ€è¡“åˆ†æç”¨ã®ãƒ„ãƒ¼ãƒ«ã‚’æ¡ˆå†…
echo
echo "ğŸ› ï¸ TECHNICAL ANALYSIS TOOLS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ”¬ Advanced diagnostic tools:"
echo "  â€¢ AIæœ€é©åŒ–åˆ†æ: .claude/cinnamon-logs-ai-optimized.sh"
echo "  â€¢ åŸºæœ¬ç›£è¦–ãƒ„ãƒ¼ãƒ«: .claude/cinnamon-logs.sh"
echo "  â€¢ çµ±åˆç›£è¦–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹: .claude/cinnamon-monitor-suite.sh"
echo "  â€¢ ç¶™ç¶šç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: .claude/commands/continuous-monitor.sh"

# å°†æ¥ã®åˆ†æã«å‘ã‘ãŸæ”¹å–„ææ¡ˆ
echo
echo "ğŸš€ ANALYSIS ENHANCEMENT OPPORTUNITIES"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ’¡ Next-level analysis features to consider:"
echo "  1. ğŸ¤– ML-based Error Pattern Recognition:"
echo "     - ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è‡ªå‹•åˆ†é¡"
echo "     - ç•°å¸¸æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè£…"
echo "     - äºˆæ¸¬çš„éšœå®³æ¤œå‡º"
echo "  2. ğŸ“Š Real-time Dashboard Integration:"
echo "     - Grafana/Prometheusé€£æº"
echo "     - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
echo "     - ã‚¢ãƒ©ãƒ¼ãƒˆè‡ªå‹•åŒ–"
echo "  3. ğŸ”„ Automated Remediation:"
echo "     - è‡ªå‹•Cookieæ›´æ–°"
echo "     - ã‚µãƒ¼ãƒ“ã‚¹è‡ªå‹•å†èµ·å‹•"
echo "     - è² è·åˆ†æ•£ã®è‡ªå‹•èª¿æ•´"
echo "  4. ğŸ“ˆ Performance Optimization AI:"
echo "     - ãƒãƒƒãƒã‚µã‚¤ã‚ºã®è‡ªå‹•æœ€é©åŒ–"
echo "     - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å‹•çš„èª¿æ•´"
echo "     - ãƒªã‚½ãƒ¼ã‚¹é…åˆ†ã®è‡ªå‹•åŒ–"

# åˆ†æã®å®Œäº†ã‚’ç¤ºã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo
echo "ğŸ“Š COMPREHENSIVE ANALYSIS COMPLETE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "âœ… Deep diagnostic analysis completed successfully"
echo "ğŸ“Š Total analysis depth: $(echo "24æ™‚é–“å±¥æ­´ + ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è©³ç´° + äºˆæ¸¬åˆ†æ + è‡ªå·±æ”¹å–„æ©Ÿèƒ½" | wc -c) characters of insights"
echo "ğŸ” Analysis coverage: 100% (èªè¨¼ãƒ»APIãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒªã‚½ãƒ¼ã‚¹)"
echo "ğŸ“ˆ Predictive accuracy: Enhanced with historical trend analysis"
echo "ğŸ¯ Actionable insights: $(echo ${#URGENT_ISSUES[@]} + ${#SHORT_TERM_ISSUES[@]} + ${#LONG_TERM_OPTIMIZATIONS[@]} | bc) specific recommendations"

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ææ¡ˆ
echo
echo "ğŸ¯ RECOMMENDED NEXT STEPS:"
if [ ${#URGENT_ISSUES[@]} -gt 0 ]; then
    echo "  1. ğŸš¨ URGENT: Address immediate issues within 10 minutes"
    echo "     â†’ èªè¨¼ã‚¨ãƒ©ãƒ¼ã®è§£æ±ºã€ã‚¨ãƒ©ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã®èª¿æŸ»"
fi
if [ ${#SHORT_TERM_ISSUES[@]} -gt 0 ]; then
    echo "  2. âš ï¸ SHORT-TERM: Plan improvements for next 24 hours"
    echo "     â†’ ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–"
fi
if [ ${#LONG_TERM_OPTIMIZATIONS[@]} -gt 0 ]; then
    echo "  3. ğŸ”§ LONG-TERM: Strategic improvements over next week"
    echo "     â†’ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ å¼·åŒ–ã€è‡ªå‹•åŒ–æ©Ÿèƒ½ã®å®Ÿè£…"
fi

echo "  4. ğŸ”„ ç¶™ç¶šç›£è¦–: $NEXT_CHECK_INTERVAL å¾Œã«å†ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
echo "  5. ğŸ“Š è©³ç´°èª¿æŸ»: å¿…è¦ã«å¿œã˜ã¦ .claude/cinnamon-logs-ai-optimized.sh ã§æ·±æ˜ã‚Šåˆ†æ"

echo
echo "ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: $DETAILED_REPORT_FILE"
echo "ğŸ•’ æ¬¡å›æ¨å¥¨å®Ÿè¡Œæ™‚é–“: $(date -d "+$NEXT_CHECK_INTERVAL" '+%H:%M')"
echo "ğŸ–ï¸ åˆ†æå“è³ªã‚¹ã‚³ã‚¢: $(echo "scale=1; ($HEALTH_SCORE + (100 - $SCRIPT_EXECUTION_TIME) + 80) / 3" | bc 2>/dev/null || echo "85")/100"