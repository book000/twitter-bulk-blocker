#!/bin/bash

# check-cinnamon - Cinnamonã‚µãƒ¼ãƒãƒ¼åŒ…æ‹¬ç›£è¦–ã‚³ãƒãƒ³ãƒ‰
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: .claude/commands/check-cinnamon.md

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹æ™‚åˆ»ã®è¨˜éŒ²ï¼ˆæ”¹å–„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
SCRIPT_START_TIME=$(date +%s)

echo "=== CINNAMON SERVER COMPREHENSIVE CHECK ==="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo

# 1. åŸºæœ¬ç›£è¦–é …ç›®ã®å®Ÿè¡Œ
echo "ğŸ“Š CONTAINER STATUS ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ã‚³ãƒ³ãƒ†ãƒŠç¨¼åƒçŠ¶æ…‹ã¨å¥åº·ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Container Status (ç¨¼åƒä¸­/åœæ­¢ä¸­ã®è©³ç´°åˆ†æ):"
CONTAINER_STATUS=$(ssh Cinnamon "docker ps -a --filter 'name=bulk-block-users' --format 'table {{.Names}}\t{{.Status}}\t{{.State}}'")
echo "$CONTAINER_STATUS"
echo

# ç¨¼åƒä¸­ã¨åœæ­¢ä¸­ã®åˆ†é¡
RUNNING_CONTAINERS=$(ssh Cinnamon "docker ps --filter 'name=bulk-block-users' --format '{{.Names}}'")
STOPPED_CONTAINERS=$(ssh Cinnamon "docker ps -a --filter 'name=bulk-block-users' --filter 'status=exited' --format '{{.Names}}'")

echo "âœ… Running Containers:"
if [ -z "$RUNNING_CONTAINERS" ]; then
    echo "  - None"
else
    echo "$RUNNING_CONTAINERS" | sed 's/^/  - /'
fi

echo "ğŸ”´ Stopped Containers:"
if [ -z "$STOPPED_CONTAINERS" ]; then
    echo "  - None"
else
    echo "$STOPPED_CONTAINERS" | sed 's/^/  - /'
fi
echo

# 2. åœæ­¢ç†ç”±ã®è©³ç´°åˆ†æï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢åŸå› ã‚’å¾¹åº•èª¿æŸ»ï¼‰
echo "ğŸ” DETAILED CONTAINER STOP ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -n "$STOPPED_CONTAINERS" ]; then
    for container in $STOPPED_CONTAINERS; do
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "ğŸ“‹ Service: $SERVICE_NAME ($container)"
        
        # çµ‚äº†ã‚³ãƒ¼ãƒ‰ç¢ºèª
        EXIT_CODE=$(ssh Cinnamon "docker inspect $container --format '{{.State.ExitCode}}'")
        echo "  Exit Code: $EXIT_CODE"
        
        # åœæ­¢æ™‚åˆ»ã®å–å¾—
        STOP_TIME=$(ssh Cinnamon "docker inspect $container --format '{{.State.FinishedAt}}'" | cut -d'T' -f2 | cut -d'.' -f1)
        echo "  Stopped At: $STOP_TIME JST"
        
        # æœ€å¾Œã®20è¡Œã®ãƒ­ã‚°ã‹ã‚‰åœæ­¢ç†ç”±ã‚’è©³ç´°åˆ†æ
        echo "  ğŸ” Stop Reason Analysis:"
        FULL_LOGS=$(ssh Cinnamon "docker logs --tail 20 $container" 2>/dev/null)
        
        # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºï¼ˆæ‹¡å¼µç‰ˆï¼‰
        AUTH_ERROR=$(echo "$FULL_LOGS" | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication.*failed\|cookie.*ç„¡åŠ¹\|cookie.*invalid\|Could not authenticate you\|Invalid credentials" | tail -1)
        if [ -n "$AUTH_ERROR" ]; then
            echo "    â€¢ ğŸ”‘ èªè¨¼ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $AUTH_ERROR" | sed 's/^/        /'
        fi
        
        # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
        ACCOUNT_LOCK=$(echo "$FULL_LOGS" | grep -i "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯\|account.*lock\|suspended" | tail -1)
        if [ -n "$ACCOUNT_LOCK" ]; then
            echo "    â€¢ ğŸš« ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯æ¤œå‡º:"
            echo "      - $ACCOUNT_LOCK" | sed 's/^/        /'
        fi
        
        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
        RATE_LIMIT=$(echo "$FULL_LOGS" | grep -i "rate.*limit\|too many request\|429" | tail -1)
        if [ -n "$RATE_LIMIT" ]; then
            echo "    â€¢ â° ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $RATE_LIMIT" | sed 's/^/        /'
        fi
        
        # APIå¿œç­”ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
        API_ERROR=$(echo "$FULL_LOGS" | grep -E "Status Code: [45][0-9][0-9]|HTTP.*[45][0-9][0-9]" | tail -1)
        if [ -n "$API_ERROR" ]; then
            echo "    â€¢ ğŸŒ APIå¿œç­”ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $API_ERROR" | sed 's/^/        /'
        fi
        
        # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡º
        COMPLETION_MSG=$(echo "$FULL_LOGS" | grep -i "å‡¦ç†å®Œäº†\|å®Œäº†\|å…¨.*ãƒ¦ãƒ¼ã‚¶ãƒ¼.*å‡¦ç†" | tail -1)
        if [ -n "$COMPLETION_MSG" ]; then
            echo "    â€¢ âœ… æ­£å¸¸å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
            echo "      - $COMPLETION_MSG" | sed 's/^/        /'
        fi
        
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡º
        NETWORK_ERROR=$(echo "$FULL_LOGS" | grep -i "connection.*error\|network.*error\|timeout\|dns" | tail -1)
        if [ -n "$NETWORK_ERROR" ]; then
            echo "    â€¢ ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ¤œå‡º:"
            echo "      - $NETWORK_ERROR" | sed 's/^/        /'
        fi
        
        # ãã®ä»–ã®é‡è¦ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        OTHER_ERROR=$(echo "$FULL_LOGS" | grep -i "error\|ã‚¨ãƒ©ãƒ¼\|failed\|å¤±æ•—" | grep -v "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication" | tail -2)
        if [ -n "$OTHER_ERROR" ]; then
            echo "    â€¢ âš ï¸ ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼:"
            echo "$OTHER_ERROR" | sed 's/^/        - /'
        fi
        
        # åœæ­¢ç†ç”±ã®ç·åˆåˆ¤å®š
        echo "  ğŸ“Š Stop Reason Summary:"
        case $EXIT_CODE in
            0)
                if [ -n "$COMPLETION_MSG" ]; then
                    echo "    âœ… æ­£å¸¸å®Œäº† - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†æ¸ˆã¿"
                else
                    echo "    âœ… æ­£å¸¸çµ‚äº† - å‡¦ç†å¯¾è±¡å®Œäº†"
                fi
                ;;
            1)
                STOP_REASONS=()
                [ -n "$AUTH_ERROR" ] && STOP_REASONS+=("èªè¨¼ã‚¨ãƒ©ãƒ¼")
                [ -n "$ACCOUNT_LOCK" ] && STOP_REASONS+=("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯")
                [ -n "$RATE_LIMIT" ] && STOP_REASONS+=("ãƒ¬ãƒ¼ãƒˆåˆ¶é™")
                [ -n "$API_ERROR" ] && STOP_REASONS+=("APIå¿œç­”ã‚¨ãƒ©ãƒ¼")
                [ -n "$NETWORK_ERROR" ] && STOP_REASONS+=("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼")
                
                if [ ${#STOP_REASONS[@]} -gt 0 ]; then
                    echo "    ğŸ”´ ã‚¨ãƒ©ãƒ¼çµ‚äº† - $(IFS=', '; echo "${STOP_REASONS[*]}")"
                else
                    echo "    ğŸ”´ ã‚¨ãƒ©ãƒ¼çµ‚äº† - ä¸æ˜ãªåŸå› ï¼ˆè¦è©³ç´°èª¿æŸ»ï¼‰"
                fi
                ;;
            *)
                echo "    âš ï¸ ç•°å¸¸çµ‚äº† - Exit Code $EXIT_CODEï¼ˆè¦èª¿æŸ»ï¼‰"
                ;;
        esac
        
        # å¯¾å¿œæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        echo "  ğŸ’¡ Recommended Actions:"
        if [ "$EXIT_CODE" = "0" ]; then
            echo "    âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦ - æ­£å¸¸å®Œäº†æ¸ˆã¿"
        else
            if [ -n "$AUTH_ERROR" ]; then
                echo "    ğŸ”‘ Cookieæ›´æ–°ãŒå¿…è¦"
            fi
            if [ -n "$ACCOUNT_LOCK" ]; then
                echo "    â³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯è§£é™¤ã‚’å¾…æ©Ÿ"
            fi
            if [ -n "$RATE_LIMIT" ]; then
                echo "    â° ãƒ¬ãƒ¼ãƒˆåˆ¶é™è§£é™¤å¾Œã«å†é–‹"
            fi
            if [ -n "$API_ERROR" ] || [ -n "$NETWORK_ERROR" ]; then
                echo "    ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªå¾Œã«å†èµ·å‹•"
            fi
            if [ -z "$AUTH_ERROR" ] && [ -z "$ACCOUNT_LOCK" ] && [ -z "$RATE_LIMIT" ] && [ -z "$API_ERROR" ] && [ -z "$NETWORK_ERROR" ]; then
                echo "    ğŸ” è©³ç´°ãƒ­ã‚°èª¿æŸ»ãŒå¿…è¦"
            fi
        fi
        
        echo
    done
else
    echo "  No stopped containers found"
fi

# 3. å®Ÿè³ªå®Œäº†ç‡ã®æ­£ç¢ºãªè¨ˆç®—ï¼ˆæ°¸ç¶šçš„å¤±æ•—ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦æ‰±ã†ï¼‰
echo "ğŸ“ˆ COMPLETION RATE ANALYSIS (æ°¸ç¶šçš„å¤±æ•—ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦æ‰±ã†)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å„ã‚µãƒ¼ãƒ“ã‚¹ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã—ã¦å®Ÿè³ªå®Œäº†ç‡ã‚’è¨ˆç®—
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "ğŸ“Š Service: $SERVICE_NAME"
        
        # å‡¦ç†çµ±è¨ˆã®æŠ½å‡º
        STATS=$(ssh Cinnamon "docker logs $container" | grep -A 10 "=== å‡¦ç†çµ±è¨ˆ ===" | tail -10)
        
        if [ -n "$STATS" ]; then
            echo "$STATS" | sed 's/^/  /'
            
            # å®Œäº†ç‡ã®è¨ˆç®—ã¨æ°¸ç¶šçš„å¤±æ•—ã®å‡¦ç†
            TOTAL=$(echo "$STATS" | grep "å…¨å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            BLOCKED=$(echo "$STATS" | grep "ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            REMAINING=$(echo "$STATS" | grep "æ®‹ã‚Šæœªå‡¦ç†" | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
            
            if [ -n "$TOTAL" ] && [ -n "$BLOCKED" ] && [ -n "$REMAINING" ]; then
                # æ°¸ç¶šçš„å¤±æ•—æ•°ã®æ¨å®šï¼ˆã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
                PERMANENT_FAILURES=$(ssh Cinnamon "docker logs $container" | grep "æ—¢çŸ¥ã®æ°¸ç¶šçš„å¤±æ•—\|suspended\|not_found\|deactivated" | wc -l)
                
                # å®Ÿè³ªçš„ãªå‡¦ç†æ¸ˆã¿æ•°ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ + æ°¸ç¶šçš„å¤±æ•—ï¼‰
                PROCESSED=$((BLOCKED + PERMANENT_FAILURES))
                
                # å®Ÿè³ªå®Œäº†ç‡ã®è¨ˆç®—ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                if [ "$PROCESSED" -ge "$TOTAL" ]; then
                    ACTUAL_COMPLETION_RATE="100.0"
                    EFFECTIVE_REMAINING=0
                elif [ "$TOTAL" -gt 0 ]; then
                    ACTUAL_COMPLETION_RATE=$(echo "scale=1; $PROCESSED * 100 / $TOTAL" | bc 2>/dev/null || echo "0.0")
                    EFFECTIVE_REMAINING=$((TOTAL - PROCESSED))
                    
                    # é«˜å®Œäº†ç‡ï¼ˆ90%ä»¥ä¸Šï¼‰ã®å ´åˆã¯å®Ÿè³ªå®Œäº†æ‰±ã„
                    COMPLETION_INT=$(echo "$ACTUAL_COMPLETION_RATE" | cut -d. -f1)
                    if [ "$COMPLETION_INT" -ge 90 ] && [ "$EFFECTIVE_REMAINING" -le 100 ]; then
                        echo "    - ğŸ¯ å®Ÿè³ªå®Œäº†æ‰±ã„: ${ACTUAL_COMPLETION_RATE}% (æ®‹ã‚Š${EFFECTIVE_REMAINING}äººã¯å¾®é‡)"
                    fi
                else
                    ACTUAL_COMPLETION_RATE="0.0"
                    EFFECTIVE_REMAINING=0
                fi
                
                echo "  ğŸ“Š Completion Analysis:"
                echo "    - å®Ÿè³ªå®Œäº†ç‡: ${ACTUAL_COMPLETION_RATE}% (å‡¦ç†æ¸ˆã¿: ${PROCESSED}/${TOTAL})"
                echo "    - ãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ: ${BLOCKED}äºº"
                if [ "$PERMANENT_FAILURES" -gt 0 ]; then
                    echo "    - æ°¸ç¶šçš„å¤±æ•—: ${PERMANENT_FAILURES}äºº (suspended/not_found/deactivated)"
                fi
                echo "    - å®Ÿè³ªæœªå‡¦ç†: ${EFFECTIVE_REMAINING}äºº"
                
                # å®Œäº†çŠ¶æ³ã®åˆ¤å®š
                if [ "$ACTUAL_COMPLETION_RATE" = "100.0" ]; then
                    echo "    - ğŸ‰ å‡¦ç†çŠ¶æ³: å®Œå…¨å®Œäº†ï¼ˆ100%ï¼‰"
                    echo "    - ğŸ“‹ èª¬æ˜: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‡¦ç†æ¸ˆã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ + æŠ€è¡“çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ä¸å¯èƒ½ï¼‰"
                elif [ "$EFFECTIVE_REMAINING" -gt 0 ]; then
                    echo "    - ğŸ”„ å‡¦ç†çŠ¶æ³: ç¶™ç¶šä¸­ (${EFFECTIVE_REMAINING}äººãŒæœªå‡¦ç†)"
                fi
            fi
        else
            echo "  âš ï¸ No statistics available"
        fi
        echo
    fi
done

# 4. èªè¨¼çŠ¶æ…‹ã®è©³ç´°ç¢ºèªï¼ˆé•·æœŸå±¥æ­´å¯¾å¿œï¼‰
echo "ğŸ” AUTHENTICATION STATUS (é•·æœŸã‚¨ãƒ©ãƒ¼å±¥æ­´åˆ†æ)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# è¤‡æ•°æ™‚é–“ç¯„å›²ã§ã®èªè¨¼ã‚¨ãƒ©ãƒ¼åˆ†æ
echo "ğŸ“Š Authentication Error Timeline:"

# æœ€è¿‘5åˆ†é–“
AUTH_ERRORS_5M=$(ssh Cinnamon "docker logs --since '5m' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘5åˆ†é–“: $AUTH_ERRORS_5M ä»¶"

# æœ€è¿‘1æ™‚é–“
AUTH_ERRORS_1H=$(ssh Cinnamon "docker logs --since '1h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘1æ™‚é–“: $AUTH_ERRORS_1H ä»¶"

# æœ€è¿‘6æ™‚é–“
AUTH_ERRORS_6H=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘6æ™‚é–“: $AUTH_ERRORS_6H ä»¶"

# æœ€è¿‘24æ™‚é–“
AUTH_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
echo "  â€¢ æœ€è¿‘24æ™‚é–“: $AUTH_ERRORS_24H ä»¶"

# ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰åŒ–ã‚’åˆ†æ
if [ "$AUTH_ERRORS_24H" -gt 0 ]; then
    echo "ğŸ” Long-term Authentication Error Analysis:"
    
    # ã‚¨ãƒ©ãƒ¼é »åº¦ã®å‚¾å‘åˆ†æ
    if [ "$AUTH_ERRORS_5M" -gt 0 ]; then
        echo "    âš ï¸ ç¾åœ¨é€²è¡Œä¸­ã®èªè¨¼å•é¡Œï¼ˆ5åˆ†ä»¥å†…ã«ç™ºç”Ÿï¼‰"
    elif [ "$AUTH_ERRORS_1H" -gt 0 ]; then
        echo "    âš ï¸ æœ€è¿‘ã®èªè¨¼å•é¡Œï¼ˆ1æ™‚é–“ä»¥å†…ï¼‰"
    elif [ "$AUTH_ERRORS_6H" -gt 0 ]; then
        echo "    â„¹ï¸ éå»ã®èªè¨¼å•é¡Œï¼ˆ6æ™‚é–“ä»¥å†…ã€ç¾åœ¨ã¯å®‰å®šï¼‰"
    else
        echo "    â„¹ï¸ å¤ã„èªè¨¼å•é¡Œï¼ˆ24æ™‚é–“ä»¥å†…ã€ç¾åœ¨ã¯å®‰å®šï¼‰"
    fi
    
    # æœ€è¿‘ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ï¼ˆã‚ˆã‚Šè©³ç´°ï¼‰
    echo "  ğŸ“‹ Recent Authentication Errors (æœ€æ–°5ä»¶):"
    ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | \
        tail -5 | \
        while IFS= read -r line; do
            echo "    - $line"
        done
        
    # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥èªè¨¼ã‚¨ãƒ©ãƒ¼åˆ†æ
    echo "  ğŸ·ï¸ Authentication Errors by Service:"
    for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
        if [ -n "$container" ]; then
            SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
            SERVICE_AUTH_ERRORS=$(ssh Cinnamon "docker logs --since '24h' $container" 2>/dev/null | grep -i "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|cookie.*ç„¡åŠ¹" | wc -l)
            if [ "$SERVICE_AUTH_ERRORS" -gt 0 ]; then
                echo "    - $SERVICE_NAME: $SERVICE_AUTH_ERRORS ä»¶ï¼ˆ24æ™‚é–“ï¼‰"
            fi
        fi
    done
else
    echo "âœ… No authentication errors in last 24 hours"
fi

# ç¾åœ¨ã®èªè¨¼å•é¡Œã®é‡è¦åº¦åˆ¤å®š
AUTH_ERRORS=$AUTH_ERRORS_5M  # å¾Œç¶šå‡¦ç†ã¨ã®äº’æ›æ€§ç¶­æŒ
echo

# 5. å³åº§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æç¤ºï¼ˆå¯¾å¿œãŒå¿…è¦ãªå•é¡Œã®æ˜ç¢ºåŒ–ï¼‰
echo "ğŸ’¡ RECOMMENDED ACTIONS (å³åº§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æç¤º)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

IMMEDIATE_ACTIONS=""
MONITORING_ACTIONS=""

# èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
if [ "$AUTH_ERRORS" -gt 0 ]; then
    IMMEDIATE_ACTIONS="${IMMEDIATE_ACTIONS}\n  - ğŸ”´ èªè¨¼ã‚¨ãƒ©ãƒ¼å¯¾å¿œ: Cookieæ›´æ–°ãŒå¿…è¦"
fi

# Exit Code 1ã®ã‚³ãƒ³ãƒ†ãƒŠãƒã‚§ãƒƒã‚¯
ERROR_CONTAINERS=$(ssh Cinnamon "docker ps -a --filter 'name=bulk-block-users' --filter 'exited=1' --format '{{.Names}}'")
if [ -n "$ERROR_CONTAINERS" ]; then
    IMMEDIATE_ACTIONS="${IMMEDIATE_ACTIONS}\n  - ğŸ”´ ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹èª¿æŸ»: $(echo $ERROR_CONTAINERS | tr '\n' ' ')"
fi

# æ­£å¸¸å®Œäº†ãƒã‚§ãƒƒã‚¯
COMPLETED_CONTAINERS=$(ssh Cinnamon "docker ps -a --filter 'name=bulk-block-users' --filter 'exited=0' --format '{{.Names}}'")
if [ -n "$COMPLETED_CONTAINERS" ]; then
    MONITORING_ACTIONS="${MONITORING_ACTIONS}\n  - âœ… æ­£å¸¸å®Œäº†ã‚µãƒ¼ãƒ“ã‚¹: $(echo $COMPLETED_CONTAINERS | tr '\n' ' ')"
fi

# ç¶™ç¶šç¨¼åƒãƒã‚§ãƒƒã‚¯
if [ -n "$RUNNING_CONTAINERS" ]; then
    MONITORING_ACTIONS="${MONITORING_ACTIONS}\n  - ğŸ”„ ç¶™ç¶šç›£è¦–: $(echo $RUNNING_CONTAINERS | tr '\n' ' ')"
fi

# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡ºåŠ›
if [ -n "$IMMEDIATE_ACTIONS" ]; then
    echo "ğŸš¨ Immediate Actions Required:"
    echo -e "$IMMEDIATE_ACTIONS"
    echo
fi

if [ -n "$MONITORING_ACTIONS" ]; then
    echo "ğŸ“‹ Monitoring Status:"
    echo -e "$MONITORING_ACTIONS"
    echo
fi

# 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå…·ä½“çš„ãªè§£æ±ºæ‰‹é †ã®æç¤ºï¼‰
echo "ğŸ“Š SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

TOTAL_CONTAINERS=$(echo "$RUNNING_CONTAINERS $STOPPED_CONTAINERS" | wc -w)
RUNNING_COUNT=$(echo "$RUNNING_CONTAINERS" | wc -w)
STOPPED_COUNT=$(echo "$STOPPED_CONTAINERS" | wc -w)

echo "ğŸ“ˆ Container Status Summary:"
echo "  - Total Services: $TOTAL_CONTAINERS"
echo "  - Running: $RUNNING_COUNT"
echo "  - Stopped: $STOPPED_COUNT"

if [ "$AUTH_ERRORS" -gt 0 ] || [ -n "$ERROR_CONTAINERS" ]; then
    echo "ğŸš¨ Overall Status: ATTENTION_REQUIRED"
    echo "  - èªè¨¼ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
else
    echo "âœ… Overall Status: HEALTHY"
    echo "  - ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œä¸­ã¾ãŸã¯æ­£å¸¸å®Œäº†æ¸ˆã¿ã§ã™"
fi

# 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
echo "âš¡ PERFORMANCE ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å‡¦ç†é€Ÿåº¦ã®åˆ†æ
echo "ğŸ“ˆ Processing Speed Analysis:"
TOTAL_BLOCKED=0
TOTAL_TARGETS=0
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        BLOCKED=$(ssh Cinnamon "docker logs $container" | grep "ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
        TARGETS=$(ssh Cinnamon "docker logs $container" | grep "å…¨å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº' | head -1)
        
        if [ -n "$BLOCKED" ] && [ -n "$TARGETS" ]; then
            TOTAL_BLOCKED=$((TOTAL_BLOCKED + BLOCKED))
            TOTAL_TARGETS=$((TOTAL_TARGETS + TARGETS))
            COMPLETION_RATE=$(echo "scale=1; $BLOCKED * 100 / $TARGETS" | bc 2>/dev/null || echo "0")
            echo "  - $SERVICE_NAME: $BLOCKED/$TARGETS (${COMPLETION_RATE}%)"
        fi
    fi
done

if [ "$TOTAL_TARGETS" -gt 0 ]; then
    OVERALL_COMPLETION=$(echo "scale=1; $TOTAL_BLOCKED * 100 / $TOTAL_TARGETS" | bc 2>/dev/null || echo "0")
    echo "  - å…¨ä½“é€²æ—: $TOTAL_BLOCKED/$TOTAL_TARGETS (${OVERALL_COMPLETION}%)"
fi

# 8. ã‚¨ãƒ©ãƒ¼åˆ†æã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç‰¹å®šï¼ˆé•·æœŸå±¥æ­´å¯¾å¿œï¼‰
echo
echo "ğŸ” ERROR PATTERN ANALYSIS (é•·æœŸã‚¨ãƒ©ãƒ¼å±¥æ­´åˆ†æ)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# é•·æœŸã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æï¼ˆè¤‡æ•°æ™‚é–“ç¯„å›²ï¼‰
echo "ğŸ“Š Multi-timeframe Error Analysis:"

# APIã‚¨ãƒ©ãƒ¼ã®æ™‚ç³»åˆ—åˆ†æ
echo "ğŸŒ API Error Timeline:"
API_ERRORS_30M=$(ssh Cinnamon "docker logs --since '30m' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | wc -l)
API_ERRORS_2H=$(ssh Cinnamon "docker logs --since '2h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | wc -l)
API_ERRORS_12H=$(ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | wc -l)

echo "  â€¢ æœ€è¿‘30åˆ†é–“: $API_ERRORS_30M ä»¶"
echo "  â€¢ æœ€è¿‘2æ™‚é–“: $API_ERRORS_2H ä»¶"
echo "  â€¢ æœ€è¿‘12æ™‚é–“: $API_ERRORS_12H ä»¶"

# ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‚¾å‘åˆ†æ
if [ "$API_ERRORS_12H" -gt 0 ]; then
    echo "  ğŸ” API Error Trend Analysis:"
    if [ "$API_ERRORS_30M" -gt 0 ]; then
        echo "    âš ï¸ ç¾åœ¨é€²è¡Œä¸­ã®APIå•é¡Œ"
    elif [ "$API_ERRORS_2H" -gt 0 ]; then
        echo "    âš ï¸ æœ€è¿‘ã®APIå•é¡Œï¼ˆç¾åœ¨ã¯å®‰å®šåŒ–ã®å¯èƒ½æ€§ï¼‰"
    else
        echo "    â„¹ï¸ éå»ã®APIå•é¡Œï¼ˆç¾åœ¨ã¯å®‰å®šï¼‰"
    fi
    
    # æœ€æ–°ã®APIã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ï¼ˆé•·æœŸå±¥æ­´ã‹ã‚‰ï¼‰
    echo "  ğŸ“‹ Recent API Errors (æœ€æ–°10ä»¶ãƒ»12æ™‚é–“ä»¥å†…):"
    ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -E "Status Code: [45][0-9][0-9]|ã‚¨ãƒ©ãƒ¼|å¤±æ•—" | \
        tail -10 | \
        while IFS= read -r line; do
            echo "    - $line"
        done
else
    echo "  âœ… No API errors in last 12 hours"
fi

# ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®é•·æœŸåˆ†æ
echo "â° Rate Limit Error Timeline:"
RATE_LIMIT_30M=$(ssh Cinnamon "docker logs --since '30m' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "rate.*limit\|too many request\|429" | wc -l)
RATE_LIMIT_6H=$(ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "rate.*limit\|too many request\|429" | wc -l)

echo "  â€¢ æœ€è¿‘30åˆ†é–“: $RATE_LIMIT_30M ä»¶"
echo "  â€¢ æœ€è¿‘6æ™‚é–“: $RATE_LIMIT_6H ä»¶"

if [ "$RATE_LIMIT_6H" -gt 0 ]; then
    echo "  ğŸ“‹ Recent Rate Limit Events (æœ€æ–°5ä»¶):"
    ssh Cinnamon "docker logs --since '6h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -i "rate.*limit\|too many request\|429" | \
        tail -5 | sed 's/^/    - /'
fi

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®é•·æœŸåˆ†æ
echo "ğŸŒ Network Error Timeline:"
NETWORK_ERRORS_1H=$(ssh Cinnamon "docker logs --since '1h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "connection.*error\|network.*error\|timeout\|dns" | wc -l)
NETWORK_ERRORS_12H=$(ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -i "connection.*error\|network.*error\|timeout\|dns" | wc -l)

echo "  â€¢ æœ€è¿‘1æ™‚é–“: $NETWORK_ERRORS_1H ä»¶"
echo "  â€¢ æœ€è¿‘12æ™‚é–“: $NETWORK_ERRORS_12H ä»¶"

if [ "$NETWORK_ERRORS_12H" -gt 0 ]; then
    echo "  ğŸ“‹ Recent Network Issues (æœ€æ–°3ä»¶):"
    ssh Cinnamon "docker logs --since '12h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | \
        grep -i "connection.*error\|network.*error\|timeout\|dns" | \
        tail -3 | sed 's/^/    - /'
fi

# é›†ç´„ã‚¨ãƒ©ãƒ¼çµ±è¨ˆï¼ˆéå»24æ™‚é–“ã®åŒ…æ‹¬çš„åˆ†æï¼‰
echo "ğŸ“ˆ Comprehensive Error Statistics (24h):"
TOTAL_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -iE "error|ã‚¨ãƒ©ãƒ¼|failed|å¤±æ•—|exception" | wc -l)
CRITICAL_ERRORS_24H=$(ssh Cinnamon "docker logs --since '24h' \$(docker ps -aq --filter 'name=bulk-block-users')" 2>/dev/null | grep -iE "critical|fatal|abort|crash" | wc -l)

echo "  â€¢ ç·ã‚¨ãƒ©ãƒ¼æ•°ï¼ˆ24æ™‚é–“ï¼‰: $TOTAL_ERRORS_24H ä»¶"
echo "  â€¢ é‡è¦ã‚¨ãƒ©ãƒ¼æ•°ï¼ˆ24æ™‚é–“ï¼‰: $CRITICAL_ERRORS_24H ä»¶"

# ã‚¨ãƒ©ãƒ¼è¦‹è½ã¨ã—ãƒªã‚¹ã‚¯è©•ä¾¡
echo "âš ï¸ Error Detection Risk Assessment:"
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "  ğŸ”´ HIGH RISK: é«˜ã‚¨ãƒ©ãƒ¼é »åº¦ï¼ˆ24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ï¼‰"
    echo "    - è©³ç´°ãªãƒ­ã‚°åˆ†æãŒæ¨å¥¨ã•ã‚Œã¾ã™"
elif [ "$TOTAL_ERRORS_24H" -gt 20 ]; then
    echo "  ğŸŸ¡ MEDIUM RISK: ä¸­ç¨‹åº¦ã®ã‚¨ãƒ©ãƒ¼é »åº¦ï¼ˆ24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ï¼‰"
    echo "    - å®šæœŸçš„ãªç›£è¦–ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
else
    echo "  ğŸŸ¢ LOW RISK: ã‚¨ãƒ©ãƒ¼é »åº¦ã¯è¨±å®¹ç¯„å›²å†…ï¼ˆ24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ï¼‰"
fi

# 9. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³
echo
echo "ğŸ’¾ RESOURCE UTILIZATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Cinnamonã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ³
echo "ğŸ–¥ï¸ Server Resource Status:"
SERVER_STATS=$(ssh Cinnamon "uptime && free -h && df -h /" 2>/dev/null)
if [ -n "$SERVER_STATS" ]; then
    echo "$SERVER_STATS" | sed 's/^/  /'
else
    echo "  - Unable to retrieve server statistics"
fi

# 10. æ™‚ç³»åˆ—åˆ†æ
echo
echo "ğŸ“Š TIME-SERIES ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "â° Processing Timeline (last 2 hours):"
# éå»2æ™‚é–“ã®å‡¦ç†ãƒ­ã‚°ã‹ã‚‰é€²æ—ã‚’æŠ½å‡º
for container in $STOPPED_CONTAINERS $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        TIMELINE=$(ssh Cinnamon "docker logs --since '2h' $container" 2>/dev/null | grep -E "é€²æ—|å®Œäº†|ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿" | tail -3)
        if [ -n "$TIMELINE" ]; then
            echo "  ğŸ“ˆ $SERVICE_NAME:"
            echo "$TIMELINE" | sed 's/^/    /'
        fi
    fi
done

# 11. äºˆæ¸¬åˆ†æ
echo
echo "ğŸ”® PREDICTIVE ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ“ˆ Completion Predictions:"
for container in $RUNNING_CONTAINERS; do
    if [ -n "$container" ]; then
        SERVICE_NAME=$(echo $container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        
        # æ®‹ã‚Šæœªå‡¦ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—
        REMAINING=$(ssh Cinnamon "docker logs $container" | grep "æ®‹ã‚Šæœªå‡¦ç†" | tail -1 | grep -o '[0-9,]*äºº' | tr -d ',äºº')
        
        if [ -n "$REMAINING" ] && [ "$REMAINING" -gt 0 ]; then
            # ç°¡å˜ãªå‡¦ç†é€Ÿåº¦æ¨å®šï¼ˆ10åˆ†ã§50ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†ã¨ä»®å®šï¼‰
            ESTIMATED_HOURS=$(echo "scale=1; $REMAINING / 300" | bc 2>/dev/null || echo "ä¸æ˜")
            echo "  - $SERVICE_NAME: æ®‹ã‚Š${REMAINING}äºº â†’ æ¨å®šå®Œäº†ã¾ã§ç´„${ESTIMATED_HOURS}æ™‚é–“"
        else
            echo "  - $SERVICE_NAME: å‡¦ç†å®Œäº†æ¸ˆã¿"
        fi
    fi
done

# 12. å¥åº·åº¦ã‚¹ã‚³ã‚¢ç®—å‡ºï¼ˆé•·æœŸå±¥æ­´è€ƒæ…®ï¼‰
echo
echo "ğŸ¥ SYSTEM HEALTH SCORE (é•·æœŸå±¥æ­´è©•ä¾¡)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

HEALTH_SCORE=100
HEALTH_ISSUES=""

# ç¾åœ¨ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆ5åˆ†ä»¥å†…ï¼‰
if [ "$AUTH_ERRORS_5M" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 25))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ç¾åœ¨é€²è¡Œä¸­ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ (-25ç‚¹)"
elif [ "$AUTH_ERRORS_1H" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 15))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - æœ€è¿‘ã®èªè¨¼ã‚¨ãƒ©ãƒ¼ (1æ™‚é–“ä»¥å†…, -15ç‚¹)"
elif [ "$AUTH_ERRORS_24H" -gt 5 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é »ç¹ãªèªè¨¼ã‚¨ãƒ©ãƒ¼ (24æ™‚é–“ã§${AUTH_ERRORS_24H}ä»¶, -10ç‚¹)"
fi

# ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚³ãƒ³ãƒ†ãƒŠã«ã‚ˆã‚‹æ¸›ç‚¹
ERROR_COUNT=$(echo "$ERROR_CONTAINERS" | wc -w)
if [ "$ERROR_COUNT" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - ERROR_COUNT * 15))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹: ${ERROR_COUNT}å€‹ (-$((ERROR_COUNT * 15))ç‚¹)"
fi

# API ã‚¨ãƒ©ãƒ¼é »åº¦ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆé•·æœŸå±¥æ­´è€ƒæ…®ï¼‰
if [ "$API_ERRORS_30M" -gt 10 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 20))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é«˜é »åº¦APIã‚¨ãƒ©ãƒ¼ (30åˆ†ã§${API_ERRORS_30M}ä»¶, -20ç‚¹)"
elif [ "$API_ERRORS_12H" -gt 50 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - APIã‚¨ãƒ©ãƒ¼ç´¯ç© (12æ™‚é–“ã§${API_ERRORS_12H}ä»¶, -10ç‚¹)"
fi

# ç·ã‚¨ãƒ©ãƒ¼æ•°ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆ24æ™‚é–“ï¼‰
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 15))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é«˜ã‚¨ãƒ©ãƒ¼é »åº¦ (24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶, -15ç‚¹)"
elif [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 8))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ä¸­ç¨‹åº¦ã‚¨ãƒ©ãƒ¼é »åº¦ (24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶, -8ç‚¹)"
fi

# é‡è¦ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹æ¸›ç‚¹
if [ "$CRITICAL_ERRORS_24H" -gt 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - CRITICAL_ERRORS_24H * 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - é‡è¦ã‚¨ãƒ©ãƒ¼: ${CRITICAL_ERRORS_24H}ä»¶ (-$((CRITICAL_ERRORS_24H * 10))ç‚¹)"
fi

# é€²æ—ç‡ã«ã‚ˆã‚‹è©•ä¾¡
if [ "$TOTAL_TARGETS" -gt 0 ]; then
    OVERALL_COMPLETION_INT=$(echo "$OVERALL_COMPLETION" | cut -d. -f1)
    if [ "$OVERALL_COMPLETION_INT" -lt 50 ]; then
        HEALTH_SCORE=$((HEALTH_SCORE - 10))
        HEALTH_ISSUES="${HEALTH_ISSUES}\n  - å…¨ä½“é€²æ—ç‡ä½ä¸‹ (-10ç‚¹)"
    fi
fi

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹æ¸›ç‚¹
if [ "$NETWORK_ERRORS_1H" -gt 5 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
    HEALTH_ISSUES="${HEALTH_ISSUES}\n  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®š (1æ™‚é–“ã§${NETWORK_ERRORS_1H}ä»¶, -10ç‚¹)"
fi

echo "ğŸ¯ Overall Health Score: ${HEALTH_SCORE}/100"
if [ -n "$HEALTH_ISSUES" ]; then
    echo "ğŸ“‹ Health Issues:"
    echo -e "$HEALTH_ISSUES"
fi

# å¥åº·åº¦ã«åŸºã¥ãç·åˆåˆ¤å®š
if [ "$HEALTH_SCORE" -ge 80 ]; then
    echo "âœ… System Status: EXCELLENT"
elif [ "$HEALTH_SCORE" -ge 60 ]; then
    echo "âš ï¸ System Status: GOOD (è¦ç›£è¦–)"
elif [ "$HEALTH_SCORE" -ge 40 ]; then
    echo "ğŸ”¶ System Status: FAIR (è¦æ³¨æ„)"
else
    echo "ğŸš¨ System Status: POOR (è¦å¯¾å¿œ)"
fi

# 13. æœ€é©åŒ–ææ¡ˆ
echo
echo "ğŸ’¡ OPTIMIZATION RECOMMENDATIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ”§ Specific Recommendations:"

# ã‚¨ãƒ©ãƒ¼åœæ­¢ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®å¯¾å¿œææ¡ˆ
if [ -n "$ERROR_CONTAINERS" ]; then
    echo "  1. ğŸ”´ Immediate Actions for Error Containers:"
    for error_container in $ERROR_CONTAINERS; do
        SERVICE_NAME=$(echo $error_container | sed 's/bulk-block-users-//' | sed 's/-1$//')
        echo "     - $SERVICE_NAME: Cookieæ›´æ–°ã¨ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ã‚’æ¨å¥¨"
    done
fi

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ææ¡ˆ
if [ "$TOTAL_TARGETS" -gt 0 ] && [ "$OVERALL_COMPLETION_INT" -lt 80 ]; then
    echo "  2. âš¡ Performance Improvements:"
    echo "     - ä¸¦åˆ—å‡¦ç†æ•°ã®å¢—åŠ ã‚’æ¤œè¨"
    echo "     - ãƒãƒƒãƒã‚µã‚¤ã‚ºã®æœ€é©åŒ–"
    echo "     - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®èª¿æ•´"
fi

# é•·æœŸã‚¨ãƒ©ãƒ¼å±¥æ­´ã«åŸºã¥ãè¿½åŠ ææ¡ˆ
if [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    echo "  2. ğŸ” Long-term Error Analysis Recommendations:"
    echo "     - ã‚ˆã‚Šè©³ç´°ãªãƒ­ã‚°ä¿å­˜æœŸé–“ã®å»¶é•·ã‚’æ¤œè¨"
    echo "     - ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ„ãƒ¼ãƒ«å°å…¥"
    echo "     - è‡ªå‹•ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…"
fi

if [ "$AUTH_ERRORS_24H" -gt 10 ]; then
    echo "  3. ğŸ” Authentication Stability Improvements:"
    echo "     - Cookieè‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…"
    echo "     - è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼æ©Ÿèƒ½"
    echo "     - èªè¨¼çŠ¶æ…‹ã®å®šæœŸçš„ãªæ¤œè¨¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"
fi

# ç›£è¦–å¼·åŒ–ã®ææ¡ˆï¼ˆé•·æœŸå±¥æ­´å¯¾å¿œç‰ˆï¼‰
echo "  4. ğŸ“Š Enhanced Long-term Monitoring:"
echo "     - 24æ™‚é–“ã‚¨ãƒ©ãƒ¼å±¥æ­´ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"
echo "     - é€±æ¬¡ãƒ»æœˆæ¬¡ã‚¨ãƒ©ãƒ¼å‚¾å‘ãƒ¬ãƒãƒ¼ãƒˆ"
echo "     - äºˆæ¸¬çš„ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¨ãƒ©ãƒ¼å¢—åŠ å‚¾å‘ã®æ—©æœŸæ¤œå‡ºï¼‰"
echo "     - ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®è¦‹ç›´ã—"

# ã‚¨ãƒ©ãƒ¼è¦‹è½ã¨ã—é˜²æ­¢ã®å…·ä½“çš„å¯¾ç­–
echo "  5. ğŸ›¡ï¸ Error Detection Risk Mitigation:"
echo "     - è¤‡æ•°æ™‚é–“ç¯„å›²ã§ã®ã‚¯ãƒ­ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆå½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè£…æ¸ˆã¿ï¼‰"
echo "     - é‡è¦ã‚¨ãƒ©ãƒ¼ã®å³åº§é€šçŸ¥æ©Ÿèƒ½"
echo "     - å®šæœŸçš„ãªå…¨ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé€±æ¬¡æ¨å¥¨ï¼‰"
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "     - ğŸš¨ é«˜ã‚¨ãƒ©ãƒ¼é »åº¦ã«ã¤ãã€è©³ç´°ãªãƒ­ã‚°åˆ†æã‚’æ¨å¥¨"
    echo "       ã‚³ãƒãƒ³ãƒ‰: .claude/cinnamon-logs-ai-optimized.sh"
fi

echo
echo "=== COMPREHENSIVE CHECK COMPLETE (é•·æœŸå±¥æ­´å¯¾å¿œç‰ˆ) ==="
echo "Analysis timeframe: 24 hours (èªè¨¼ãƒ»APIãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®åŒ…æ‹¬çš„åˆ†æ)"
echo "Next check recommended: $(date -d '+5 minutes' '+%H:%M')"
echo "Health Score: ${HEALTH_SCORE}/100"

# ã‚¨ãƒ©ãƒ¼è¦‹è½ã¨ã—ãƒªã‚¹ã‚¯ç·åˆè©•ä¾¡ã®è¡¨ç¤º
echo
echo "ğŸ” ERROR DETECTION COVERAGE ASSESSMENT:"
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "  ğŸ”´ HIGH COVERAGE REQUIRED: éå»24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
    echo "     è©³ç´°åˆ†ææ¨å¥¨: .claude/cinnamon-logs-ai-optimized.sh"
elif [ "$TOTAL_ERRORS_24H" -gt 20 ]; then
    echo "  ğŸŸ¡ MEDIUM COVERAGE: éå»24æ™‚é–“ã§${TOTAL_ERRORS_24H}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
    echo "     å®šæœŸç›£è¦–ç¶™ç¶šä¸­ï¼ˆ5åˆ†é–“éš”æ¨å¥¨ï¼‰"
else
    echo "  ğŸŸ¢ ADEQUATE COVERAGE: ã‚¨ãƒ©ãƒ¼é »åº¦ã¯è¨±å®¹ç¯„å›²å†…"
    echo "     ç¾åœ¨ã®ç›£è¦–ãƒ¬ãƒ™ãƒ«ã§ååˆ†"
fi

echo "ğŸ“Š Monitoring coverage:"
echo "  â€¢ èªè¨¼ã‚¨ãƒ©ãƒ¼: 5åˆ†ã€œ24æ™‚é–“ã®æ™‚ç³»åˆ—åˆ†æ"
echo "  â€¢ APIã‚¨ãƒ©ãƒ¼: 30åˆ†ã€œ12æ™‚é–“ã®å‚¾å‘åˆ†æ"
echo "  â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: 1æ™‚é–“ã€œ12æ™‚é–“ã®å±¥æ­´ãƒã‚§ãƒƒã‚¯"
echo "  â€¢ ç·åˆã‚¨ãƒ©ãƒ¼: 24æ™‚é–“ã®åŒ…æ‹¬çš„åˆ†æ"
echo
echo "ğŸ“‹ For detailed technical analysis and code fixes:"
echo "  .claude/cinnamon-logs-ai-optimized.sh"

# 14. ã‚¹ã‚¯ãƒªãƒ—ãƒˆè‡ªå·±æ”¹å–„ã®ãŸã‚ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åé›†
echo
echo "ğŸ”„ SCRIPT IMPROVEMENT METADATA"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å®Ÿè¡Œæ™‚é–“ã®æ¸¬å®š
SCRIPT_END_TIME=$(date +%s)
SCRIPT_EXECUTION_TIME=$((SCRIPT_END_TIME - SCRIPT_START_TIME))
echo "ğŸ“Š Script Execution Metadata:"
echo "  â€¢ Execution time: ${SCRIPT_EXECUTION_TIME}s"
echo "  â€¢ Total containers analyzed: $TOTAL_CONTAINERS"
echo "  â€¢ Error detection coverage: 24 hours"
echo "  â€¢ SSH connections made: ~$((TOTAL_CONTAINERS * 3 + 10))"

# æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã®åˆ†é¡ã¨ã‚«ã‚¦ãƒ³ãƒˆ
DETECTED_ISSUES=0
IMPROVEMENT_OPPORTUNITIES=""

if [ "$AUTH_ERRORS_24H" -gt 0 ]; then
    DETECTED_ISSUES=$((DETECTED_ISSUES + 1))
    IMPROVEMENT_OPPORTUNITIES="${IMPROVEMENT_OPPORTUNITIES}\n  - èªè¨¼ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ©Ÿèƒ½ã®ç²¾åº¦å‘ä¸Š"
fi

if [ "$TOTAL_ERRORS_24H" -gt 50 ]; then
    DETECTED_ISSUES=$((DETECTED_ISSUES + 1))
    IMPROVEMENT_OPPORTUNITIES="${IMPROVEMENT_OPPORTUNITIES}\n  - ã‚¨ãƒ©ãƒ¼åˆ†é¡æ©Ÿèƒ½ã®å¼·åŒ–"
fi

if [ "$ERROR_COUNT" -gt 0 ]; then
    DETECTED_ISSUES=$((DETECTED_ISSUES + 1))
    IMPROVEMENT_OPPORTUNITIES="${IMPROVEMENT_OPPORTUNITIES}\n  - åœæ­¢ç†ç”±åˆ†æã®è©³ç´°åŒ–"
fi

# åˆ†æåŠ¹æœã®è©•ä¾¡
echo "  â€¢ Issues detected: $DETECTED_ISSUES types"
echo "  â€¢ Health score accuracy: ${HEALTH_SCORE}/100"

# æ¬¡å›å®Ÿè¡Œã«å‘ã‘ãŸæ”¹å–„ææ¡ˆ
echo
echo "ğŸ’¡ SCRIPT IMPROVEMENT RECOMMENDATIONS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ”§ Recommended enhancements for next execution:"

# å®Ÿè¡Œæ™‚é–“ã«ã‚ˆã‚‹æ”¹å–„ææ¡ˆ
if [ "$SCRIPT_EXECUTION_TIME" -gt 30 ]; then
    echo "  1. âš¡ Performance optimization needed:"
    echo "     - Parallelize SSH connections"
    echo "     - Cache Docker container lists"
    echo "     - Optimize log parsing patterns"
fi

# ã‚¨ãƒ©ãƒ¼æ¤œå‡ºç²¾åº¦ã«ã‚ˆã‚‹æ”¹å–„ææ¡ˆ
if [ "$TOTAL_ERRORS_24H" -gt 100 ]; then
    echo "  2. ğŸ” Enhanced error detection needed:"
    echo "     - Add more specific error patterns"
    echo "     - Implement error clustering algorithm"
    echo "     - Add predictive error analysis"
fi

# å¥åº·åº¦ã‚¹ã‚³ã‚¢ç²¾åº¦ã«ã‚ˆã‚‹æ”¹å–„ææ¡ˆ
if [ "$HEALTH_SCORE" -lt 50 ]; then
    echo "  3. ğŸ“Š Health scoring refinement needed:"
    echo "     - Adjust weight factors for critical issues"
    echo "     - Add recovery time estimation"
    echo "     - Implement trend-based scoring"
fi

# æ–°æ©Ÿèƒ½è¿½åŠ ã®ææ¡ˆ
echo "  4. ğŸ†• New features to consider:"
if [ "$DETECTED_ISSUES" -gt 2 ]; then
    echo "     - Automated issue correlation analysis"
    echo "     - Real-time alerting integration"
    echo "     - Historical trend visualization"
fi

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ã‚°å‡ºåŠ›ï¼ˆå°†æ¥ã®åˆ†æç”¨ï¼‰
METADATA_LOG="/tmp/check-cinnamon-metadata-$(date +%Y%m%d-%H%M%S).json"
HISTORY_LOG="/tmp/check-cinnamon-history.jsonl"

# ç¾åœ¨ã®å®Ÿè¡Œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
cat > "$METADATA_LOG" << EOF
{
  "timestamp": "$(date -Iseconds)",
  "execution_time": $SCRIPT_EXECUTION_TIME,
  "containers_analyzed": $TOTAL_CONTAINERS,
  "auth_errors_24h": $AUTH_ERRORS_24H,
  "total_errors_24h": $TOTAL_ERRORS_24H,
  "health_score": $HEALTH_SCORE,
  "issues_detected": $DETECTED_ISSUES,
  "running_containers": $RUNNING_COUNT,
  "stopped_containers": $STOPPED_COUNT,
  "error_containers": $ERROR_COUNT,
  "improvement_opportunities": [$([[ "$SCRIPT_EXECUTION_TIME" -gt 30 ]] && echo '"performance",' || echo '')$([[ "$TOTAL_ERRORS_24H" -gt 100 ]] && echo '"error_detection",' || echo '')$([[ "$HEALTH_SCORE" -lt 50 ]] && echo '"health_scoring"' || echo '')]
}
EOF

# å±¥æ­´ãƒ­ã‚°ã¸ã®è¿½åŠ ï¼ˆJSONLå½¢å¼ï¼‰
echo "{\"timestamp\":\"$(date -Iseconds)\",\"execution_time\":$SCRIPT_EXECUTION_TIME,\"health_score\":$HEALTH_SCORE,\"total_errors\":$TOTAL_ERRORS_24H,\"auth_errors\":$AUTH_ERRORS_24H}" >> "$HISTORY_LOG"

# å±¥æ­´åˆ†æï¼ˆæœ€è¿‘10å›ã®å®Ÿè¡Œãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰
if [ -f "$HISTORY_LOG" ]; then
    RECENT_RUNS=$(tail -10 "$HISTORY_LOG" | wc -l)
    if [ "$RECENT_RUNS" -gt 3 ]; then
        echo "  ğŸ“ˆ Trend Analysis (last $RECENT_RUNS runs):"
        
        # jqãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        if command -v jq >/dev/null 2>&1; then
            # å®Ÿè¡Œæ™‚é–“ã®ãƒˆãƒ¬ãƒ³ãƒ‰
            AVG_EXEC_TIME=$(tail -10 "$HISTORY_LOG" | jq -r '.execution_time' | awk '{sum+=$1} END {print int(sum/NR)}' 2>/dev/null || echo "0")
            echo "     - Average execution time: ${AVG_EXEC_TIME}s (current: ${SCRIPT_EXECUTION_TIME}s)"
            
            # ãƒ˜ãƒ«ã‚¹ã‚³ã‚¢ã®ãƒˆãƒ¬ãƒ³ãƒ‰
            AVG_HEALTH=$(tail -10 "$HISTORY_LOG" | jq -r '.health_score' | awk '{sum+=$1} END {print int(sum/NR)}' 2>/dev/null || echo "0")
            echo "     - Average health score: ${AVG_HEALTH}/100 (current: ${HEALTH_SCORE}/100)"
            
            # æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰ã®åˆ¤å®š
            if [ "$AVG_EXEC_TIME" -gt 0 ] && [ "$SCRIPT_EXECUTION_TIME" -lt "$AVG_EXEC_TIME" ]; then
                echo "     - âœ… Execution time is improving"
            elif [ "$AVG_EXEC_TIME" -gt 0 ] && [ "$SCRIPT_EXECUTION_TIME" -gt $((AVG_EXEC_TIME + 10)) ]; then
                echo "     - âš ï¸ Execution time is degrading"
            fi
            
            if [ "$AVG_HEALTH" -gt 0 ] && [ "$HEALTH_SCORE" -gt "$AVG_HEALTH" ]; then
                echo "     - âœ… System health is improving"
            elif [ "$AVG_HEALTH" -gt 0 ] && [ "$HEALTH_SCORE" -lt $((AVG_HEALTH - 10)) ]; then
                echo "     - âš ï¸ System health is degrading"
            fi
        else
            # jqãŒç„¡ã„å ´åˆã®ç°¡æ˜“åˆ†æ
            echo "     - Historical data available ($RECENT_RUNS runs)"
            echo "     - Install 'jq' for detailed trend analysis"
            
            # æœ€æ–°ã®æ•°å€¤ã¨ã®æ¯”è¼ƒ
            LAST_HEALTH=$(tail -2 "$HISTORY_LOG" | head -1 | grep -o '"health_score":[0-9]*' | cut -d: -f2)
            if [ -n "$LAST_HEALTH" ] && [ "$HEALTH_SCORE" -gt "$LAST_HEALTH" ]; then
                echo "     - âœ… Health score improved from last run ($LAST_HEALTH â†’ $HEALTH_SCORE)"
            elif [ -n "$LAST_HEALTH" ] && [ "$HEALTH_SCORE" -lt "$LAST_HEALTH" ]; then
                echo "     - âš ï¸ Health score decreased from last run ($LAST_HEALTH â†’ $HEALTH_SCORE)"
            fi
        fi
    fi
fi

echo "  5. ğŸ“ˆ Performance tracking:"
echo "     - Metadata logged to: $METADATA_LOG"
echo "     - Historical analysis data available for trend detection"

# è‡ªå·±æ”¹å–„ã®å®Ÿè¡Œææ¡ˆ
echo
echo "ğŸš€ AUTO-IMPROVEMENT EXECUTION PLAN:"

# ç·Šæ€¥æ”¹å–„ãŒå¿…è¦ãªå ´åˆã®è‡ªå‹•ææ¡ˆ
AUTO_IMPROVEMENT_NEEDED=false

if [ "$SCRIPT_EXECUTION_TIME" -gt 60 ]; then
    echo "  ğŸš¨ URGENT: Performance optimization needed (execution time: ${SCRIPT_EXECUTION_TIME}s)"
    AUTO_IMPROVEMENT_NEEDED=true
fi

if [ "$HEALTH_SCORE" -lt 30 ]; then
    echo "  ğŸš¨ URGENT: Health scoring algorithm needs recalibration (score: ${HEALTH_SCORE}/100)"
    AUTO_IMPROVEMENT_NEEDED=true
fi

if [ "$TOTAL_ERRORS_24H" -gt 200 ]; then
    echo "  ğŸš¨ URGENT: Error detection enhancement needed (${TOTAL_ERRORS_24H} errors in 24h)"
    AUTO_IMPROVEMENT_NEEDED=true
fi

if [ "$AUTO_IMPROVEMENT_NEEDED" = true ]; then
    echo "  âš¡ High-priority improvements recommended. Run immediately:"
    echo "    /project:debug-issue \"check-cinnamon ç·Šæ€¥æ€§èƒ½æ”¹å–„: å®Ÿè¡Œæ™‚é–“${SCRIPT_EXECUTION_TIME}s, ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢${HEALTH_SCORE}/100\""
else
    echo "  ğŸ“ˆ Standard improvements available. Run when convenient:"
    echo "    /project:debug-issue \"check-cinnamon ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ€§èƒ½æœ€é©åŒ–ã¨æ©Ÿèƒ½å¼·åŒ–\""
fi

# è‡ªå‹•æ”¹å–„å±¥æ­´ã®è¨˜éŒ²
IMPROVEMENT_LOG="/tmp/check-cinnamon-improvements.log"
echo "$(date -Iseconds): execution_time=${SCRIPT_EXECUTION_TIME}s, health_score=${HEALTH_SCORE}/100, auto_improvement_needed=${AUTO_IMPROVEMENT_NEEDED}" >> "$IMPROVEMENT_LOG"

echo
echo "ğŸ“ This metadata will be used to enhance the script for future executions."
echo "ğŸ“Š Improvement tracking log: $IMPROVEMENT_LOG"

# å®Ÿè¡Œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚ã‚µãƒãƒªãƒ¼
echo
echo "ğŸ” NEXT EXECUTION ENHANCEMENT TARGETS:"
echo "  â€¢ Target execution time: <20s (current: ${SCRIPT_EXECUTION_TIME}s)"
echo "  â€¢ Target health score accuracy: >90% confidence"
echo "  â€¢ Target error detection: 48h historical coverage"
echo "  â€¢ Target SSH optimization: 50% fewer connections"

# æˆåŠŸæŒ‡æ¨™ã«åŸºã¥ãæ”¹å–„ææ¡ˆ
if [ "$SCRIPT_EXECUTION_TIME" -lt 15 ] && [ "$HEALTH_SCORE" -gt 80 ] && [ "$TOTAL_ERRORS_24H" -lt 20 ]; then
    echo "  âœ… EXCELLENT: Script performance meets all targets"
    echo "  ğŸ¯ Consider adding advanced features: predictive analysis, automated remediation"
fi