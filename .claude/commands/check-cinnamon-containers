#!/bin/bash

# check-cinnamon-containers - ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹åˆ†æå°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

set -e

BRIEF=false

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        --brief|-b)
            BRIEF=true
            shift
            ;;
        *)
            shift
            ;;
    esac
done

if [ "$BRIEF" = false ]; then
    echo "ğŸ“Š CONTAINER STATUS DETAILED ANALYSIS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
fi

# ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹åˆ†æ
if [ "$BRIEF" = true ]; then
    echo "ğŸ” ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹:"
else
    echo "ğŸ” Container Status (ç¨¼åƒä¸­/åœæ­¢ä¸­ã®è©³ç´°åˆ†æ):"
fi

# ç¨¼åƒä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠ
RUNNING_CONTAINERS=$(ssh Cinnamon "docker ps --filter 'name=bulk-block-users' --format '{{.Names}} {{.Status}} {{.State}}'")
STOPPED_CONTAINERS=$(ssh Cinnamon "docker ps -a --filter 'name=bulk-block-users' --filter 'status=exited' --format '{{.Names}} {{.Status}}'")

if [ -n "$RUNNING_CONTAINERS" ]; then
    if [ "$BRIEF" = true ]; then
        echo "âœ… ç¨¼åƒä¸­ã‚³ãƒ³ãƒ†ãƒŠ:"
        echo "$RUNNING_CONTAINERS" | while read name status state; do
            echo "  - $name ($status)"
        done
    else
        echo "NAMES                              STATUS                 STATE"
        echo "$RUNNING_CONTAINERS" | while read name status state; do
            printf "%-34s %-22s %s\n" "$name" "$status" "$state"
        done
        
        echo ""
        echo "âœ… Running Containers:"
        echo "$RUNNING_CONTAINERS" | while read name status state; do
            echo "  - $name"
        done
    fi
else
    echo "âŒ ç¨¼åƒä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
fi

# åœæ­¢ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠ
if [ -n "$STOPPED_CONTAINERS" ]; then
    if [ "$BRIEF" = true ]; then
        echo "ğŸ”´ åœæ­¢ä¸­ã‚³ãƒ³ãƒ†ãƒŠ:"
        echo "$STOPPED_CONTAINERS" | while read name status; do
            echo "  - $name ($status)"
        done
    else
        echo "ğŸ”´ Stopped Containers:"
        echo "$STOPPED_CONTAINERS" | while read name status; do
            echo "  - $name ($status)"
        done
    fi
else
    if [ "$BRIEF" = false ]; then
        echo "ğŸ”´ Stopped Containers:"
        echo "  - None"
    fi
fi

# ç¨¼åƒæ™‚é–“ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åˆ†æï¼ˆè©³ç´°ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯3æ™‚é–“ä»¥ä¸Šç¨¼åƒæ™‚ï¼‰
if [ -n "$RUNNING_CONTAINERS" ]; then
    # æœ€åˆã®ã‚³ãƒ³ãƒ†ãƒŠã®ç¨¼åƒæ™‚é–“ã‚’å–å¾—
    FIRST_CONTAINER=$(echo "$RUNNING_CONTAINERS" | head -1 | awk '{print $1}')
    UPTIME_STATUS=$(echo "$RUNNING_CONTAINERS" | head -1 | awk '{print $2}')
    
    # ç¨¼åƒæ™‚é–“ã‹ã‚‰ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åˆ¤å®š
    if [[ "$UPTIME_STATUS" =~ "hour" ]]; then
        HOURS=$(echo "$UPTIME_STATUS" | grep -o '[0-9]\+' | head -1)
        
        if [ "$BRIEF" = false ] || [ "$HOURS" -ge 3 ]; then
            echo ""
            if [ "$BRIEF" = true ]; then
                echo "ğŸ† ç¨¼åƒãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³:"
            else
                echo "ğŸ† UPTIME MILESTONES ANALYSIS:"
            fi
            
            if [ "$HOURS" -ge 6 ]; then
                MILESTONE="ğŸ–ï¸ 6æ™‚é–“+ ULTRA-STABLE"
                QUALITY="ULTRA-STABLE"
            elif [ "$HOURS" -ge 3 ]; then
                MILESTONE="ğŸ† 3æ™‚é–“+ LONG-TERM"
                QUALITY="LONG-TERM"
            elif [ "$HOURS" -ge 2 ]; then
                MILESTONE="ğŸ† 2æ™‚é–“+ ENTERPRISE"
                QUALITY="ENTERPRISE"
            elif [ "$HOURS" -ge 1 ]; then
                MILESTONE="âœ… 1æ™‚é–“+ STABLE"
                QUALITY="STABLE"
            else
                MILESTONE="ğŸ“Š 1æ™‚é–“æœªæº€"
                QUALITY="TESTING"
            fi
            
            if [ "$BRIEF" = true ]; then
                echo "  $MILESTONE"
            else
                echo "â±ï¸ ç¾åœ¨ã®ç¨¼åƒæ™‚é–“: $UPTIME_STATUS"
                echo "ğŸ† ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³: $MILESTONE"
                echo "ğŸ“Š å“è³ªãƒ¬ãƒ™ãƒ«: $QUALITY"
            fi
        fi
    fi
fi

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çŠ¶æ³ï¼ˆè©³ç´°ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
if [ "$BRIEF" = false ] && [ -n "$RUNNING_CONTAINERS" ]; then
    echo ""
    echo "ğŸ¥ Health Check Status:"
    
    HEALTHY_COUNT=0
    UNHEALTHY_COUNT=0
    
    echo "$RUNNING_CONTAINERS" | while read name status state; do
        if [[ "$status" =~ "healthy" ]]; then
            echo "  âœ… $name: healthy"
            HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
        elif [[ "$status" =~ "unhealthy" ]]; then
            echo "  âŒ $name: unhealthy"
            UNHEALTHY_COUNT=$((UNHEALTHY_COUNT + 1))
        else
            echo "  â“ $name: health check not configured"
        fi
    done
fi