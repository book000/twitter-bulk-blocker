#!/bin/bash

# check-cinnamon-health-score - ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—æ©Ÿèƒ½
# è¤‡æ•°æ™‚é–“ç¯„å›²ã§ã®ã‚¨ãƒ©ãƒ¼åˆ†æã«åŸºã¥ãç·åˆå¥åº·åº¦ç®—å‡º

set -e

echo "ğŸ¥ SYSTEM HEALTH SCORE ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# SSHæ¥ç¶šç¢ºèª
if ! ssh -o ConnectTimeout=5 -o BatchMode=yes Cinnamon true 2>/dev/null; then
    echo "âŒ Cinnamonã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
fi

containers=("book000" "ihc_amot" "book000_vrc" "authorizedkey" "tomachi_priv" "tomarabbit")
total_health_score=0
container_count=${#containers[@]}

echo "ğŸ“Š CONTAINER-WISE HEALTH ANALYSIS:"
echo ""

for container in "${containers[@]}"; do
    container_name="bulk-block-users-${container}-1"
    
    # è¤‡æ•°æ™‚é–“ç¯„å›²ã§ã®ã‚¨ãƒ©ãƒ¼æ•°å–å¾—
    errors_1m=$(ssh Cinnamon "docker logs $container_name --since 1m 2>/dev/null | grep -E 'ğŸš¨.*403ã‚¨ãƒ©ãƒ¼.*å›æ¤œå‡º' | wc -l" 2>/dev/null || echo 0)
    errors_5m=$(ssh Cinnamon "docker logs $container_name --since 5m 2>/dev/null | grep -E 'ğŸš¨.*403ã‚¨ãƒ©ãƒ¼.*å›æ¤œå‡º' | wc -l" 2>/dev/null || echo 0)
    errors_10m=$(ssh Cinnamon "docker logs $container_name --since 10m 2>/dev/null | grep -E 'ğŸš¨.*403ã‚¨ãƒ©ãƒ¼.*å›æ¤œå‡º' | wc -l" 2>/dev/null || echo 0)
    errors_30m=$(ssh Cinnamon "docker logs $container_name --since 30m 2>/dev/null | grep -E 'ğŸš¨.*403ã‚¨ãƒ©ãƒ¼.*å›æ¤œå‡º' | wc -l" 2>/dev/null || echo 0)
    
    # æˆåŠŸãƒ»ãƒªã‚»ãƒƒãƒˆå‡¦ç†æ•°
    success_10m=$(ssh Cinnamon "docker logs $container_name --since 10m 2>/dev/null | grep -c 'âœ“.*ãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ'" 2>/dev/null || echo 0)
    reset_10m=$(ssh Cinnamon "docker logs $container_name --since 10m 2>/dev/null | grep -c 'ğŸ“‰.*ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ'" 2>/dev/null || echo 0)
    
    # æ•°å€¤æ¤œè¨¼
    [ -z "$errors_1m" ] && errors_1m=0
    [ -z "$errors_5m" ] && errors_5m=0
    [ -z "$errors_10m" ] && errors_10m=0
    [ -z "$errors_30m" ] && errors_30m=0
    [ -z "$success_10m" ] && success_10m=0
    [ -z "$reset_10m" ] && reset_10m=0
    
    # ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
    health_score=100
    
    # ã‚¨ãƒ©ãƒ¼æ•°ã«ã‚ˆã‚‹æ¸›ç‚¹
    if [ "$errors_1m" -gt 0 ]; then
        health_score=$((health_score - errors_1m * 10))  # 1åˆ†é–“ã‚¨ãƒ©ãƒ¼ã¯é‡å¤§
    fi
    if [ "$errors_5m" -gt 0 ]; then
        health_score=$((health_score - errors_5m * 2))   # 5åˆ†é–“ã‚¨ãƒ©ãƒ¼ã¯ä¸­ç¨‹åº¦
    fi
    if [ "$errors_10m" -gt 0 ]; then
        health_score=$((health_score - errors_10m * 1))  # 10åˆ†é–“ã‚¨ãƒ©ãƒ¼ã¯è»½å¾®
    fi
    
    # æˆåŠŸå‡¦ç†ã«ã‚ˆã‚‹åŠ ç‚¹
    if [ "$success_10m" -gt 10 ]; then
        health_score=$((health_score + 5))  # é«˜ã„æˆåŠŸç‡ã¯è‰¯å¥½
    fi
    
    # æœ€å°ãƒ»æœ€å¤§å€¤åˆ¶é™
    [ "$health_score" -lt 0 ] && health_score=0
    [ "$health_score" -gt 100 ] && health_score=100
    
    # ãƒ˜ãƒ«ã‚¹çŠ¶æ…‹åˆ¤å®š
    if [ "$health_score" -ge 90 ]; then
        status="ğŸŸ¢ EXCELLENT"
        recommendation="ç¶™ç¶šç›£è¦–"
    elif [ "$health_score" -ge 70 ]; then
        status="ğŸŸ¡ GOOD"
        recommendation="å®šæœŸãƒã‚§ãƒƒã‚¯"
    elif [ "$health_score" -ge 50 ]; then
        status="ğŸŸ  WARNING"
        recommendation="è©³ç´°åˆ†æå¿…è¦"
    elif [ "$health_score" -ge 20 ]; then
        status="ğŸ”´ CRITICAL"
        recommendation="å³åº§å¯¾å¿œå¿…è¦"
    else
        status="âš« FAILED"
        recommendation="ç·Šæ€¥å¯¾å¿œå¿…è¦"
    fi
    
    # çµæœè¡¨ç¤º
    printf "ğŸ“Š %-15s: %3dç‚¹ %s\n" "$container" "$health_score" "$status"
    printf "   ã‚¨ãƒ©ãƒ¼æ¨ç§»: 1åˆ†=%d, 5åˆ†=%d, 10åˆ†=%d, 30åˆ†=%d\n" "$errors_1m" "$errors_5m" "$errors_10m" "$errors_30m"
    printf "   æˆåŠŸå‡¦ç†: %dä»¶ (10åˆ†é–“), æ¨å¥¨: %s\n" "$success_10m" "$recommendation"
    
    # æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
    if [ "$errors_1m" -eq 0 ] && [ "$errors_5m" -eq 0 ] && [ "$errors_10m" -eq 0 ]; then
        echo "   ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰: å®Œå…¨å®‰å®š - ã‚¨ãƒ©ãƒ¼ãªã—"
    elif [ "$errors_1m" -eq 0 ] && [ "$errors_5m" -eq 0 ]; then
        echo "   ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰: æ”¹å–„æ¸ˆã¿ - ç›´è¿‘5åˆ†ã§ã‚¨ãƒ©ãƒ¼åœæ­¢"
    elif [ "$errors_1m" -eq 0 ]; then
        echo "   ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰: æ”¹å–„ä¸­ - ç›´è¿‘1åˆ†ã§ã‚¨ãƒ©ãƒ¼åœæ­¢"
    elif [ "$errors_1m" -lt "$errors_5m" ]; then
        echo "   ğŸ“‰ ãƒˆãƒ¬ãƒ³ãƒ‰: æ‚ªåŒ–ä¸­ - ã‚¨ãƒ©ãƒ¼å¢—åŠ å‚¾å‘"
    else
        echo "   ğŸ”„ ãƒˆãƒ¬ãƒ³ãƒ‰: å¤‰å‹•ä¸­ - ç¶™ç¶šç›£è¦–å¿…è¦"
    fi
    
    echo ""
    
    total_health_score=$((total_health_score + health_score))
done

# å…¨ä½“ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—
overall_health=$((total_health_score / container_count))

echo "ğŸŒŸ OVERALL SYSTEM HEALTH"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
printf "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢: %d/100ç‚¹\n" "$overall_health"

if [ "$overall_health" -ge 90 ]; then
    echo "ğŸ‰ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: EXCELLENT - ã‚·ã‚¹ãƒ†ãƒ ã¯æœ€é©ãªçŠ¶æ…‹ã§ç¨¼åƒä¸­"
    echo "ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ç¾çŠ¶ç¶­æŒãƒ»å®šæœŸç›£è¦–ç¶™ç¶š"
elif [ "$overall_health" -ge 70 ]; then
    echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: GOOD - ã‚·ã‚¹ãƒ†ãƒ ã¯è‰¯å¥½ãªçŠ¶æ…‹"
    echo "ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ç¶™ç¶šç›£è¦–ãƒ»è»½å¾®ãªæœ€é©åŒ–æ¤œè¨"
elif [ "$overall_health" -ge 50 ]; then
    echo "âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: WARNING - æ³¨æ„ãŒå¿…è¦ãªçŠ¶æ…‹"
    echo "ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: è©³ç´°åˆ†æãƒ»äºˆé˜²çš„æªç½®å®Ÿæ–½"
elif [ "$overall_health" -ge 20 ]; then
    echo "ğŸš¨ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: CRITICAL - ç·Šæ€¥å¯¾å¿œãŒå¿…è¦"
    echo "ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: å³åº§ã®å•é¡Œè§£æ±ºãƒ»ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•æ¤œè¨"
else
    echo "ğŸ’¥ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: SYSTEM FAILURE - ã‚·ã‚¹ãƒ†ãƒ éšœå®³çŠ¶æ…‹"
    echo "ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ç·Šæ€¥å¯¾å¿œãƒ»å…¨ä½“å†èµ·å‹•ãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
fi

echo ""
echo "ğŸ•’ ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ç®—å‡ºæ™‚é–“: $(date '+%H:%M:%S')"