#!/bin/bash

# check-cinnamon-fast - è¶…é«˜é€Ÿç‰ˆCinnamonã‚µãƒ¼ãƒãƒ¼ç›£è¦–ã‚³ãƒžãƒ³ãƒ‰
# ç›®æ¨™: 15ç§’ä»¥ä¸‹ã§ã®å®Ÿè¡Œå®Œäº†
# æœ€é©åŒ–: ä¸¦åˆ—å‡¦ç†ã€æœ€å°é™ã®å‡ºåŠ›ã€åŠ¹çŽ‡çš„ãªãƒ‡ãƒ¼ã‚¿åŽé›†

set -e

# é–‹å§‹æ™‚åˆ»è¨˜éŒ²
START_TIME=$(date +%s)

# ã‚«ãƒ©ãƒ¼å®šç¾©ï¼ˆæœ€å°é™ï¼‰
R='\033[0;31m'  # Red
G='\033[0;32m'  # Green
Y='\033[1;33m'  # Yellow
B='\033[0;34m'  # Blue
N='\033[0m'     # No Color

echo "=== CINNAMON FAST CHECK ==="
echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"

# SSHã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒžã‚¹ã‚¿ãƒ¼è¨­å®š
SSH_OPTS="-o ControlMaster=auto -o ControlPath=/tmp/ssh-cinnamon-%r@%h:%p -o ControlPersist=30s"

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§SSHæŽ¥ç¶šã‚’ç¢ºç«‹
ssh $SSH_OPTS Cinnamon "echo 'SSH ready'" >/dev/null 2>&1 &
SSH_PID=$!

# ä¸€æ‹¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
REMOTE_SCRIPT='
# ä¸¦åˆ—å®Ÿè¡Œã®ãŸã‚ã®é–¢æ•°å®šç¾©
get_containers() {
    echo "===CONTAINERS==="
    docker ps -a --filter "name=bulk-block-users" --format "{{.Names}}|{{.Status}}|{{.State}}"
}

get_errors() {
    echo "===ERRORS==="
    # æœ€æ–°ã®ã‚¨ãƒ©ãƒ¼ã®ã¿ï¼ˆé«˜é€ŸåŒ–ã®ãŸã‚æœ€æ–°10ä»¶ï¼‰
    find /var/log/supervisor -name "*.log" -mmin -60 -type f 2>/dev/null | while read log; do
        grep -E "(ERROR|CRITICAL|èªè¨¼ã‚¨ãƒ©ãƒ¼|Cookie|KeyError)" "$log" 2>/dev/null | tail -5
    done | tail -10
}

get_system() {
    echo "===SYSTEM==="
    echo "Load:$(uptime | awk -F"load average:" "{print \$2}")"
    echo "Mem:$(free -h | grep Mem | awk "{print \$3\"/\"\$2}")"
}

get_db_stats() {
    echo "===DB==="
    if [ -f /home/ope/twitter-bulk-blocker/blocker_data.db ]; then
        sqlite3 /home/ope/twitter-bulk-blocker/blocker_data.db "
        SELECT \"Users:\" || COUNT(*) || \"|Blocked:\" || SUM(CASE WHEN is_blocked = 1 THEN 1 ELSE 0 END) FROM users;
        " 2>/dev/null || echo "DB:Error"
    else
        echo "DB:NotFound"
    fi
}

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¸¦åˆ—å®Ÿè¡Œ
get_containers &
get_errors &
get_system &
get_db_stats &

# å…¨ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…æ©Ÿ
wait
'

# SSHæŽ¥ç¶šã®æº–å‚™å®Œäº†ã‚’å¾…ã¤
wait $SSH_PID 2>/dev/null || true

# ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆ1å›žã®SSHæŽ¥ç¶šã§å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
ALL_DATA=$(ssh $SSH_OPTS Cinnamon "$REMOTE_SCRIPT" 2>/dev/null)

# ãƒ‡ãƒ¼ã‚¿è§£æž
CONTAINERS=$(echo "$ALL_DATA" | awk '/===CONTAINERS===/{flag=1;next}/===/{flag=0}flag')
ERRORS=$(echo "$ALL_DATA" | awk '/===ERRORS===/{flag=1;next}/===/{flag=0}flag')
SYSTEM=$(echo "$ALL_DATA" | awk '/===SYSTEM===/{flag=1;next}/===/{flag=0}flag')
DB=$(echo "$ALL_DATA" | awk '/===DB===/{flag=1;next}/===/{flag=0}flag')

# 1. ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ï¼ˆæœ€é‡è¦æƒ…å ±ã®ã¿ï¼‰
echo -e "\n${B}ðŸ“Š CONTAINERS${N}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
RUNNING=$(echo "$CONTAINERS" | grep -c "Up " || true)
STOPPED=$(echo "$CONTAINERS" | grep -c "Exited" || true)
echo -e "Running: ${G}$RUNNING${N} | Stopped: ${R}$STOPPED${N}"

if [ $STOPPED -gt 0 ]; then
    echo -e "${R}âš ï¸ Stopped containers:${N}"
    echo "$CONTAINERS" | grep "Exited" | cut -d'|' -f1 | sed 's/^/  â€¢ /'
fi

# 2. ã‚¨ãƒ©ãƒ¼ã‚µãƒžãƒªï¼ˆã‚«ã‚¦ãƒ³ãƒˆã®ã¿ï¼‰
echo -e "\n${B}ðŸ” ERRORS (1h)${N}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -n "$ERRORS" ]; then
    AUTH=$(echo "$ERRORS" | grep -c "èªè¨¼ã‚¨ãƒ©ãƒ¼\|Cookie" || true)
    CODE=$(echo "$ERRORS" | grep -c "KeyError\|ValueError\|TypeError" || true)
    [ $AUTH -gt 0 ] && echo -e "${R}ðŸ”‘ Auth errors: $AUTH${N}"
    [ $CODE -gt 0 ] && echo -e "${R}ðŸ› Code errors: $CODE${N}"
    [ $AUTH -eq 0 ] && [ $CODE -eq 0 ] && echo -e "${G}âœ… No errors${N}"
else
    echo -e "${G}âœ… No errors${N}"
fi

# 3. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰
echo -e "\n${B}ðŸ’» SYSTEM${N}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "$SYSTEM" | tr '\n' ' '
echo

# 4. DBçµ±è¨ˆï¼ˆ1è¡Œè¡¨ç¤ºï¼‰
echo -e "\n${B}ðŸ“Š DATABASE${N}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "$DB"

# 5. ã‚¯ã‚¤ãƒƒã‚¯è¨ºæ–­
echo -e "\n${B}ðŸ DIAGNOSIS${N}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
STATUS="OK"
[ $STOPPED -gt 0 ] && STATUS="CRITICAL"
[ $AUTH -gt 5 ] 2>/dev/null && STATUS="WARNING"

case $STATUS in
    "OK") echo -e "${G}âœ… All systems operational${N}" ;;
    "WARNING") echo -e "${Y}âš ï¸ Attention required${N}" ;;
    "CRITICAL") echo -e "${R}ðŸš¨ Immediate action needed${N}" ;;
esac

# å®Ÿè¡Œæ™‚é–“
END_TIME=$(date +%s)
echo -e "\nâ±ï¸ Execution time: $((END_TIME - START_TIME))s"

# SSHæŽ¥ç¶šã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
ssh -O exit $SSH_OPTS Cinnamon 2>/dev/null || true