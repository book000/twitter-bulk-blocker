#!/bin/bash

# monitor-releases - GitHubæ–°è¦ãƒªãƒªãƒ¼ã‚¹ç›£è¦–ã¨è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
#
# æ©Ÿèƒ½:
# - GitHub APIã§æ–°è¦ãƒªãƒªãƒ¼ã‚¹ã‚’ç¶™ç¶šç›£è¦–
# - æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹æ¤œå‡ºæ™‚ã®è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
# - ãƒ­ã‚°è¨˜éŒ²ã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½
# - ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªç›£è¦–é–“éš”ã¨å‹•ä½œè¨­å®š

set -e

echo "=== GITHUB RELEASE MONITORING SYSTEM ==="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo

# è¨­å®š
GITHUB_REPO="book000/twitter-bulk-blocker"
GITHUB_API_URL="https://api.github.com/repos/$GITHUB_REPO/releases/latest"
STATE_FILE="/tmp/twitter-bulk-blocker-release-monitor.state"
LOG_FILE="/tmp/twitter-bulk-blocker-release-monitor.log"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
CHECK_INTERVAL=300  # 5åˆ†é–“éš”
MAX_DURATION=3600   # 1æ™‚é–“ã§çµ‚äº†
AUTO_UPDATE=false   # è‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹ã‹
DRY_RUN=false      # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
VERBOSE=false      # è©³ç´°ãƒ­ã‚°
ALERT_ONLY=false   # ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ï¼ˆæ›´æ–°å®Ÿè¡Œãªã—ï¼‰
ONE_SHOT=false     # 1å›ã ã‘å®Ÿè¡Œ

while [[ $# -gt 0 ]]; do
    case $1 in
        --interval)
            CHECK_INTERVAL="$2"
            shift 2
            ;;
        --duration)
            MAX_DURATION="$2"
            shift 2
            ;;
        --auto-update)
            AUTO_UPDATE=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --alert-only)
            ALERT_ONLY=true
            shift
            ;;
        --one-shot)
            ONE_SHOT=true
            shift
            ;;
        --state-file)
            STATE_FILE="$2"
            shift 2
            ;;
        --log-file)
            LOG_FILE="$2"
            shift 2
            ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --interval N        ãƒã‚§ãƒƒã‚¯é–“éš”ï¼ˆç§’ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 300ï¼‰"
            echo "  --duration N        æœ€å¤§ç›£è¦–æ™‚é–“ï¼ˆç§’ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3600ï¼‰"
            echo "  --auto-update       æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡ºæ™‚ã«è‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œ"
            echo "  --dry-run           ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ›´æ–°ã¯å®Ÿè¡Œã—ãªã„ï¼‰"
            echo "  --verbose           è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º"
            echo "  --alert-only        ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ï¼ˆæ›´æ–°ã¯å®Ÿè¡Œã—ãªã„ï¼‰"
            echo "  --one-shot          1å›ã ã‘ãƒã‚§ãƒƒã‚¯ã—ã¦çµ‚äº†"
            echo "  --state-file FILE   çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"
            echo "  --log-file FILE     ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"
            echo "  --help              ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  $0                          # åŸºæœ¬ç›£è¦–ï¼ˆ5åˆ†é–“éš”ã€1æ™‚é–“ï¼‰"
            echo "  $0 --auto-update            # è‡ªå‹•æ›´æ–°ä»˜ãç›£è¦–"
            echo "  $0 --interval 60            # 1åˆ†é–“éš”ã§ãƒã‚§ãƒƒã‚¯"
            echo "  $0 --one-shot               # 1å›ã ã‘ãƒã‚§ãƒƒã‚¯"
            echo "  $0 --dry-run --verbose      # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰"
            exit 0
            ;;
        *)
            echo "âŒ ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            echo "ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º: $0 --help"
            exit 1
            ;;
    esac
done

# ãƒ­ã‚°é–¢æ•°
log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local log_entry="[$timestamp] [$level] $message"
    
    echo "$log_entry"
    echo "$log_entry" >> "$LOG_FILE"
    
    if [ "$VERBOSE" = true ] || [ "$level" = "ERROR" ] || [ "$level" = "ALERT" ]; then
        echo "$log_entry" >&2
    fi
}

# ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
get_current_release() {
    local api_response=$(timeout 30 curl -s "$GITHUB_API_URL" 2>/dev/null || echo "")
    
    if [ -z "$api_response" ] || [[ "$api_response" == *"rate limit"* ]] || [[ "$api_response" == *"Not Found"* ]]; then
        log_message "ERROR" "GitHub APIå–å¾—å¤±æ•—"
        return 1
    fi
    
    local tag_name=$(echo "$api_response" | grep '"tag_name"' | cut -d'"' -f4)
    local published_at=$(echo "$api_response" | grep '"published_at"' | cut -d'"' -f4)
    
    if [ -z "$tag_name" ]; then
        log_message "ERROR" "ãƒªãƒªãƒ¼ã‚¹æƒ…å ±è§£æå¤±æ•—"
        return 1
    fi
    
    echo "${tag_name}|${published_at}"
    return 0
}

# çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
load_state() {
    if [ -f "$STATE_FILE" ]; then
        cat "$STATE_FILE"
    else
        echo ""
    fi
}

# çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜
save_state() {
    local state="$1"
    echo "$state" > "$STATE_FILE"
    log_message "INFO" "çŠ¶æ…‹ä¿å­˜: $state"
}

# æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡ºæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
execute_update_action() {
    local new_tag="$1"
    local published_at="$2"
    
    log_message "ALERT" "æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡º: $new_tag (å…¬é–‹æ—¥æ™‚: $published_at)"
    
    if [ "$DRY_RUN" = true ]; then
        log_message "INFO" "[DRY-RUN] å®Ÿéš›ã®æ›´æ–°ã¯ã‚¹ã‚­ãƒƒãƒ—"
        return 0
    fi
    
    if [ "$ALERT_ONLY" = true ]; then
        log_message "INFO" "ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ãƒ¢ãƒ¼ãƒ‰: æ›´æ–°ã¯å®Ÿè¡Œã—ãªã„"
        return 0
    fi
    
    if [ "$AUTO_UPDATE" = true ]; then
        log_message "INFO" "è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹..."
        
        # æ›´æ–°å‰ã®ç¢ºèª
        log_message "INFO" "æ›´æ–°å‰çŠ¶æ…‹ç¢ºèª"
        CURRENT_CONTAINERS=$(ssh Cinnamon "docker ps --filter 'name=bulk-block-users' --format '{{.Names}}' | wc -l" 2>/dev/null || echo "0")
        log_message "INFO" "ç¨¼åƒä¸­ã‚³ãƒ³ãƒ†ãƒŠæ•°: $CURRENT_CONTAINERS"
        
        # docker compose downã‚’å®Ÿè¡Œ
        log_message "INFO" "docker compose downå®Ÿè¡Œ"
        if ssh Cinnamon "cd /opt/docker && docker compose down" 2>>"$LOG_FILE"; then
            log_message "INFO" "docker compose downæˆåŠŸ"
            
            # wait-for-deploymentã‚’å‘¼ã³å‡ºã—
            log_message "INFO" "ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿé–‹å§‹"
            SCRIPT_DIR="$(dirname "$(realpath "$0")")"
            
            if "$SCRIPT_DIR/wait-for-deployment" --timeout 30 2>>"$LOG_FILE"; then
                log_message "SUCCESS" "è‡ªå‹•æ›´æ–°å®Œäº†: $new_tag"
                
                # æ›´æ–°å¾Œã®ç¢ºèª
                NEW_VERSION=$(ssh Cinnamon "docker ps --filter 'name=bulk-block-users' --format '{{.Names}}' | head -1 | xargs -I {} docker exec {} python3 -m twitter_blocker --version 2>/dev/null" | sed 's/^python3 -m twitter_blocker //' || echo "Unknown")
                log_message "INFO" "æ›´æ–°å¾Œãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"
            else
                log_message "ERROR" "ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿã«å¤±æ•—"
                return 1
            fi
        else
            log_message "ERROR" "docker compose downå¤±æ•—"
            return 1
        fi
    else
        log_message "INFO" "æ‰‹å‹•æ›´æ–°ãŒå¿…è¦ã§ã™"
        log_message "INFO" "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: .claude/commands/update-containers"
    fi
}

# ãƒ¡ã‚¤ãƒ³ç›£è¦–ãƒ«ãƒ¼ãƒ—
main_monitoring_loop() {
    local start_time=$(date +%s)
    local end_time=$((start_time + MAX_DURATION))
    local check_count=0
    
    log_message "INFO" "ç›£è¦–é–‹å§‹ (é–“éš”: ${CHECK_INTERVAL}ç§’, æœ€å¤§æ™‚é–“: ${MAX_DURATION}ç§’)"
    
    # åˆæœŸçŠ¶æ…‹ã®å–å¾—
    local current_state=$(load_state)
    log_message "INFO" "å‰å›çŠ¶æ…‹: ${current_state:-"ãªã—"}"
    
    while true; do
        check_count=$((check_count + 1))
        local current_time=$(date +%s)
        
        log_message "INFO" "ãƒã‚§ãƒƒã‚¯ #$check_count å®Ÿè¡Œä¸­..."
        
        # ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
        local release_info=$(get_current_release)
        if [ $? -ne 0 ]; then
            log_message "ERROR" "ãƒªãƒªãƒ¼ã‚¹æƒ…å ±å–å¾—å¤±æ•— (ãƒã‚§ãƒƒã‚¯ #$check_count)"
            if [ "$ONE_SHOT" = true ]; then
                exit 1
            fi
            sleep "$CHECK_INTERVAL"
            continue
        fi
        
        local current_tag=$(echo "$release_info" | cut -d'|' -f1)
        local current_published=$(echo "$release_info" | cut -d'|' -f2)
        
        log_message "INFO" "ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹: $current_tag"
        
        # æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡º
        if [ -n "$current_state" ] && [ "$current_state" != "$release_info" ]; then
            local old_tag=$(echo "$current_state" | cut -d'|' -f1)
            log_message "ALERT" "æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡º: $old_tag â†’ $current_tag"
            
            execute_update_action "$current_tag" "$current_published"
            
            # çŠ¶æ…‹ã‚’æ›´æ–°
            save_state "$release_info"
        elif [ -z "$current_state" ]; then
            log_message "INFO" "åˆå›å®Ÿè¡Œ: ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹ã‚’çŠ¶æ…‹ã«ä¿å­˜"
            save_state "$release_info"
        else
            log_message "INFO" "æ–°ãƒªãƒªãƒ¼ã‚¹ãªã—: $current_tag"
        fi
        
        # One-shotãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯æ™‚é–“åˆ¶é™ãƒã‚§ãƒƒã‚¯
        if [ "$ONE_SHOT" = true ]; then
            log_message "INFO" "One-shotãƒ¢ãƒ¼ãƒ‰: ç›£è¦–çµ‚äº†"
            break
        fi
        
        if [ "$current_time" -gt "$end_time" ]; then
            log_message "INFO" "æ™‚é–“åˆ¶é™åˆ°é”: ç›£è¦–çµ‚äº†"
            break
        fi
        
        # æ¬¡ã®ãƒã‚§ãƒƒã‚¯ã¾ã§å¾…æ©Ÿ
        log_message "INFO" "æ¬¡ã®ãƒã‚§ãƒƒã‚¯ã¾ã§ ${CHECK_INTERVAL}ç§’å¾…æ©Ÿ..."
        sleep "$CHECK_INTERVAL"
    done
    
    log_message "INFO" "ç›£è¦–å®Œäº† (ç·ãƒã‚§ãƒƒã‚¯å›æ•°: $check_count)"
}

# è¨­å®šè¡¨ç¤º
echo "âš™ï¸ MONITORING CONFIGURATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š ç›£è¦–è¨­å®š:"
echo "  Repository: $GITHUB_REPO"
echo "  ãƒã‚§ãƒƒã‚¯é–“éš”: ${CHECK_INTERVAL}ç§’"
if [ "$ONE_SHOT" = false ]; then
    echo "  æœ€å¤§ç›£è¦–æ™‚é–“: ${MAX_DURATION}ç§’ ($(($MAX_DURATION / 60))åˆ†)"
else
    echo "  å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: One-shot"
fi
echo "  è‡ªå‹•æ›´æ–°: $([ "$AUTO_UPDATE" = true ] && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"
echo "  ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: $([ "$DRY_RUN" = true ] && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"
echo "  ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿: $([ "$ALERT_ONLY" = true ] && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"
echo "  çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«: $STATE_FILE"
echo "  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: $LOG_FILE"
echo ""

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
log_message "INFO" "ãƒªãƒªãƒ¼ã‚¹ç›£è¦–é–‹å§‹"

# ãƒ¡ã‚¤ãƒ³ç›£è¦–ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
main_monitoring_loop

echo
echo "ğŸ‰ MONITORING COMPLETED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š ç›£è¦–å®Œäº†ã‚µãƒãƒªãƒ¼:"
echo "  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: $LOG_FILE"
echo "  çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«: $STATE_FILE"
echo ""
echo "ğŸ”— é–¢é€£ã‚³ãƒãƒ³ãƒ‰:"
echo "  ğŸ“‹ æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ç¢ºèª: .claude/commands/check-latest-release"
echo "  ğŸ”„ æ‰‹å‹•æ›´æ–°: .claude/commands/update-containers"
echo "  ğŸ“Š çŠ¶æ…‹ç¢ºèª: .claude/commands/check-cinnamon"

log_message "INFO" "ãƒªãƒªãƒ¼ã‚¹ç›£è¦–å®Œäº†"