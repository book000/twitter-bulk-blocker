#!/bin/bash

# check-cinnamon-container-health - ã‚³ãƒ³ãƒ†ãƒŠå¥åº·çŠ¶æ…‹ã®è©³ç´°åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
# åœæ­¢ã‚³ãƒ³ãƒ†ãƒŠã®è‡ªå‹•æ¤œçŸ¥ã¨å†èµ·å‹•æ¨å¥¨

set -e

echo "ğŸ¥ CONTAINER HEALTH DETAILED ANALYSIS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ã‚³ãƒ³ãƒ†ãƒŠãƒªã‚¹ãƒˆ
containers=("book000" "ihc_amot" "book000_vrc" "authorizedkey" "tomachi_priv" "tomarabbit")
stopped_containers=()
restart_recommended=()

echo "ğŸ“Š Container Status Check:"
echo ""

for container in "${containers[@]}"; do
    container_name="bulk-block-users-${container}-1"
    
    # ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹å–å¾—
    status_info=$(ssh Cinnamon "docker ps -a --filter name=$container_name --format '{{.Status}}' | head -1" 2>/dev/null || echo "Unknown")
    
    if [[ "$status_info" == *"Up"* ]]; then
        # ç¨¼åƒæ™‚é–“å–å¾—
        uptime=$(echo "$status_info" | grep -o "Up.*" || echo "Unknown")
        echo "âœ… $container: $uptime"
        
        # æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        recent_errors=$(ssh Cinnamon "docker logs $container_name --since 10m 2>/dev/null | grep -c '403ã‚¨ãƒ©ãƒ¼.*å›æ¤œå‡º' || echo 0")
        # æ”¹è¡Œãƒ»ç©ºç™½é™¤å»
        recent_errors=$(echo "$recent_errors" | tr -d '\n\r ')
        # æ•°å€¤æ¤œè¨¼
        [[ ! "$recent_errors" =~ ^[0-9]+$ ]] && recent_errors=0
        
        if [ "$recent_errors" -gt 10 ]; then
            echo "   âš ï¸ é«˜é »åº¦ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${recent_errors}ä»¶/10åˆ†"
            restart_recommended+=("$container")
        fi
        
    elif [[ "$status_info" == *"Exited"* ]]; then
        # åœæ­¢æƒ…å ±è©³ç´°
        exit_code=$(echo "$status_info" | grep -o "Exited ([0-9]*)" | grep -o "[0-9]*" || echo "Unknown")
        stopped_time=$(echo "$status_info" | grep -o "[0-9]* .* ago" || echo "Unknown")
        
        echo "ğŸ”´ $container: åœæ­¢ä¸­ (Exit code: $exit_code)"
        echo "   åœæ­¢æ™‚åˆ»: $stopped_timeå‰"
        
        # åœæ­¢ç†ç”±ã®åˆ¤å®š
        case "$exit_code" in
            0)
                echo "   ç†ç”±: æ­£å¸¸çµ‚äº†ï¼ˆå‡¦ç†å®Œäº†ï¼‰"
                ;;
            137)
                echo "   ç†ç”±: SIGKILLï¼ˆå¼·åˆ¶çµ‚äº†ï¼‰- æ‰‹å‹•åœæ­¢ã¾ãŸã¯OOMã‚­ãƒ«"
                restart_recommended+=("$container")
                ;;
            1)
                echo "   ç†ç”±: ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼"
                restart_recommended+=("$container")
                ;;
            *)
                echo "   ç†ç”±: ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ï¼ˆã‚³ãƒ¼ãƒ‰: $exit_codeï¼‰"
                restart_recommended+=("$container")
                ;;
        esac
        
        stopped_containers+=("$container")
        
        # æœ€çµ‚ãƒ­ã‚°ç¢ºèª
        echo "   ğŸ“‹ æœ€çµ‚ãƒ­ã‚°:"
        ssh Cinnamon "docker logs $container_name --tail 3 2>&1 | sed 's/^/      /'" 2>/dev/null || echo "      ãƒ­ã‚°å–å¾—å¤±æ•—"
        
    else
        echo "â“ $container: çŠ¶æ…‹ä¸æ˜"
        echo "   è©³ç´°: $status_info"
    fi
    echo ""
done

# ã‚µãƒãƒªãƒ¼è¡¨ç¤º
echo "ğŸ“Š SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

total_containers=${#containers[@]}
running_containers=$((total_containers - ${#stopped_containers[@]}))
echo "ç¨¼åƒä¸­: $running_containers/$total_containers ã‚³ãƒ³ãƒ†ãƒŠ"

if [ ${#stopped_containers[@]} -gt 0 ]; then
    echo "åœæ­¢ä¸­: ${stopped_containers[*]}"
fi

echo ""

# æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
if [ ${#restart_recommended[@]} -gt 0 ]; then
    echo "ğŸš¨ RECOMMENDED ACTIONS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ä»¥ä¸‹ã®ã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•ã‚’æ¨å¥¨:"
    for container in "${restart_recommended[@]}"; do
        echo "  - $container"
        echo "    å†èµ·å‹•ã‚³ãƒãƒ³ãƒ‰: docker restart bulk-block-users-${container}-1"
    done
    echo ""
    echo "ä¸€æ‹¬å†èµ·å‹•: docker restart $(printf "bulk-block-users-%s-1 " "${restart_recommended[@]}")"
else
    echo "âœ… ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¥å…¨ãªçŠ¶æ…‹ã§ã™"
fi

echo ""
echo "ğŸ•’ åˆ†æå®Ÿè¡Œæ™‚é–“: $(date '+%H:%M:%S')"