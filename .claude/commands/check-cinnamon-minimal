#!/bin/bash

# check-cinnamon-minimal - 最小版Cinnamonサーバー監視
# 3-5秒実行を目標とした最小限のヘルスチェック

set -e

echo "=== CINNAMON MINIMAL CHECK ==="
echo "$(date '+%H:%M:%S') - ヘルスチェック実行中..."

# 単一SSH接続で最小限のデータ取得
RESULT=$(ssh Cinnamon "
echo -n 'Running: '
docker ps --filter 'name=bulk-block-users' --format '{{.Names}}' | wc -l | tr -d '\n'
echo -n ' | Stopped: '
docker ps -a --filter 'name=bulk-block-users' --filter 'status=exited' --format '{{.Names}}' | wc -l | tr -d '\n'
echo -n ' | Auth errors (5m): '
docker logs --since '5m' \$(docker ps -aq --filter 'name=bulk-block-users') 2>/dev/null | grep -ci '認証エラー' || echo '0'
" 2>/dev/null)

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📊 $RESULT"

# 結果判定
if echo "$RESULT" | grep -q "Stopped: [1-9]"; then
    echo "🚨 停止サービスあり - 詳細確認が必要"
elif echo "$RESULT" | grep -q "Auth errors.*: [1-9]"; then
    echo "⚠️ 認証エラー検出 - Cookie確認推奨"
else
    echo "✅ システム正常"
fi
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"