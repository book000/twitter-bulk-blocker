#!/bin/bash

# auto-update-on-release - æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡ºæ™‚ã«ä¸€å›ã ã‘docker compose downã‚’å®Ÿè¡Œ
#
# æ©Ÿèƒ½:
# - GitHub APIã§æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
# - æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã®ã¿docker compose downã‚’å®Ÿè¡Œ
# - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œã§ã¯ãªãã€ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§1å›ã ã‘å®Ÿè¡Œ
# - å®Ÿè¡Œå¾Œã¯è‡ªå‹•çš„ã«çµ‚äº†

set -e

echo "=== AUTO UPDATE ON NEW RELEASE ===" 
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo

# è¨­å®š
GITHUB_REPO="book000/twitter-bulk-blocker"
GITHUB_API_URL="https://api.github.com/repos/$GITHUB_REPO/releases/latest"
STATE_FILE="/tmp/twitter-bulk-blocker-release-monitor.state"
LOG_FILE="/tmp/twitter-bulk-blocker-auto-update.log"

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
DRY_RUN=false
FORCE_UPDATE=false
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --force)
            FORCE_UPDATE=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --dry-run       ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®downã¯å®Ÿè¡Œã—ãªã„ï¼‰"
            echo "  --force         ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å¼·åˆ¶å®Ÿè¡Œ"
            echo "  --verbose       è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º"
            echo "  --help          ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä¾‹:"
            echo "  $0              # æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡ºæ™‚ã®ã¿æ›´æ–°"
            echo "  $0 --dry-run    # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰"
            echo "  $0 --force      # å¼·åˆ¶æ›´æ–°"
            echo "  $0 --verbose    # è©³ç´°ãƒ­ã‚°ä»˜ã"
            exit 0
            ;;
        *)
            echo "âŒ ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            echo "ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º: $0 --help"
            exit 1
            ;;
    esac
done

# ãƒ­ã‚°é–¢æ•°
log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local log_entry="[$timestamp] [$level] $message"
    
    echo "$log_entry"
    echo "$log_entry" >> "$LOG_FILE"
    
    if [ "$VERBOSE" = true ] || [ "$level" = "ERROR" ] || [ "$level" = "ALERT" ]; then
        echo "$log_entry" >&2
    fi
}

# ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
get_current_release() {
    local api_response=$(timeout 30 curl -s "$GITHUB_API_URL" 2>/dev/null || echo "")
    
    if [ -z "$api_response" ] || [[ "$api_response" == *"rate limit"* ]] || [[ "$api_response" == *"Not Found"* ]]; then
        log_message "ERROR" "GitHub APIå–å¾—å¤±æ•—"
        return 1
    fi
    
    local tag_name=$(echo "$api_response" | grep '"tag_name"' | cut -d'"' -f4)
    local published_at=$(echo "$api_response" | grep '"published_at"' | cut -d'"' -f4)
    
    if [ -z "$tag_name" ]; then
        log_message "ERROR" "ãƒªãƒªãƒ¼ã‚¹æƒ…å ±è§£æå¤±æ•—"
        return 1
    fi
    
    echo "${tag_name}|${published_at}"
    return 0
}

# çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
load_state() {
    if [ -f "$STATE_FILE" ]; then
        cat "$STATE_FILE"
    else
        echo ""
    fi
}

# çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜
save_state() {
    local state="$1"
    echo "$state" > "$STATE_FILE"
    log_message "INFO" "çŠ¶æ…‹ä¿å­˜: $state"
}

echo "âš™ï¸ CONFIGURATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š è¨­å®š:"
echo "  Repository: $GITHUB_REPO"
echo "  ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: $([ "$DRY_RUN" = true ] && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"
echo "  å¼·åˆ¶æ›´æ–°: $([ "$FORCE_UPDATE" = true ] && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"
echo "  è©³ç´°ãƒ­ã‚°: $([ "$VERBOSE" = true ] && echo "æœ‰åŠ¹" || echo "ç„¡åŠ¹")"
echo "  çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«: $STATE_FILE"
echo "  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: $LOG_FILE"
echo ""

log_message "INFO" "è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯é–‹å§‹"

echo "ğŸ” RELEASE CHECK"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å‰å›ã®çŠ¶æ…‹ã‚’å–å¾—
current_state=$(load_state)
log_message "INFO" "å‰å›çŠ¶æ…‹: ${current_state:-"ãªã—"}"

# ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
echo "ğŸ“¡ GitHub APIã‹ã‚‰æœ€æ–°ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­..."
release_info=$(get_current_release)
if [ $? -ne 0 ]; then
    log_message "ERROR" "ãƒªãƒªãƒ¼ã‚¹æƒ…å ±å–å¾—å¤±æ•—"
    exit 1
fi

current_tag=$(echo "$release_info" | cut -d'|' -f1)
current_published=$(echo "$release_info" | cut -d'|' -f2)

echo "  æœ€æ–°ãƒªãƒªãƒ¼ã‚¹: $current_tag"
echo "  å…¬é–‹æ—¥æ™‚: $current_published"
log_message "INFO" "ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹: $current_tag"

# æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡ºã¾ãŸã¯ãƒ•ã‚©ãƒ¼ã‚¹å®Ÿè¡Œã®åˆ¤å®š
if [ "$FORCE_UPDATE" = true ]; then
    echo "ğŸš€ å¼·åˆ¶æ›´æ–°ãƒ¢ãƒ¼ãƒ‰: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"
    log_message "INFO" "å¼·åˆ¶æ›´æ–°ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ"
    should_update=true
elif [ -n "$current_state" ] && [ "$current_state" != "$release_info" ]; then
    old_tag=$(echo "$current_state" | cut -d'|' -f1)
    echo "ğŸ†• æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡º: $old_tag â†’ $current_tag"
    log_message "ALERT" "æ–°ãƒªãƒªãƒ¼ã‚¹æ¤œå‡º: $old_tag â†’ $current_tag"
    should_update=true
elif [ -z "$current_state" ]; then
    echo "ğŸ“‹ åˆå›å®Ÿè¡Œ: ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹ã‚’çŠ¶æ…‹ã«ä¿å­˜"
    log_message "INFO" "åˆå›å®Ÿè¡Œ: ç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹ã‚’çŠ¶æ…‹ã«ä¿å­˜"
    save_state "$release_info"
    should_update=false
else
    echo "âœ… æ–°ãƒªãƒªãƒ¼ã‚¹ãªã—: $current_tag"
    log_message "INFO" "æ–°ãƒªãƒªãƒ¼ã‚¹ãªã—: $current_tag"
    should_update=false
fi

echo ""

if [ "$should_update" = true ]; then
    echo "ğŸš€ CONTAINER UPDATE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if [ "$DRY_RUN" = true ]; then
        echo "ğŸ§ª [DRY-RUN] docker compose down ã®å®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ"
        log_message "INFO" "[DRY-RUN] å®Ÿéš›ã®æ›´æ–°ã¯ã‚¹ã‚­ãƒƒãƒ—"
    else
        echo "ğŸ”„ docker compose down ã‚’å®Ÿè¡Œä¸­..."
        log_message "INFO" "docker compose downå®Ÿè¡Œé–‹å§‹"
        
        # Cinnamonã‚µãƒ¼ãƒãƒ¼ã§docker compose downã‚’å®Ÿè¡Œ
        if ssh Cinnamon "cd /mnt/hdd/cinnamon/twitter-auto-blocking/bulk-block-users && docker compose down"; then
            echo "âœ… docker compose down å®Œäº†"
            log_message "SUCCESS" "docker compose downæˆåŠŸ: $current_tag"
            
            echo "â³ æ³¨æ„: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆpull & upï¼‰ã¯ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã—ã¾ã™"
            echo "ğŸ’¡ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ç¢ºèªã¯ä»¥ä¸‹ã§å®Ÿè¡Œï¼š"
            echo "   .claude/commands/wait-for-deployment --timeout 30"
        else
            echo "âŒ docker compose down å¤±æ•—"
            log_message "ERROR" "docker compose downå¤±æ•—"
            exit 1
        fi
    fi
    
    # çŠ¶æ…‹ã‚’æ›´æ–°
    save_state "$release_info"
    
    echo ""
    echo "ğŸ‰ æ›´æ–°å‡¦ç†å®Œäº†"
    log_message "INFO" "æ›´æ–°å‡¦ç†å®Œäº†: $current_tag"
else
    echo "ğŸ“‹ NO ACTION REQUIRED"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ - æ›´æ–°ã¯ä¸è¦"
    log_message "INFO" "æ›´æ–°ä¸è¦: æ–°ãƒªãƒªãƒ¼ã‚¹ãªã—"
fi

echo ""
echo "ğŸ”— RELATED COMMANDS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ç¢ºèª: .claude/commands/check-latest-release"
echo "ğŸ“Š çŠ¶æ…‹ç¢ºèª: .claude/commands/check-cinnamon"
echo "ğŸ• ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ: .claude/commands/wait-for-deployment"
echo "ğŸ”„ æ‰‹å‹•æ›´æ–°: .claude/commands/update-containers"

log_message "INFO" "è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯å®Œäº†"