#!/bin/bash

# check-cinnamon-rate-limit-monitor - ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆç›£è¦–ãƒ»äºˆæ¸¬åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
# å¾…æ©Ÿæ™‚é–“ã®è¿½è·¡ã¨å‡¦ç†å†é–‹æ™‚åˆ»ã®äºˆæ¸¬

set -e

echo "â° RATE LIMIT MONITORING & PREDICTION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ã‚³ãƒ³ãƒ†ãƒŠãƒªã‚¹ãƒˆ
containers=("book000" "ihc_amot" "book000_vrc" "authorizedkey" "tomachi_priv" "tomarabbit")
current_time=$(date '+%s')
current_time_readable=$(date '+%Y-%m-%d %H:%M:%S')

echo "ğŸ“Š Rate Limit Status Analysis:"
echo "Current Time: $current_time_readable"
echo ""

total_waiting=0
active_processing=0
rate_limited=0

for container in "${containers[@]}"; do
    container_name="bulk-block-users-${container}-1"
    
    # ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
    is_running=$(ssh Cinnamon "docker ps --filter name=$container_name --format '{{.Names}}' | wc -l" 2>/dev/null || echo "0")
    
    if [ "$is_running" -eq 0 ]; then
        echo "ğŸ”´ $container: åœæ­¢ä¸­"
        continue
    fi
    
    # æœ€è¿‘ã®ãƒ­ã‚°ã‹ã‚‰ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
    recent_logs=$(ssh Cinnamon "docker logs $container_name --since 10m 2>/dev/null | tail -20" || echo "")
    
    # ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆæ¤œå‡º
    rate_limit_info=$(echo "$recent_logs" | grep -E "(ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆæ¤œå‡º|Rate limit exceeded|ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»)" | tail -3)
    
    if [[ "$rate_limit_info" == *"ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆæ¤œå‡º"* ]]; then
        # å¾…æ©Ÿæ™‚é–“æŠ½å‡º
        wait_time=$(echo "$rate_limit_info" | grep "ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆæ¤œå‡º" | grep -o "[0-9.]*åˆ†é–“" | head -1)
        reset_time=$(echo "$recent_logs" | grep "ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»:" | tail -1 | sed 's/.*ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»: //')
        
        echo "â³ $container: ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå¾…æ©Ÿä¸­"
        echo "   å¾…æ©Ÿæ™‚é–“: $wait_time"
        echo "   è§£é™¤äºˆå®š: $reset_time"
        
        # è§£é™¤æ™‚åˆ»ã®è¨ˆç®—
        if [ -n "$reset_time" ]; then
            reset_timestamp=$(date -d "$reset_time" '+%s' 2>/dev/null || echo "0")
            if [ "$reset_timestamp" -gt 0 ]; then
                remaining_seconds=$((reset_timestamp - current_time))
                if [ "$remaining_seconds" -gt 0 ]; then
                    remaining_minutes=$((remaining_seconds / 60))
                    remaining_seconds_mod=$((remaining_seconds % 60))
                    echo "   æ®‹ã‚Šæ™‚é–“: ${remaining_minutes}åˆ†${remaining_seconds_mod}ç§’"
                else
                    echo "   çŠ¶æ…‹: è§£é™¤æ¸ˆã¿ï¼ˆå‡¦ç†å†é–‹å¯èƒ½ï¼‰"
                fi
            fi
        fi
        
        rate_limited=$((rate_limited + 1))
        
    elif [[ "$recent_logs" == *"Cookieæ›´æ–°å¾…æ©Ÿä¸­"* ]]; then
        echo "ğŸ”„ $container: Cookieæ›´æ–°ä¸­"
        wait_duration=$(echo "$recent_logs" | grep "Cookieæ›´æ–°å¾…æ©Ÿä¸­" | tail -1 | grep -o "çµŒé: [0-9]*ç§’" | grep -o "[0-9]*" || echo "0")
        echo "   çµŒéæ™‚é–“: ${wait_duration}ç§’"
        
        total_waiting=$((total_waiting + 1))
        
    elif [[ "$recent_logs" == *"ãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ"* ]] || [[ "$recent_logs" == *"å‡¦ç†"* ]]; then
        echo "âœ… $container: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å‡¦ç†ä¸­"
        recent_success=$(echo "$recent_logs" | grep -c "ãƒ–ãƒ­ãƒƒã‚¯æˆåŠŸ" || echo "0")
        echo "   ç›´è¿‘ã®æˆåŠŸ: ${recent_success}ä»¶"
        
        active_processing=$((active_processing + 1))
        
    else
        echo "ğŸ“Š $container: å¾…æ©ŸçŠ¶æ…‹"
        echo "   çŠ¶æ…‹: å‡¦ç†å¾…æ©Ÿä¸­"
    fi
    echo ""
done

# ã‚µãƒãƒªãƒ¼è¡¨ç¤º
echo "ğŸ“ˆ PROCESSING SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å‡¦ç†: $active_processing ã‚³ãƒ³ãƒ†ãƒŠ"
echo "Cookieæ›´æ–°ä¸­: $total_waiting ã‚³ãƒ³ãƒ†ãƒŠ"
echo "ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆ: $rate_limited ã‚³ãƒ³ãƒ†ãƒŠ"

# å‡¦ç†äºˆæ¸¬
if [ "$rate_limited" -gt 0 ]; then
    echo ""
    echo "ğŸ”® PROCESSING PREDICTION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆè§£é™¤å¾Œã€å‡¦ç†ãŒæ´»ç™ºåŒ–ã™ã‚‹è¦‹è¾¼ã¿"
    echo "Cookieæ›´æ–°å®Œäº†å¾Œã€è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠãŒåŒæ™‚å‡¦ç†é–‹å§‹äºˆå®š"
fi

# åŠ¹ç‡æ€§è©•ä¾¡
if [ "$active_processing" -gt 0 ]; then
    efficiency="é«˜åŠ¹ç‡"
elif [ "$total_waiting" -gt 2 ]; then
    efficiency="æº–å‚™ä¸­"
elif [ "$rate_limited" -gt 0 ]; then
    efficiency="å¾…æ©Ÿä¸­"
else
    efficiency="å®‰å®šç¨¼åƒ"
fi

echo ""
echo "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ åŠ¹ç‡æ€§: $efficiency"

# æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
echo ""
echo "ğŸ’¡ RECOMMENDED MONITORING"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ "$rate_limited" -gt 0 ]; then
    echo "- ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆè§£é™¤æ™‚åˆ»ã®ç›£è¦–ç¶™ç¶š"
    echo "- è§£é™¤å¾Œã®å‡¦ç†å†é–‹ç¢ºèª"
fi

if [ "$total_waiting" -gt 2 ]; then
    echo "- Cookieæ›´æ–°å®Œäº†ã®ç›£è¦–"
    echo "- åŒæœŸçš„å‡¦ç†é–‹å§‹ã®ç¢ºèª"
fi

if [ "$active_processing" -eq 0 ] && [ "$rate_limited" -eq 0 ] && [ "$total_waiting" -eq 0 ]; then
    echo "- å‡¦ç†å®Œäº†çŠ¶æ…‹ã®ç¢ºèª"
    echo "- æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œå¯èƒ½æ€§ç¢ºèª"
fi

echo ""
echo "ğŸ•’ åˆ†æå®Ÿè¡Œæ™‚é–“: $(date '+%H:%M:%S')"