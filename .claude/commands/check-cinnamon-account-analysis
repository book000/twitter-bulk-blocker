#!/bin/bash

# check-cinnamon-account-analysis - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥è©³ç´°åˆ†æãƒ»æœ€é©åŒ–ææ¡ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

set -e

BRIEF=false
RECOMMENDATIONS=true

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        --brief|-b)
            BRIEF=true
            shift
            ;;
        --no-recommendations)
            RECOMMENDATIONS=false
            shift
            ;;
        *)
            shift
            ;;
    esac
done

if [ "$BRIEF" = false ]; then
    echo "ğŸ‘¥ ACCOUNT-SPECIFIC ANALYSIS & OPTIMIZATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
fi

# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ†æãƒ‡ãƒ¼ã‚¿åé›†
analyze_account() {
    local account="$1"
    local container="bulk-block-users-${account}-1"
    
    # éå»24æ™‚é–“ã®ãƒ­ã‚°åˆ†æ
    local processed_24h=$(ssh Cinnamon "docker logs $container --since='24h' 2>&1 | grep -E '(blocked|success|completed)' | wc -l" 2>/dev/null || echo "0")
    local errors_24h=$(ssh Cinnamon "docker logs $container --since='24h' 2>&1 | grep -E '(403|error|failed)' | wc -l" 2>/dev/null || echo "0")
    local rate_limit_errors=$(ssh Cinnamon "docker logs $container --since='24h' 2>&1 | grep -i 'rate.limit' | wc -l" 2>/dev/null || echo "0")
    local auth_errors=$(ssh Cinnamon "docker logs $container --since='24h' 2>&1 | grep -E '(unauthorized|authentication|cookie)' | wc -l" 2>/dev/null || echo "0")
    local network_errors=$(ssh Cinnamon "docker logs $container --since='24h' 2>&1 | grep -E '(timeout|connection|network)' | wc -l" 2>/dev/null || echo "0")
    
    # éå»1æ™‚é–“ã®ã‚¨ãƒ©ãƒ¼é »åº¦ï¼ˆç›´è¿‘ã®çŠ¶æ…‹ï¼‰
    local recent_errors=$(ssh Cinnamon "docker logs $container --since='1h' 2>&1 | grep -E '(403|error|failed)' | wc -l" 2>/dev/null || echo "0")
    
    # æˆåŠŸç‡è¨ˆç®—
    local success_rate=0
    if [ "$processed_24h" -gt 0 ]; then
        success_rate=$(( (processed_24h - errors_24h) * 100 / processed_24h ))
    fi
    
    # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®š
    local risk_level="LOW"
    local risk_score=0
    
    # ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—
    if [ "$errors_24h" -gt 100 ]; then
        risk_score=$((risk_score + 3))
    elif [ "$errors_24h" -gt 50 ]; then
        risk_score=$((risk_score + 2))
    elif [ "$errors_24h" -gt 20 ]; then
        risk_score=$((risk_score + 1))
    fi
    
    if [ "$success_rate" -lt 70 ]; then
        risk_score=$((risk_score + 2))
    elif [ "$success_rate" -lt 85 ]; then
        risk_score=$((risk_score + 1))
    fi
    
    if [ "$recent_errors" -gt 10 ]; then
        risk_score=$((risk_score + 2))
    elif [ "$recent_errors" -gt 5 ]; then
        risk_score=$((risk_score + 1))
    fi
    
    if [ "$risk_score" -ge 5 ]; then
        risk_level="HIGH"
    elif [ "$risk_score" -ge 3 ]; then
        risk_level="MEDIUM"
    fi
    
    # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ†æ
    local primary_issue="NONE"
    if [ "$auth_errors" -gt "$rate_limit_errors" ] && [ "$auth_errors" -gt "$network_errors" ]; then
        primary_issue="AUTH"
    elif [ "$rate_limit_errors" -gt "$auth_errors" ] && [ "$rate_limit_errors" -gt "$network_errors" ]; then
        primary_issue="RATE_LIMIT"
    elif [ "$network_errors" -gt 0 ]; then
        primary_issue="NETWORK"
    elif [ "$errors_24h" -gt 0 ]; then
        primary_issue="GENERAL"
    fi
    
    # çµæœã‚’JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å‡ºåŠ›
    cat <<EOF
{
  "account": "$account",
  "container": "$container",
  "metrics": {
    "processed_24h": $processed_24h,
    "errors_24h": $errors_24h,
    "success_rate": $success_rate,
    "recent_errors_1h": $recent_errors
  },
  "error_breakdown": {
    "rate_limit": $rate_limit_errors,
    "auth": $auth_errors,
    "network": $network_errors,
    "primary_issue": "$primary_issue"
  },
  "risk_assessment": {
    "level": "$risk_level",
    "score": $risk_score
  }
}
EOF
}

# æœ€é©åŒ–ææ¡ˆç”Ÿæˆ
generate_recommendations() {
    local account_data="$1"
    local account=$(echo "$account_data" | jq -r '.account')
    local risk_level=$(echo "$account_data" | jq -r '.risk_assessment.level')
    local primary_issue=$(echo "$account_data" | jq -r '.error_breakdown.primary_issue')
    local success_rate=$(echo "$account_data" | jq -r '.metrics.success_rate')
    local errors_24h=$(echo "$account_data" | jq -r '.metrics.errors_24h')
    local recent_errors=$(echo "$account_data" | jq -r '.metrics.recent_errors_1h')
    
    local recommendations=()
    
    # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¥ã®åŸºæœ¬æ¨å¥¨äº‹é …
    case "$risk_level" in
        "HIGH")
            recommendations+=("ğŸš¨ ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ï¼šã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ã‚’æ¤œè¨")
            if [ "$primary_issue" = "AUTH" ]; then
                recommendations+=("ğŸ”‘ èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼šCookieæ›´æ–°ã‚’å®Ÿè¡Œ")
                recommendations+=("ğŸ“ èªè¨¼çŠ¶æ…‹ã®è©³ç´°ç¢ºèªï¼šãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®æ¤œè¨¼")
            elif [ "$primary_issue" = "RATE_LIMIT" ]; then
                recommendations+=("â±ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼šå‡¦ç†é–“éš”ã®èª¿æ•´ï¼ˆé…å»¶å¢—åŠ ï¼‰")
                recommendations+=("ğŸ“Š APIä½¿ç”¨é‡ã®ç›£è¦–å¼·åŒ–")
            elif [ "$primary_issue" = "NETWORK" ]; then
                recommendations+=("ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œï¼šæ¥ç¶šè¨­å®šã®ç¢ºèª")
                recommendations+=("ğŸ”„ ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ã®è¦‹ç›´ã—")
            fi
            ;;
        "MEDIUM")
            recommendations+=("âš ï¸ ç›£è¦–å¼·åŒ–ï¼šå®šæœŸçš„ãªçŠ¶æ…‹ç¢ºèª")
            if [ "$success_rate" -lt 80 ]; then
                recommendations+=("ğŸ“ˆ æˆåŠŸç‡æ”¹å–„ï¼šã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©³ç´°åˆ†æ")
            fi
            if [ "$recent_errors" -gt 5 ]; then
                recommendations+=("ğŸ” ç›´è¿‘ã‚¨ãƒ©ãƒ¼å¢—åŠ ï¼šãƒ­ã‚°ã®è©³ç´°ç¢ºèª")
            fi
            ;;
        "LOW")
            recommendations+=("âœ… è‰¯å¥½ãªçŠ¶æ…‹ï¼šç¾åœ¨ã®è¨­å®šã‚’ç¶­æŒ")
            if [ "$success_rate" -gt 95 ]; then
                recommendations+=("ğŸ¯ å„ªç§€ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼šä»–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‚è€ƒã«")
            fi
            ;;
    esac
    
    # å…·ä½“çš„ãªå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ææ¡ˆ
    if [ "$risk_level" = "HIGH" ]; then
        case "$primary_issue" in
            "AUTH")
                recommendations+=("ğŸ“‹ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ï¼šssh Cinnamon 'docker restart bulk-block-users-${account}-1'")
                ;;
            "RATE_LIMIT")
                recommendations+=("ğŸ“‹ è¨­å®šèª¿æ•´ï¼šå‡¦ç†é–“éš”ã®è¦‹ç›´ã—ãŒå¿…è¦")
                ;;
            "NETWORK")
                recommendations+=("ğŸ“‹ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ï¼šdocker logs bulk-block-users-${account}-1 --tail 100")
                ;;
        esac
    fi
    
    # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå›ºæœ‰ã®æœ€é©åŒ–ææ¡ˆ
    case "$account" in
        "book000")
            if [ "$errors_24h" -gt 20 ]; then
                recommendations+=("ğŸ‘¤ book000å›ºæœ‰ï¼šãƒ¡ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãŸã‚æ…é‡ãªå¯¾å¿œ")
            fi
            ;;
        "tomarabbit")
            if [ "$success_rate" -lt 90 ]; then
                recommendations+=("ğŸ° tomarabbitå›ºæœ‰ï¼šå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¿æ•´æ¤œè¨")
            fi
            ;;
        "authorizedkey")
            if [ "$recent_errors" -gt 3 ]; then
                recommendations+=("ğŸ” authorizedkeyå›ºæœ‰ï¼šèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª")
            fi
            ;;
    esac
    
    # æ¨å¥¨äº‹é …ã‚’JSONé…åˆ—ã¨ã—ã¦å‡ºåŠ›
    local rec_json="["
    local first=true
    for rec in "${recommendations[@]}"; do
        if [ "$first" = true ]; then
            first=false
        else
            rec_json+=","
        fi
        rec_json+="\"$rec\""
    done
    rec_json+="]"
    
    echo "$rec_json"
}

# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆ
accounts=("book000" "ihc_amot" "book000_vrc" "authorizedkey" "tomachi_priv" "tomarabbit")

# å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ†æ
for account in "${accounts[@]}"; do
    echo ""
    if [ "$BRIEF" = true ]; then
        echo "ğŸ‘¤ $account:"
    else
        echo "ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: $account"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
    
    account_data=$(analyze_account "$account")
    
    # åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
    processed=$(echo "$account_data" | jq -r '.metrics.processed_24h')
    errors=$(echo "$account_data" | jq -r '.metrics.errors_24h')
    success_rate=$(echo "$account_data" | jq -r '.metrics.success_rate')
    recent_errors=$(echo "$account_data" | jq -r '.metrics.recent_errors_1h')
    risk_level=$(echo "$account_data" | jq -r '.risk_assessment.level')
    primary_issue=$(echo "$account_data" | jq -r '.error_breakdown.primary_issue')
    
    # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºç”¨ã‚¢ã‚¤ã‚³ãƒ³
    case "$risk_level" in
        "HIGH") risk_icon="ğŸš¨" ;;
        "MEDIUM") risk_icon="âš ï¸" ;;
        "LOW") risk_icon="âœ…" ;;
    esac
    
    if [ "$BRIEF" = true ]; then
        printf "  å‡¦ç†: %dä»¶/24h, ã‚¨ãƒ©ãƒ¼: %dä»¶, æˆåŠŸç‡: %d%%, ãƒªã‚¹ã‚¯: %s %s\n" \
               "$processed" "$errors" "$success_rate" "$risk_icon" "$risk_level"
        if [ "$recent_errors" -gt 0 ]; then
            printf "  ç›´è¿‘1h: %dä»¶ã‚¨ãƒ©ãƒ¼\n" "$recent_errors"
        fi
    else
        echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ (24æ™‚é–“):"
        echo "  å‡¦ç†æ•°: ${processed}ä»¶"
        echo "  ã‚¨ãƒ©ãƒ¼æ•°: ${errors}ä»¶"
        echo "  æˆåŠŸç‡: ${success_rate}%"
        echo "  ç›´è¿‘ã‚¨ãƒ©ãƒ¼(1h): ${recent_errors}ä»¶"
        echo ""
        echo "ğŸ¯ ãƒªã‚¹ã‚¯è©•ä¾¡: ${risk_icon} ${risk_level}"
        if [ "$primary_issue" != "NONE" ]; then
            echo "ğŸ” ä¸»è¦èª²é¡Œ: $primary_issue"
        fi
    fi
    
    # æœ€é©åŒ–ææ¡ˆè¡¨ç¤º
    if [ "$RECOMMENDATIONS" = true ]; then
        recommendations=$(generate_recommendations "$account_data")
        rec_count=$(echo "$recommendations" | jq length)
        
        if [ "$rec_count" -gt 0 ]; then
            echo ""
            if [ "$BRIEF" = true ]; then
                echo "  ğŸ’¡ æ¨å¥¨äº‹é …:"
            else
                echo "ğŸ’¡ æœ€é©åŒ–ææ¡ˆ:"
            fi
            
            for ((i=0; i<rec_count; i++)); do
                rec=$(echo "$recommendations" | jq -r ".[$i]")
                if [ "$BRIEF" = true ]; then
                    echo "    â€¢ $rec"
                else
                    echo "  â€¢ $rec"
                fi
            done
        fi
    fi
done

# å…¨ä½“ã‚µãƒãƒªãƒ¼
echo ""
if [ "$BRIEF" = false ]; then
    echo "ğŸ“‹ OVERALL SUMMARY"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
fi

# é«˜ãƒªã‚¹ã‚¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚’é›†è¨ˆ
high_risk_count=0
medium_risk_count=0
low_risk_count=0

for account in "${accounts[@]}"; do
    account_data=$(analyze_account "$account")
    risk_level=$(echo "$account_data" | jq -r '.risk_assessment.level')
    
    case "$risk_level" in
        "HIGH") high_risk_count=$((high_risk_count + 1)) ;;
        "MEDIUM") medium_risk_count=$((medium_risk_count + 1)) ;;
        "LOW") low_risk_count=$((low_risk_count + 1)) ;;
    esac
done

if [ "$BRIEF" = true ]; then
    echo "ğŸ“Š ãƒªã‚¹ã‚¯åˆ†å¸ƒ: HIGH($high_risk_count) MEDIUM($medium_risk_count) LOW($low_risk_count)"
else
    echo "ğŸ“Š ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ã‚¯åˆ†å¸ƒ:"
    echo "  ğŸš¨ HIGH ãƒªã‚¹ã‚¯: ${high_risk_count}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"
    echo "  âš ï¸ MEDIUM ãƒªã‚¹ã‚¯: ${medium_risk_count}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"
    echo "  âœ… LOW ãƒªã‚¹ã‚¯: ${low_risk_count}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"
fi

# ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ãªå ´åˆã®è­¦å‘Š
if [ "$high_risk_count" -gt 0 ]; then
    echo ""
    echo "ğŸš¨ ç·Šæ€¥å¯¾å¿œæ¨å¥¨: ${high_risk_count}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§é«˜ãƒªã‚¹ã‚¯ã‚’æ¤œå‡º"
    if [ "$BRIEF" = false ]; then
        echo "  è©³ç´°ç¢ºèª: check-cinnamon-account-analysis"
        echo "  ã‚¨ãƒ©ãƒ¼åˆ†æ: check-cinnamon --errors-only"
    fi
fi