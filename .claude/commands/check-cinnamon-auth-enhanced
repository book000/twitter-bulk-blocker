#!/usr/bin/env python3
"""
Cinnamon Server Authentication Error Monitor - Enhanced Version
èªè¨¼ã‚¨ãƒ©ãƒ¼ã«ç‰¹åŒ–ã—ãŸè©³ç´°ç›£è¦–ãƒ»åˆ†æãƒ„ãƒ¼ãƒ«
"""

import subprocess
import json
import re
from datetime import datetime, timedelta
from collections import defaultdict, Counter
from typing import Dict, List, Tuple, Optional, Set
import pytz
import os
import sys

# ANSIã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
class Colors:
    RESET = '\033[0m'
    BOLD = '\033[1m'
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    MAGENTA = '\033[95m'
    CYAN = '\033[96m'
    WHITE = '\033[97m'
    GRAY = '\033[90m'
    BG_RED = '\033[101m'
    BG_YELLOW = '\033[103m'
    BG_GREEN = '\033[102m'
    BG_BLUE = '\033[104m'

class AuthenticationMonitor:
    def __init__(self):
        self.jst = pytz.timezone('Asia/Tokyo')
        self.auth_errors = defaultdict(list)
        self.cookie_reloads = defaultdict(list)
        self.retry_attempts = defaultdict(list)
        self.service_status = {}
        self.error_patterns = {
            'auth_token': r'auth_token|authorization|unauthorized|401',
            'cookie_invalid': r'cookie.*invalid|cookie.*expired|cookie.*missing',
            'csrf_token': r'csrf.*token|x-csrf-token',
            'session_expired': r'session.*expired|session.*invalid',
            'rate_limit_auth': r'rate.*limit.*auth|too.*many.*auth',
            'forbidden': r'forbidden|403.*auth|access.*denied'
        }
        
    def run_ssh_command(self, command: str) -> str:
        """SSHã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ"""
        try:
            result = subprocess.run(
                ['ssh', 'Cinnamon', command],
                capture_output=True,
                text=True,
                timeout=30
            )
            return result.stdout
        except subprocess.TimeoutExpired:
            return ""
        except Exception as e:
            print(f"{Colors.RED}SSHæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}{Colors.RESET}")
            return ""

    def analyze_auth_errors(self, hours: int = 24) -> Dict:
        """èªè¨¼ã‚¨ãƒ©ãƒ¼ã®è©³ç´°åˆ†æ"""
        print(f"{Colors.CYAN}ğŸ” èªè¨¼ã‚¨ãƒ©ãƒ¼åˆ†æä¸­ (éå»{hours}æ™‚é–“)...{Colors.RESET}")
        
        # å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’å–å¾—
        services = ['twitter-blocker-1', 'twitter-blocker-2', 'twitter-blocker-3']
        
        for service in services:
            # systemdãƒ­ã‚°ã‹ã‚‰èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’æŠ½å‡º
            command = f"sudo journalctl -u {service} --since='{hours} hours ago' --no-pager"
            logs = self.run_ssh_command(command)
            
            if logs:
                self._parse_auth_errors(logs, service)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°ã‚‚ç¢ºèª
        self._analyze_file_logs(hours)
        
        return self._generate_auth_report()
    
    def _parse_auth_errors(self, logs: str, service: str):
        """ãƒ­ã‚°ã‹ã‚‰èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’æŠ½å‡º"""
        lines = logs.split('\n')
        
        for line in lines:
            line_lower = line.lower()
            
            # å„ç¨®èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            for error_type, pattern in self.error_patterns.items():
                if re.search(pattern, line_lower):
                    timestamp = self._extract_timestamp(line)
                    self.auth_errors[service].append({
                        'time': timestamp,
                        'type': error_type,
                        'message': line.strip()
                    })
            
            # Cookieå†èª­ã¿è¾¼ã¿æ¤œå‡º
            if 'reloading cookie' in line_lower or 'cookie reload' in line_lower:
                timestamp = self._extract_timestamp(line)
                success = 'success' in line_lower or 'loaded' in line_lower
                self.cookie_reloads[service].append({
                    'time': timestamp,
                    'success': success,
                    'message': line.strip()
                })
            
            # ãƒªãƒˆãƒ©ã‚¤æ¤œå‡º
            if 'retry' in line_lower and ('auth' in line_lower or 'cookie' in line_lower):
                timestamp = self._extract_timestamp(line)
                self.retry_attempts[service].append({
                    'time': timestamp,
                    'message': line.strip()
                })
    
    def _analyze_file_logs(self, hours: int):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ­ã‚°ã‚’åˆ†æ"""
        log_files = [
            '/home/ope/logs/twitter_blocker.log',
            '/home/ope/logs/twitter_errors.log'
        ]
        
        for log_file in log_files:
            command = f"tail -n 10000 {log_file} 2>/dev/null | grep -i -E 'auth|cookie|csrf|401|403|forbidden'"
            logs = self.run_ssh_command(command)
            
            if logs:
                self._parse_auth_errors(logs, 'file_logs')
    
    def _extract_timestamp(self, line: str) -> Optional[datetime]:
        """ãƒ­ã‚°è¡Œã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ½å‡º"""
        # systemdãƒ­ã‚°å½¢å¼
        match = re.search(r'(\w{3} \d{2} \d{2}:\d{2}:\d{2})', line)
        if match:
            try:
                # ç¾åœ¨ã®å¹´ã‚’è¿½åŠ 
                year = datetime.now().year
                time_str = f"{year} {match.group(1)}"
                return datetime.strptime(time_str, "%Y %b %d %H:%M:%S")
            except:
                pass
        
        # ISOå½¢å¼
        match = re.search(r'(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2})', line)
        if match:
            try:
                return datetime.fromisoformat(match.group(1).replace(' ', 'T'))
            except:
                pass
        
        return None
    
    def _generate_auth_report(self) -> Dict:
        """èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        report = {
            'summary': {},
            'details': {},
            'recommendations': []
        }
        
        # ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
        total_errors = sum(len(errors) for errors in self.auth_errors.values())
        total_reloads = sum(len(reloads) for reloads in self.cookie_reloads.values())
        successful_reloads = sum(
            sum(1 for r in reloads if r['success']) 
            for reloads in self.cookie_reloads.values()
        )
        
        report['summary'] = {
            'total_auth_errors': total_errors,
            'total_cookie_reloads': total_reloads,
            'successful_reloads': successful_reloads,
            'reload_success_rate': (successful_reloads / total_reloads * 100) if total_reloads > 0 else 0,
            'services_affected': list(self.auth_errors.keys())
        }
        
        # è©³ç´°åˆ†æ
        for service in set(list(self.auth_errors.keys()) + list(self.cookie_reloads.keys())):
            service_report = {
                'error_count': len(self.auth_errors.get(service, [])),
                'error_types': Counter(e['type'] for e in self.auth_errors.get(service, [])),
                'reload_count': len(self.cookie_reloads.get(service, [])),
                'reload_success_rate': self._calculate_reload_success_rate(service),
                'retry_count': len(self.retry_attempts.get(service, [])),
                'last_error': self._get_last_error(service),
                'error_frequency': self._calculate_error_frequency(service)
            }
            report['details'][service] = service_report
        
        # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ
        report['recommendations'] = self._generate_recommendations(report)
        
        return report
    
    def _calculate_reload_success_rate(self, service: str) -> float:
        """Cookieå†èª­ã¿è¾¼ã¿ã®æˆåŠŸç‡ã‚’è¨ˆç®—"""
        reloads = self.cookie_reloads.get(service, [])
        if not reloads:
            return 0.0
        
        successful = sum(1 for r in reloads if r['success'])
        return (successful / len(reloads)) * 100
    
    def _get_last_error(self, service: str) -> Optional[Dict]:
        """æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—"""
        errors = self.auth_errors.get(service, [])
        if not errors:
            return None
        
        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆ
        sorted_errors = sorted(errors, key=lambda x: x['time'] or datetime.min)
        if sorted_errors:
            return sorted_errors[-1]
        return None
    
    def _calculate_error_frequency(self, service: str) -> Dict:
        """ã‚¨ãƒ©ãƒ¼é »åº¦ã‚’è¨ˆç®—"""
        errors = self.auth_errors.get(service, [])
        if not errors:
            return {'hourly_avg': 0, 'peak_hour': None, 'peak_count': 0}
        
        # æ™‚é–“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
        hourly_counts = defaultdict(int)
        for error in errors:
            if error['time']:
                hour = error['time'].replace(minute=0, second=0, microsecond=0)
                hourly_counts[hour] += 1
        
        if not hourly_counts:
            return {'hourly_avg': 0, 'peak_hour': None, 'peak_count': 0}
        
        avg_count = sum(hourly_counts.values()) / len(hourly_counts)
        peak_hour = max(hourly_counts, key=hourly_counts.get)
        peak_count = hourly_counts[peak_hour]
        
        return {
            'hourly_avg': avg_count,
            'peak_hour': peak_hour,
            'peak_count': peak_count
        }
    
    def _generate_recommendations(self, report: Dict) -> List[Dict]:
        """æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ"""
        recommendations = []
        
        # é«˜é »åº¦ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        if report['summary']['total_auth_errors'] > 50:
            recommendations.append({
                'level': 'CRITICAL',
                'action': 'Cookieå³æ™‚æ›´æ–°æ¨å¥¨',
                'reason': f"éå»24æ™‚é–“ã§{report['summary']['total_auth_errors']}ä»¶ã®èªè¨¼ã‚¨ãƒ©ãƒ¼",
                'command': 'cd ~/twitter-bulk-blocker && python3 -m twitter_blocker.update_cookies'
            })
        
        # ä½æˆåŠŸç‡ãƒã‚§ãƒƒã‚¯
        if report['summary']['reload_success_rate'] < 50 and report['summary']['total_cookie_reloads'] > 5:
            recommendations.append({
                'level': 'WARNING',
                'action': 'Cookieå“è³ªç¢ºèª',
                'reason': f"Cookieå†èª­ã¿è¾¼ã¿æˆåŠŸç‡ãŒ{report['summary']['reload_success_rate']:.1f}%ã¨ä½ã„",
                'command': 'python3 -m twitter_blocker.validate_cookies'
            })
        
        # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒã‚§ãƒƒã‚¯
        for service, details in report['details'].items():
            if details['error_count'] > 20:
                recommendations.append({
                    'level': 'WARNING',
                    'action': f'{service}ã®ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•æ¤œè¨',
                    'reason': f"{service}ã§{details['error_count']}ä»¶ã®ã‚¨ãƒ©ãƒ¼",
                    'command': f'sudo systemctl restart {service}'
                })
        
        return recommendations
    
    def display_report(self, report: Dict):
        """ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦–è¦šçš„ã«è¡¨ç¤º"""
        print(f"\n{Colors.BOLD}{Colors.CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”{Colors.RESET}")
        print(f"{Colors.BOLD}{Colors.CYAN}ğŸ” èªè¨¼ã‚¨ãƒ©ãƒ¼è©³ç´°ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ{Colors.RESET}")
        print(f"{Colors.BOLD}{Colors.CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”{Colors.RESET}")
        
        # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        summary = report['summary']
        print(f"\n{Colors.BOLD}ğŸ“Š ã‚µãƒãƒªãƒ¼{Colors.RESET}")
        
        # ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®è©•ä¾¡
        if summary['total_auth_errors'] == 0:
            status_color = Colors.GREEN
            status_icon = "âœ…"
            status_text = "æ­£å¸¸"
        elif summary['total_auth_errors'] < 10:
            status_color = Colors.YELLOW
            status_icon = "âš ï¸"
            status_text = "æ³¨æ„"
        else:
            status_color = Colors.RED
            status_icon = "ğŸš¨"
            status_text = "ç•°å¸¸"
        
        print(f"{status_icon} èªè¨¼çŠ¶æ…‹: {status_color}{status_text}{Colors.RESET}")
        print(f"   ç·èªè¨¼ã‚¨ãƒ©ãƒ¼æ•°: {summary['total_auth_errors']}ä»¶")
        print(f"   Cookieå†èª­ã¿è¾¼ã¿: {summary['total_cookie_reloads']}å›")
        print(f"   å†èª­ã¿è¾¼ã¿æˆåŠŸç‡: {summary['reload_success_rate']:.1f}%")
        print(f"   å½±éŸ¿ã‚µãƒ¼ãƒ“ã‚¹: {', '.join(summary['services_affected']) if summary['services_affected'] else 'ãªã—'}")
        
        # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è©³ç´°
        print(f"\n{Colors.BOLD}ğŸ” ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è©³ç´°{Colors.RESET}")
        for service, details in report['details'].items():
            self._display_service_details(service, details)
        
        # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        if report['recommendations']:
            print(f"\n{Colors.BOLD}ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³{Colors.RESET}")
            for rec in report['recommendations']:
                level_color = Colors.RED if rec['level'] == 'CRITICAL' else Colors.YELLOW
                print(f"\n{level_color}[{rec['level']}]{Colors.RESET} {rec['action']}")
                print(f"   ç†ç”±: {rec['reason']}")
                print(f"   å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: {Colors.CYAN}{rec['command']}{Colors.RESET}")
        
        # ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
        self._display_timeline()
    
    def _display_service_details(self, service: str, details: Dict):
        """ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è©³ç´°ã‚’è¡¨ç¤º"""
        print(f"\n{Colors.BOLD}{service}:{Colors.RESET}")
        
        # ã‚¨ãƒ©ãƒ¼æƒ…å ±
        if details['error_count'] > 0:
            print(f"  {Colors.RED}âŒ ã‚¨ãƒ©ãƒ¼: {details['error_count']}ä»¶{Colors.RESET}")
            
            # ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ†å¸ƒ
            if details['error_types']:
                print(f"     ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥:")
                for error_type, count in details['error_types'].most_common():
                    print(f"       - {error_type}: {count}ä»¶")
            
            # æœ€çµ‚ã‚¨ãƒ©ãƒ¼
            if details['last_error']:
                last_error = details['last_error']
                if last_error['time']:
                    time_str = last_error['time'].strftime("%H:%M:%S")
                    print(f"     æœ€çµ‚ã‚¨ãƒ©ãƒ¼: {time_str}")
            
            # ã‚¨ãƒ©ãƒ¼é »åº¦
            freq = details['error_frequency']
            if freq['hourly_avg'] > 0:
                print(f"     å¹³å‡é »åº¦: {freq['hourly_avg']:.1f}ä»¶/æ™‚")
                if freq['peak_hour']:
                    peak_str = freq['peak_hour'].strftime("%Hæ™‚")
                    print(f"     ãƒ”ãƒ¼ã‚¯æ™‚é–“: {peak_str} ({freq['peak_count']}ä»¶)")
        else:
            print(f"  {Colors.GREEN}âœ… ã‚¨ãƒ©ãƒ¼ãªã—{Colors.RESET}")
        
        # Cookieå†èª­ã¿è¾¼ã¿æƒ…å ±
        if details['reload_count'] > 0:
            success_rate = details['reload_success_rate']
            rate_color = Colors.GREEN if success_rate > 80 else Colors.YELLOW if success_rate > 50 else Colors.RED
            print(f"  ğŸ”„ Cookieå†èª­ã¿è¾¼ã¿: {details['reload_count']}å›")
            print(f"     æˆåŠŸç‡: {rate_color}{success_rate:.1f}%{Colors.RESET}")
        
        # ãƒªãƒˆãƒ©ã‚¤æƒ…å ±
        if details['retry_count'] > 0:
            print(f"  ğŸ” ãƒªãƒˆãƒ©ã‚¤: {details['retry_count']}å›")
    
    def _display_timeline(self):
        """ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º"""
        print(f"\n{Colors.BOLD}ğŸ“ˆ ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (ç›´è¿‘10ä»¶){Colors.RESET}")
        
        # å…¨ã‚¨ãƒ©ãƒ¼ã‚’æ™‚ç³»åˆ—ã§ãƒãƒ¼ã‚¸
        all_events = []
        
        for service, errors in self.auth_errors.items():
            for error in errors[-5:]:  # å„ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰æœ€æ–°5ä»¶
                if error['time']:
                    all_events.append({
                        'time': error['time'],
                        'service': service,
                        'type': 'error',
                        'detail': error['type']
                    })
        
        for service, reloads in self.cookie_reloads.items():
            for reload in reloads[-3:]:  # å„ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰æœ€æ–°3ä»¶
                if reload['time']:
                    all_events.append({
                        'time': reload['time'],
                        'service': service,
                        'type': 'reload',
                        'detail': 'success' if reload['success'] else 'failed'
                    })
        
        # æ™‚ç³»åˆ—ã§ã‚½ãƒ¼ãƒˆ
        all_events.sort(key=lambda x: x['time'], reverse=True)
        
        # æœ€æ–°10ä»¶ã‚’è¡¨ç¤º
        for event in all_events[:10]:
            time_str = event['time'].strftime("%H:%M:%S")
            
            if event['type'] == 'error':
                icon = "âŒ"
                color = Colors.RED
                desc = f"èªè¨¼ã‚¨ãƒ©ãƒ¼ ({event['detail']})"
            else:
                if event['detail'] == 'success':
                    icon = "âœ…"
                    color = Colors.GREEN
                    desc = "Cookieå†èª­ã¿è¾¼ã¿æˆåŠŸ"
                else:
                    icon = "âŒ"
                    color = Colors.YELLOW
                    desc = "Cookieå†èª­ã¿è¾¼ã¿å¤±æ•—"
            
            print(f"  {time_str} {icon} {color}{event['service']}{Colors.RESET}: {desc}")
    
    def monitor_realtime(self, interval: int = 60):
        """ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ¢ãƒ¼ãƒ‰"""
        print(f"{Colors.BOLD}{Colors.CYAN}ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè¨¼ç›£è¦–ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ (æ›´æ–°é–“éš”: {interval}ç§’){Colors.RESET}")
        print(f"{Colors.GRAY}Ctrl+Cã§çµ‚äº†{Colors.RESET}\n")
        
        try:
            while True:
                # ç”»é¢ã‚¯ãƒªã‚¢
                os.system('clear')
                
                # æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»åˆ†æ
                report = self.analyze_auth_errors(hours=1)  # ç›´è¿‘1æ™‚é–“
                
                # ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
                self.display_report(report)
                
                # æ¬¡å›æ›´æ–°ã¾ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
                print(f"\n{Colors.GRAY}æ¬¡å›æ›´æ–°ã¾ã§: ", end='', flush=True)
                for i in range(interval, 0, -1):
                    print(f"\r{Colors.GRAY}æ¬¡å›æ›´æ–°ã¾ã§: {i}ç§’  ", end='', flush=True)
                    time.sleep(1)
                
        except KeyboardInterrupt:
            print(f"\n\n{Colors.YELLOW}ç›£è¦–ã‚’çµ‚äº†ã—ã¾ã—ãŸ{Colors.RESET}")

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    monitor = AuthenticationMonitor()
    
    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°å‡¦ç†
    if len(sys.argv) > 1:
        if sys.argv[1] == '--realtime':
            interval = int(sys.argv[2]) if len(sys.argv) > 2 else 60
            monitor.monitor_realtime(interval)
        elif sys.argv[1] == '--hours':
            hours = int(sys.argv[2]) if len(sys.argv) > 2 else 24
            report = monitor.analyze_auth_errors(hours)
            monitor.display_report(report)
        else:
            print(f"ä½¿ç”¨æ–¹æ³•: {sys.argv[0]} [--realtime [ç§’]] [--hours [æ™‚é–“]]")
    else:
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24æ™‚é–“åˆ†æ
        report = monitor.analyze_auth_errors(24)
        monitor.display_report(report)
        
        # é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯çµ‚äº†ã‚³ãƒ¼ãƒ‰1
        if report['summary']['total_auth_errors'] > 50:
            sys.exit(1)

if __name__ == "__main__":
    import time
    main()