#!/bin/bash

# check-cinnamon-optimized - é«˜é€ŸåŒ–ç‰ˆCinnamonã‚µãƒ¼ãƒãƒ¼åŒ…æ‹¬ç›£è¦–ã‚³ãƒžãƒ³ãƒ‰
# æœ€é©åŒ–: SSHæŽ¥ç¶šã®çµ±åˆã€ä¸¦åˆ—å‡¦ç†ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹æ™‚åˆ»ã®è¨˜éŒ²
SCRIPT_START_TIME=$(date +%s)
CACHE_DIR="/tmp/.check-cinnamon-cache"
CACHE_TTL=60  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™ï¼ˆç§’ï¼‰

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$CACHE_DIR"

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "=== CINNAMON SERVER COMPREHENSIVE CHECK (OPTIMIZED) ==="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo

# çµ±åˆSSHå®Ÿè¡Œé–¢æ•°
run_ssh_batch() {
    local commands="$1"
    local cache_key="$2"
    local cache_file="$CACHE_DIR/$cache_key"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    if [ -f "$cache_file" ]; then
        local cache_age=$(($(date +%s) - $(stat -c %Y "$cache_file" 2>/dev/null || echo 0)))
        if [ $cache_age -lt $CACHE_TTL ]; then
            cat "$cache_file"
            return
        fi
    fi
    
    # SSHå®Ÿè¡Œã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    local result=$(ssh -o ControlMaster=auto -o ControlPath=/tmp/ssh-%r@%h:%p -o ControlPersist=10s Cinnamon "$commands" 2>/dev/null)
    echo "$result" > "$cache_file"
    echo "$result"
}

# 1. å…¨ãƒ‡ãƒ¼ã‚¿ã‚’1å›žã®SSHæŽ¥ç¶šã§å–å¾—
echo "ðŸ“Š ãƒ‡ãƒ¼ã‚¿åŽé›†ä¸­..."
ALL_DATA=$(run_ssh_batch "
# ã‚³ãƒ³ãƒ†ãƒŠæƒ…å ±
echo '===CONTAINER_STATUS==='
docker ps -a --filter 'name=bulk-block-users' --format 'table {{.Names}}\t{{.Status}}\t{{.State}}'
echo '===RUNNING_CONTAINERS==='
docker ps --filter 'name=bulk-block-users' --format '{{.Names}}'
echo '===STOPPED_CONTAINERS==='
docker ps -a --filter 'name=bulk-block-users' --filter 'status=exited' --format '{{.Names}}'
echo '===ERROR_CONTAINERS==='
docker ps -a --filter 'name=bulk-block-users' --filter 'exited=1' --format '{{.Names}}'
echo '===COMPLETED_CONTAINERS==='
docker ps -a --filter 'name=bulk-block-users' --filter 'exited=0' --format '{{.Names}}'

# åœæ­¢ã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°æƒ…å ±ï¼ˆJSONã§ä¸€æ‹¬å–å¾—ï¼‰
echo '===CONTAINER_DETAILS==='
docker ps -a --filter 'name=bulk-block-users' --filter 'status=exited' --format '{{.Names}}' | while read container; do
    docker inspect \$container --format '{{.Name}}|{{.State.ExitCode}}|{{.State.FinishedAt}}'
done

# ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±
echo '===PROCESS_LIST==='
ps aux | grep -E '(python3.*twitter_blocker|bulk-block|twitter|block)' | grep -v grep || true

# ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
echo '===SYSTEM_INFO==='
echo \"Load: \$(uptime | awk -F'load average:' '{print \$2}')\"
echo \"Memory: \$(free -h | grep Mem | awk '{print \"Used: \" \$3 \"/\" \$2}'')\"
echo \"Disk: \$(df -h / | tail -1 | awk '{print \"Used: \" \$3 \"/\" \$2 \" (\" \$5 \")\"}')\"

# æœ€æ–°ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰
echo '===ERROR_LOGS==='
find /var/log/supervisor -name '*.log' -mtime -1 -type f | while read log; do
    echo \"FILE:\$log\"
    grep -E '(ERROR|CRITICAL|FATAL|Traceback|Exception|èªè¨¼ã‚¨ãƒ©ãƒ¼|Cookie|ãƒ–ãƒ­ãƒƒã‚¯å¤±æ•—|KeyError|ValueError|TypeError)' \"\$log\" 2>/dev/null | tail -20 || true
done

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ
echo '===DB_STATS==='
if [ -f /home/ope/twitter-bulk-blocker/blocker_data.db ]; then
    sqlite3 /home/ope/twitter-bulk-blocker/blocker_data.db '
    SELECT \"Total Users: \" || COUNT(*) FROM users;
    SELECT \"Blocked: \" || COUNT(*) FROM users WHERE is_blocked = 1;
    SELECT \"Permanent Failures: \" || COUNT(*) FROM permanent_failures;
    SELECT \"Cache Entries: \" || COUNT(*) FROM lookup_cache;
    '
fi
" "all_data")

# ãƒ‡ãƒ¼ã‚¿è§£æžé–¢æ•°
extract_section() {
    local section="$1"
    echo "$ALL_DATA" | awk "/===$section===/{flag=1;next}/===/{flag=0}flag"
}

# 2. ã‚³ãƒ³ãƒ†ãƒŠã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
echo -e "\n${BLUE}ðŸ“Š CONTAINER STATUS ANALYSIS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

CONTAINER_STATUS=$(extract_section "CONTAINER_STATUS")
echo "$CONTAINER_STATUS"

RUNNING_CONTAINERS=$(extract_section "RUNNING_CONTAINERS")
STOPPED_CONTAINERS=$(extract_section "STOPPED_CONTAINERS")

echo -e "\n${GREEN}âœ… Running Containers:${NC}"
if [ -z "$RUNNING_CONTAINERS" ]; then
    echo "  - None"
else
    echo "$RUNNING_CONTAINERS" | sed 's/^/  - /'
fi

echo -e "\n${RED}ðŸ”´ Stopped Containers:${NC}"
if [ -z "$STOPPED_CONTAINERS" ]; then
    echo "  - None"
else
    echo "$STOPPED_CONTAINERS" | sed 's/^/  - /'
fi

# 3. ã‚¨ãƒ©ãƒ¼åˆ†æžï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰
echo -e "\n${BLUE}ðŸ” ERROR ANALYSIS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

ERROR_LOGS=$(extract_section "ERROR_LOGS")
if [ -n "$ERROR_LOGS" ]; then
    # ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±è¨ˆ
    AUTH_ERRORS=$(echo "$ERROR_LOGS" | grep -c "èªè¨¼ã‚¨ãƒ©ãƒ¼\|authentication\|Cookie" || true)
    LOCK_ERRORS=$(echo "$ERROR_LOGS" | grep -c "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯\|account.*lock\|suspended" || true)
    RATE_ERRORS=$(echo "$ERROR_LOGS" | grep -c "rate.*limit\|too many request\|429" || true)
    CODE_ERRORS=$(echo "$ERROR_LOGS" | grep -c "KeyError\|ValueError\|TypeError\|AttributeError" || true)
    
    echo -e "${YELLOW}ðŸ“Š Error Summary (éŽåŽ»24æ™‚é–“):${NC}"
    [ $AUTH_ERRORS -gt 0 ] && echo -e "  ${RED}ðŸ”‘ èªè¨¼ã‚¨ãƒ©ãƒ¼: $AUTH_ERRORS ä»¶${NC}"
    [ $LOCK_ERRORS -gt 0 ] && echo -e "  ${RED}ðŸš« ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯: $LOCK_ERRORS ä»¶${NC}"
    [ $RATE_ERRORS -gt 0 ] && echo -e "  ${YELLOW}â° ãƒ¬ãƒ¼ãƒˆåˆ¶é™: $RATE_ERRORS ä»¶${NC}"
    [ $CODE_ERRORS -gt 0 ] && echo -e "  ${RED}ðŸ› ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: $CODE_ERRORS ä»¶${NC}"
    
    # æœ€æ–°ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    echo -e "\n${YELLOW}ðŸ” æœ€æ–°ã‚¨ãƒ©ãƒ¼ (æœ€å¤§5ä»¶):${NC}"
    echo "$ERROR_LOGS" | grep -E "(ERROR|CRITICAL|FATAL|Traceback|Exception)" | tail -5 | while read line; do
        echo "  â€¢ $line"
    done
else
    echo -e "${GREEN}âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—${NC}"
fi

# 4. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
echo -e "\n${BLUE}ðŸ’» SYSTEM STATUS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

SYSTEM_INFO=$(extract_section "SYSTEM_INFO")
echo "$SYSTEM_INFO"

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ
echo -e "\n${BLUE}ðŸ“Š DATABASE STATISTICS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

DB_STATS=$(extract_section "DB_STATS")
if [ -n "$DB_STATS" ]; then
    echo "$DB_STATS"
else
    echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
fi

# 6. å•é¡Œã‚µãƒžãƒªã¨æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
echo -e "\n${BLUE}ðŸ“‹ SUMMARY & RECOMMENDATIONS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å•é¡Œã®è‡ªå‹•åˆ¤å®š
CRITICAL_ISSUES=0
WARNINGS=0

if [ -n "$STOPPED_CONTAINERS" ] && [ "$STOPPED_CONTAINERS" != "" ]; then
    echo -e "${RED}ðŸš¨ CRITICAL: åœæ­¢ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨${NC}"
    ((CRITICAL_ISSUES++))
fi

if [ $AUTH_ERRORS -gt 5 ] 2>/dev/null; then
    echo -e "${RED}ðŸš¨ CRITICAL: èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒå¤šç™º (${AUTH_ERRORS}ä»¶)${NC}"
    echo "  â†’ Cookieå†å–å¾—ãŒå¿…è¦: python3 get_twitter_cookie.py"
    ((CRITICAL_ISSUES++))
fi

if [ $CODE_ERRORS -gt 0 ] 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸ WARNING: ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ${NC}"
    echo "  â†’ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦"
    ((WARNINGS++))
fi

# æœ€çµ‚ã‚µãƒžãƒª
echo -e "\n${BLUE}ðŸ“Š è¨ºæ–­çµæžœ:${NC}"
if [ $CRITICAL_ISSUES -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}âœ… ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸${NC}"
else
    echo -e "  ${RED}â€¢ Critical Issues: $CRITICAL_ISSUES${NC}"
    echo -e "  ${YELLOW}â€¢ Warnings: $WARNINGS${NC}"
fi

# å®Ÿè¡Œæ™‚é–“ã®è¨ˆç®—
SCRIPT_END_TIME=$(date +%s)
EXECUTION_TIME=$((SCRIPT_END_TIME - SCRIPT_START_TIME))
echo -e "\nâ±ï¸ å®Ÿè¡Œæ™‚é–“: ${EXECUTION_TIME}ç§’"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼‰
find "$CACHE_DIR" -type f -mmin +5 -delete 2>/dev/null || true