# GitHub Copilot Code Agent Development Environment Setup
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ GitHub Copilot Code Agent ã®ãƒ™ãƒ¼ã‚¹é–‹ç™ºç’°å¢ƒæ§‹ç¯‰æ‰‹é †ã‚’å®šç¾©ã—ã¾ã™
# è©³ç´°: https://docs.github.com/ja/copilot/how-tos/agents/copilot-coding-agent/customizing-the-development-environment-for-copilot-coding-agent

name: "GitHub Copilot Code Agent Development Environment Setup"

"on":
  workflow_dispatch: {}  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

# ç’°å¢ƒå¤‰æ•°ã®å®šç¾©
env:
  PYTHON_VERSION: "3.13"  # renovate: datasource=python-version
  TIMEZONE: "Asia/Tokyo"
  TWITTER_COOKIES_PATH: "/app/data/cookies.json"
  TWITTER_USERS_FILE: "/app/data/users.json"
  TWITTER_BLOCK_DB: "/app/data/block_history.db"
  CACHE_DIR: "/app/data/cache"

jobs:
  copilot-setup-steps:
    name: "Development Environment Setup"
    runs-on: ubuntu-latest
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: "ğŸ“ Checkout Repository"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ç”¨ï¼‰

      # 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: "ğŸ Setup Python Environment"
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # pip ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      # 3. ã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬æƒ…å ±è¡¨ç¤º
      - name: "ğŸ“Š Display System Information"
        run: |
          echo "=== ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± ==="
          echo "OS: $(uname -a)"
          echo "Python: $(python3 --version)"
          echo "Pip: $(pip --version)"
          echo "Timezone: ${{ env.TIMEZONE }}"
          echo "Current directory: $(pwd)"
          echo "Current user: $(whoami)"

      # 4. ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®è¨­å®š
      - name: "ğŸŒ Configure Timezone"
        run: |
          sudo timedatectl set-timezone ${{ env.TIMEZONE }}
          echo "ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ ${{ env.TIMEZONE }} ã«è¨­å®šã—ã¾ã—ãŸ"
          date

      # 5. å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: "ğŸ“¦ Install System Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            sqlite3 \
            tzdata \
            curl \
            jq \
            tree
          echo "ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      # 6. Pythonã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
      - name: "â¬†ï¸ Upgrade Python Package Manager"
        run: |
          python3 -m pip install --upgrade pip==25.1.1  # renovate: datasource=pypi depName=pip
          echo "pip ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: $(pip --version)"

      # 7. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: "ğŸ“š Install Project Dependencies"
        run: |
          if [ -f "requirements.txt" ]; then
            echo "requirements.txt ã‹ã‚‰ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            pip install -r requirements.txt
            echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
            pip list
          else
            echo "âŒ requirements.txt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      # 8. é–‹ç™ºç”¨ã®è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: "ğŸ› ï¸ Install Development Tools"
        run: |
          pip install \
            black \
            flake8 \
            mypy \
            pytest \
            pytest-cov \
            ipython \
            jupyter
          echo "âœ… é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      # 9. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ
      - name: "ğŸ“ Create Project Directory Structure"
        run: |
          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆä¸­..."
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          mkdir -p /tmp/twitter-blocker-data/{cache,logs,backup}
          
          # é–‹ç™ºç”¨ã®è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          mkdir -p /tmp/twitter-blocker-dev/{test-data,debug-output}
          
          # æ¨©é™è¨­å®š
          chmod 755 /tmp/twitter-blocker-data
          chmod 755 /tmp/twitter-blocker-dev
          
          echo "âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆã—ã¾ã—ãŸ:"
          tree /tmp/twitter-blocker-data
          tree /tmp/twitter-blocker-dev

      # 10. ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      - name: "ğŸ”§ Configure Environment Variables"
        run: |
          echo "é–‹ç™ºç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šä¸­..."
          
          # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          cat > /tmp/twitter-blocker.env << EOF
          # Twitter Bulk Blocker Development Environment
          export TWITTER_COOKIES_PATH="/tmp/twitter-blocker-data/cookies.json"
          export TWITTER_USERS_FILE="/tmp/twitter-blocker-data/users.json"
          export TWITTER_BLOCK_DB="/tmp/twitter-blocker-data/block_history.db"
          export CACHE_DIR="/tmp/twitter-blocker-data/cache"
          export TZ="${{ env.TIMEZONE }}"
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          
          # ãƒ‡ãƒãƒƒã‚°ç”¨è¨­å®š
          export TWITTER_DEBUG_MODE=1
          export TWITTER_LOG_LEVEL=DEBUG
          EOF
          
          echo "âœ… ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ: /tmp/twitter-blocker.env"
          echo "ç’°å¢ƒå¤‰æ•°ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯: source /tmp/twitter-blocker.env"
          cat /tmp/twitter-blocker.env

      # 11. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ¤œè¨¼
      - name: "ğŸ§ª Validate Project Module"
        run: |
          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ¤œè¨¼ä¸­..."
          
          # Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆ
          python3 -c "import twitter_blocker; print('âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸ')"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç¢ºèª
          python3 -m twitter_blocker --version || echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ï¼ˆé–‹ç™ºç’°å¢ƒã§ã¯æ­£å¸¸ï¼‰"
          
          # ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºã®ç¢ºèª
          python3 -m twitter_blocker --help
          
          echo "âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ"

      # 12. é–‹ç™ºç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      - name: "ğŸ“ Create Development Sample Files"
        run: |
          echo "é–‹ç™ºç”¨ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
          
          # ã‚µãƒ³ãƒ—ãƒ«ã‚¯ãƒƒã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé–‹ç™ºç”¨ï¼‰
          cat > /tmp/twitter-blocker-data/cookies.sample.json << 'EOF'
          {
            "comment": "ã“ã‚Œã¯é–‹ç™ºç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚å®Ÿéš›ã®ã‚¯ãƒƒã‚­ãƒ¼æƒ…å ±ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
            "ct0": "sample_csrf_token",
            "auth_token": "sample_auth_token",
            "twid": "sample_twitter_id"
          }
          EOF
          
          # ã‚µãƒ³ãƒ—ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé–‹ç™ºç”¨ï¼‰
          cat > /tmp/twitter-blocker-data/users.sample.json << 'EOF'
          {
            "comment": "ã“ã‚Œã¯é–‹ç™ºç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å«ã¿ã¾ã™ã€‚",
            "users": [
              {"username": "test_user_1", "id": "123456789"},
              {"username": "test_user_2", "id": "987654321"}
            ]
          }
          EOF
          
          echo "âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ:"
          ls -la /tmp/twitter-blocker-data/*.sample.json

      # 13. é–‹ç™ºç’°å¢ƒã®æ¤œè¨¼
      - name: "âœ… Verify Development Environment"
        run: |
          echo "=== é–‹ç™ºç’°å¢ƒæ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ ==="
          echo "ğŸ Python: $(python3 --version)"
          echo "ğŸ“¦ Pip: $(pip --version)"
          echo "ğŸ• Timezone: $(date '+%Z %z')"
          echo "ğŸ“ Working Directory: $(pwd)"
          
          echo ""
          echo "=== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ==="
          pip list | grep -E "(requests|pytz|black|flake8|mypy|pytest)"
          
          echo ""
          echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€  ==="
          ls -la twitter_blocker/
          
          echo ""
          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la /tmp/twitter-blocker-data/
          
          echo ""
          echo "=== ç’°å¢ƒå¤‰æ•° ==="
          echo "TWITTER_COOKIES_PATH: /tmp/twitter-blocker-data/cookies.json"
          echo "TWITTER_USERS_FILE: /tmp/twitter-blocker-data/users.json"
          echo "TWITTER_BLOCK_DB: /tmp/twitter-blocker-data/block_history.db"
          echo "CACHE_DIR: /tmp/twitter-blocker-data/cache"
          
          echo ""
          echo "âœ… é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"

      # 14. é–‹ç™ºã‚¬ã‚¤ãƒ‰ã®è¡¨ç¤º
      - name: "ğŸ“– Display Development Guide"
        run: |
          echo "=== Twitter Bulk Blocker é–‹ç™ºã‚¬ã‚¤ãƒ‰ ==="
          echo ""
          echo "ğŸš€ åŸºæœ¬çš„ãªå®Ÿè¡Œæ–¹æ³•:"
          echo "  python3 -m twitter_blocker --help"
          echo "  python3 -m twitter_blocker --stats"
          echo "  python3 -m twitter_blocker --test-user <username>"
          echo ""
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:"
          echo "  pytest twitter_blocker/ -v"
          echo "  python3 -m twitter_blocker --debug"
          echo ""
          echo "ğŸ”§ é–‹ç™ºãƒ„ãƒ¼ãƒ«:"
          echo "  black twitter_blocker/  # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
          echo "  flake8 twitter_blocker/  # ãƒªãƒ³ã‚¿ãƒ¼"
          echo "  mypy twitter_blocker/   # å‹ãƒã‚§ãƒƒã‚¯"
          echo ""
          echo "ğŸ“ é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "  - twitter_blocker/__main__.py (ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ)"
          echo "  - twitter_blocker/api.py (Twitter APIç®¡ç†)"
          echo "  - twitter_blocker/database.py (SQLiteç®¡ç†)"
          echo "  - twitter_blocker/manager.py (ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡)"
          echo ""
          echo "ğŸŒ ç’°å¢ƒå¤‰æ•°è¨­å®š:"
          echo "  source /tmp/twitter-blocker.env"
          echo ""
          echo "ğŸ“– è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:"
          echo "  .github/copilot-instructions.md"
          echo "  README.md"
          echo ""
          echo "âš ï¸ æ³¨æ„äº‹é …:"
          echo "  - å®Ÿéš›ã®Twitterèªè¨¼ã«ã¯æœ¬ç‰©ã®cookies.jsonãŒå¿…è¦ã§ã™"
          echo ""
          echo "âœ¨ Happy Coding with GitHub Copilot! âœ¨"